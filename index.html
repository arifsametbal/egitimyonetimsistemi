<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EYS - EÄŸitim YÃ¶netim Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .lesson-node { transition: all 0.2s; cursor: pointer; border-left: 4px solid #334155; }
        .lesson-node:hover { transform: scale(1.02); }
        .attendance-true { border-left-color: #10b981; background: rgba(16, 185, 129, 0.1); }
        .attendance-false { border-left-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        input, select, textarea { background: #1e293b !important; color: white !important; border: 1px solid #334155 !important; border-radius: 0.5rem; padding: 0.5rem; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .branch-chip { cursor: pointer; padding: 4px 10px; border-radius: 99px; border: 1px solid #334155; font-size: 11px; transition: all 0.2s; }
        .branch-chip.active { background: #3b82f6; border-color: #3b82f6; color: white; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .media-preview { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 1px solid #334155; }
    </style>
</head>
<body class="min-h-screen pb-20 md:pb-0">

    <div id="loader" class="loading-overlay">
        <i class="fas fa-circle-notch animate-spin text-4xl text-blue-500 mb-4"></i>
        <p class="text-sm font-medium">Veriler EÅŸitleniyor...</p>
    </div>

    <!-- Ãœst Navigasyon -->
    <nav class="sticky top-0 z-50 glass-card px-4 py-3 flex justify-between items-center">
        <h1 class="text-xl font-bold bg-gradient-to-r from-blue-400 to-indigo-500 bg-clip-text text-transparent">
            <i class="fas fa-graduation-cap mr-2"></i>EYS Pro
        </h1>
        <div class="hidden md:flex space-x-6">
            <button onclick="switchTab('calendar')" class="nav-link tab-active" id="nav-calendar">Takvim</button>
            <button onclick="switchTab('students')" class="nav-link" id="nav-students">Ã–ÄŸrenciler</button>
            <button onclick="switchTab('stats')" class="nav-link" id="nav-stats">Ä°statistik</button>
            <button onclick="switchTab('accounting')" class="nav-link" id="nav-accounting">Muhasebe</button>
        </div>
        <div id="sync-status" class="text-xs text-slate-400">
            <i class="fas fa-check-circle text-green-500 mr-1"></i> BaÄŸlÄ±
        </div>
    </nav>

    <!-- Ana Ä°Ã§erik AlanÄ± -->
    <main class="container mx-auto p-4 max-w-6xl">
        <!-- TAKVÄ°M BÃ–LÃœMÃœ -->
        <section id="section-calendar" class="tab-content">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <div class="flex items-center space-x-4">
                    <button class="p-2 glass-card rounded-lg" onclick="changeWeek(-1)"><i class="fas fa-chevron-left"></i></button>
                    <h2 id="calendar-date-range" class="text-lg font-semibold uppercase tracking-tight">Hafta</h2>
                    <button class="p-2 glass-card rounded-lg" onclick="changeWeek(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="flex gap-2 w-full md:w-auto">
                    <input type="week" id="calendar-week-picker" class="text-sm" onchange="jumpToWeek(this.value)">
                    <button onclick="exportFullCalendarPDF()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm flex-1 md:flex-none">
                        <i class="fas fa-file-pdf mr-2"></i>ProgramÄ± Ä°ndir
                    </button>
                </div>
            </div>
            <div id="calendar-grid" class="grid grid-cols-1 md:grid-cols-7 gap-4"></div>
        </section>

        <!-- Ã–ÄRENCÄ°LER BÃ–LÃœMÃœ -->
        <section id="section-students" class="tab-content hidden">
            <div class="flex flex-col md:flex-row justify-between mb-6 gap-4">
                <div class="relative flex-1">
                    <i class="fas fa-search absolute left-3 top-3 text-slate-500"></i>
                    <input type="text" placeholder="Ã–ÄŸrenci adÄ± ile ara..." class="w-full pl-10" onkeyup="filterStudents(this.value)">
                </div>
                <button onclick="openStudentModal()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg">
                    <i class="fas fa-user-plus mr-2"></i>Yeni Ã–ÄŸrenci
                </button>
            </div>
            <div id="student-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            <div id="empty-student-msg" class="text-center py-20 text-slate-500 hidden">
                <i class="fas fa-users-slash text-4xl mb-4"></i>
                <p>KayÄ±tlÄ± Ã¶ÄŸrenci bulunamadÄ±.</p>
            </div>
        </section>

        <!-- Ä°STATÄ°STÄ°K BÃ–LÃœMÃœ -->
        <section id="section-stats" class="tab-content hidden">
            <div class="mb-6 flex flex-wrap gap-4 items-center">
                <select id="stats-student-select" class="w-full md:w-64" onchange="loadStudentStats(this.value)">
                    <option value="">Ã–ÄŸrenci SeÃ§iniz</option>
                </select>
                <select id="stats-branch-select" class="w-full md:w-64" onchange="initStats()">
                    <option value="ALL">TÃ¼m BranÅŸlar (Ã–ÄŸrenci OrtalamasÄ±)</option>
                </select>
                <button onclick="exportStatsPDF()" class="bg-purple-600 text-white px-4 py-2 rounded-lg w-full md:w-auto">
                    <i class="fas fa-chart-pie mr-2"></i>GeliÅŸim Raporu (PDF)
                </button>
            </div>
            
            <div id="stats-empty-state" class="text-center py-20 text-slate-500">
                <i class="fas fa-chart-line text-5xl mb-4"></i>
                <p>Ä°statistikleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in lÃ¼tfen bir Ã¶ÄŸrenci seÃ§in.</p>
            </div>

            <div id="stats-container" class="grid grid-cols-1 md:grid-cols-2 gap-6 hidden">
                <div class="glass-card p-4 rounded-xl md:col-span-2">
                    <h3 id="chart-main-title" class="font-bold mb-4 text-xs text-slate-400 uppercase tracking-widest">Test BaÅŸarÄ± GeliÅŸimi (%)</h3>
                    <div class="h-[300px]"><canvas id="chart-test-performance"></canvas></div>
                </div>
                <div class="glass-card p-4 rounded-xl">
                    <h3 class="font-bold mb-4 text-xs text-slate-400 uppercase tracking-widest">Duygu Durumu DaÄŸÄ±lÄ±mÄ±</h3>
                    <div class="h-[250px]"><canvas id="chart-mood"></canvas></div>
                </div>
                <div class="glass-card p-4 rounded-xl">
                    <h3 class="font-bold mb-4 text-xs text-slate-400 uppercase tracking-widest">BranÅŸ BazlÄ± Ortalama BaÅŸarÄ± (%)</h3>
                    <div class="h-[250px]"><canvas id="chart-subjects-success"></canvas></div>
                </div>
                <div class="glass-card p-4 rounded-xl md:col-span-2">
                    <h3 class="font-bold mb-4 text-xs text-slate-400 uppercase tracking-widest">Okuma HÄ±zÄ± & Anlama OranÄ± GeliÅŸimi</h3>
                    <div class="h-[300px]"><canvas id="chart-reading"></canvas></div>
                </div>
            </div>
        </section>

        <!-- MUHASEBE BÃ–LÃœMÃœ -->
        <section id="section-accounting" class="tab-content hidden">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-center">
                <div class="glass-card p-4 rounded-xl border-t-4 border-blue-500">
                    <p class="text-[10px] text-slate-400 uppercase">Toplam Alacak</p>
                    <h4 id="acc-total-debt" class="text-lg font-bold">â‚º0</h4>
                </div>
                <div class="glass-card p-4 rounded-xl border-t-4 border-green-500">
                    <p class="text-[10px] text-slate-400 uppercase">Toplam Tahsilat</p>
                    <h4 id="acc-total-paid" class="text-lg font-bold">â‚º0</h4>
                </div>
                <div class="glass-card p-4 rounded-xl border-t-4 border-red-500">
                    <p class="text-[10px] text-slate-400 uppercase">Toplam Gider</p>
                    <h4 id="acc-total-expense" class="text-lg font-bold">â‚º0</h4>
                </div>
                <div class="glass-card p-4 rounded-xl border-t-4 border-purple-500">
                    <p class="text-[10px] text-slate-400 uppercase">Kasa Bakiye</p>
                    <h4 id="acc-balance" class="text-lg font-bold">â‚º0</h4>
                </div>
            </div>

            <div class="flex flex-col md:flex-row justify-between mb-4 gap-4">
                <div class="flex space-x-2">
                    <button onclick="openTransactionModal('payment')" class="bg-green-600 px-4 py-2 rounded text-sm font-bold"><i class="fas fa-plus-circle mr-2"></i>Ã–deme Al</button>
                    <button onclick="openTransactionModal('expense')" class="bg-red-600 px-4 py-2 rounded text-sm font-bold"><i class="fas fa-shopping-cart mr-2"></i>Harcama Gir</button>
                </div>
                <div class="flex gap-2">
                    <input type="text" placeholder="Tabloda ara..." class="text-sm px-3" onkeyup="renderAccounting(this.value)">
                    <button onclick="exportAccountingPDF()" class="bg-slate-700 px-4 py-2 rounded text-sm"><i class="fas fa-print"></i></button>
                </div>
            </div>

            <div class="overflow-x-auto glass-card rounded-xl">
                <table class="w-full text-left text-sm">
                    <thead>
                        <tr class="bg-slate-800/50 text-[10px] uppercase text-slate-400">
                            <th class="p-4">Ã–ÄŸrenci</th>
                            <th class="p-4">Ders SayÄ±sÄ±</th>
                            <th class="p-4">Ders Borcu</th>
                            <th class="p-4">Harcamalar</th>
                            <th class="p-4">Ã–denen</th>
                            <th class="p-4">Kalan Bakiye</th>
                            <th class="p-4">Detay</th>
                        </tr>
                    </thead>
                    <tbody id="accounting-table-body"></tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- Mobil Navigasyon -->
    <div class="fixed bottom-0 left-0 right-0 md:hidden glass-card flex justify-around p-3 z-50">
        <button onclick="switchTab('calendar')" class="flex flex-col items-center text-xs text-slate-400" id="m-nav-calendar"><i class="fas fa-calendar-alt text-lg"></i><span>Takvim</span></button>
        <button onclick="switchTab('students')" class="flex flex-col items-center text-xs text-slate-400" id="m-nav-students"><i class="fas fa-users text-lg"></i><span>Ã–ÄŸrenciler</span></button>
        <button onclick="switchTab('stats')" class="flex flex-col items-center text-xs text-slate-400" id="m-nav-stats"><i class="fas fa-chart-bar text-lg"></i><span>Ä°statistik</span></button>
        <button onclick="switchTab('accounting')" class="flex flex-col items-center text-xs text-slate-400" id="m-nav-accounting"><i class="fas fa-wallet text-lg"></i><span>Muhasebe</span></button>
    </div>

    <!-- Ders ModalÄ± -->
    <div id="lesson-modal" class="fixed inset-0 bg-black/90 hidden z-[60] flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-2xl max-h-[95vh] overflow-y-auto rounded-2xl p-6 relative">
            <button onclick="closeModal('lesson-modal')" class="absolute top-4 right-4 text-slate-400"><i class="fas fa-times text-xl"></i></button>
            <h2 class="text-xl font-bold mb-6 border-b border-slate-700 pb-2">Ders AyrÄ±ntÄ±larÄ±</h2>
            <form id="lesson-form" class="space-y-6" onsubmit="saveLesson(event)">
                <input type="hidden" id="lesson-id">
                <input type="hidden" id="lesson-day">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] mb-1 text-slate-500 uppercase">Ã–ÄŸrenci</label>
                        <select id="lesson-student" class="w-full" required></select>
                    </div>
                    <div>
                        <label class="block text-[10px] mb-1 text-slate-500 uppercase">Zamanlama & KatÄ±lÄ±m</label>
                        <div class="flex gap-2">
                            <input type="time" id="lesson-time" class="flex-1" required>
                            <label class="flex items-center space-x-2 px-3 glass-card rounded cursor-pointer select-none">
                                <input type="checkbox" id="lesson-attendance" class="w-4 h-4 rounded text-blue-600">
                                <span class="text-xs">Burada</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] mb-2 text-slate-500 uppercase">BranÅŸ SeÃ§imi</label>
                    <div id="branch-container" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="bg-slate-800/40 p-4 rounded-xl border border-slate-700/50">
                    <div class="flex justify-between items-center mb-4">
                        <label class="text-[10px] text-slate-500 uppercase font-bold">Akademik Test GiriÅŸleri</label>
                        <button type="button" onclick="addTestRow()" class="text-[10px] bg-blue-500 text-white px-3 py-1 rounded-full hover:bg-blue-600">
                            <i class="fas fa-plus mr-1"></i>Test Ekle
                        </button>
                    </div>
                    <div id="test-rows-container" class="space-y-2"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] mb-1 text-slate-500 uppercase">HÄ±zlÄ± Okuma PerformansÄ±</label>
                        <div class="flex gap-2">
                            <input type="number" placeholder="Dak./Kelime" id="l-words" class="w-full">
                            <input type="number" placeholder="Anlama %" id="l-comp" class="w-full">
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] mb-2 text-slate-500 uppercase">GÃ¶zlemlenen Duygu Durumu</label>
                        <div class="flex gap-3 justify-between">
                            <label class="cursor-pointer text-3xl opacity-30 hover:opacity-100 transition-all"><input type="radio" name="mood" value="1" class="hidden peer"> <span class="peer-checked:opacity-100 peer-checked:scale-125 inline-block">ğŸ˜¡</span></label>
                            <label class="cursor-pointer text-3xl opacity-30 hover:opacity-100 transition-all"><input type="radio" name="mood" value="2" class="hidden peer"> <span class="peer-checked:opacity-100 peer-checked:scale-125 inline-block">ğŸ˜•</span></label>
                            <label class="cursor-pointer text-3xl opacity-30 hover:opacity-100 transition-all"><input type="radio" name="mood" value="3" class="hidden peer"> <span class="peer-checked:opacity-100 peer-checked:scale-125 inline-block">ğŸ˜</span></label>
                            <label class="cursor-pointer text-3xl opacity-30 hover:opacity-100 transition-all"><input type="radio" name="mood" value="4" class="hidden peer"> <span class="peer-checked:opacity-100 peer-checked:scale-125 inline-block">ğŸ™‚</span></label>
                            <label class="cursor-pointer text-3xl opacity-30 hover:opacity-100 transition-all"><input type="radio" name="mood" value="5" class="hidden peer"> <span class="peer-checked:opacity-100 peer-checked:scale-125 inline-block">ğŸ˜Š</span></label>
                        </div>
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="block text-[10px] text-slate-500 uppercase">Ders MedyasÄ± (GÃ¶rsel / Video)</label>
                    <input type="file" id="lesson-media-input" accept="image/*,video/*" multiple class="text-xs" onchange="handleLessonMedia(event)">
                    <div id="lesson-media-preview" class="flex flex-wrap gap-2 mt-2"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <textarea id="lesson-notes" placeholder="Ders NotlarÄ±..." class="w-full h-24 text-sm"></textarea>
                    <textarea id="lesson-reminders" placeholder="HatÄ±rlatmalar..." class="w-full h-24 text-sm border-dashed border-yellow-500/30"></textarea>
                </div>
                <div class="flex justify-between items-center pt-6 border-t border-slate-700">
                    <div class="flex gap-4">
                        <button type="button" onclick="exportSingleLessonPDF()" class="text-blue-400 text-sm hover:underline"><i class="fas fa-file-download mr-1"></i>PDF</button>
                        <button id="btn-lesson-delete" type="button" onclick="deleteCurrentLesson()" class="text-red-500 text-sm hover:underline hidden"><i class="fas fa-trash-alt mr-1"></i>Dersi Sil</button>
                    </div>
                    <div class="space-x-3">
                        <button type="button" onclick="closeModal('lesson-modal')" class="bg-slate-800 px-5 py-2 rounded-lg text-sm">VazgeÃ§</button>
                        <button type="submit" class="bg-blue-600 px-8 py-2 rounded-lg font-bold text-sm">Kaydet</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Muhasebe GeÃ§miÅŸi ModalÄ± -->
    <div id="acc-history-modal" class="fixed inset-0 bg-black/90 hidden z-[60] flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-2xl rounded-2xl p-6 relative max-h-[80vh] overflow-y-auto">
            <button onclick="closeModal('acc-history-modal')" class="absolute top-4 right-4 text-slate-400"><i class="fas fa-times"></i></button>
            <h2 id="acc-history-title" class="text-xl font-bold mb-6">Ä°ÅŸlem GeÃ§miÅŸi</h2>
            <div id="acc-history-list" class="space-y-3"></div>
        </div>
    </div>

    <!-- Ä°ÅŸlem GiriÅŸi ModalÄ± -->
    <div id="transaction-modal" class="fixed inset-0 bg-black/90 hidden z-[60] flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-md rounded-2xl p-6 relative">
            <button onclick="closeModal('transaction-modal')" class="absolute top-4 right-4 text-slate-400"><i class="fas fa-times"></i></button>
            <h2 id="transaction-modal-title" class="text-xl font-bold mb-6">Finansal Veri GiriÅŸi</h2>
            <form id="transaction-form" class="space-y-4" onsubmit="saveTransaction(event)">
                <input type="hidden" id="transaction-type">
                <div>
                    <label class="block text-xs mb-1 text-slate-500 uppercase">Ä°lgili Ã–ÄŸrenci</label>
                    <select id="transaction-student" class="w-full" required></select>
                </div>
                <div>
                    <label class="block text-xs mb-1 text-slate-500 uppercase">Ä°ÅŸlem TutarÄ± (â‚º)</label>
                    <input type="number" id="transaction-amount" class="w-full" required>
                </div>
                <div>
                    <label class="block text-xs mb-1 text-slate-500 uppercase">Ä°ÅŸlem AÃ§Ä±klamasÄ±</label>
                    <input type="text" id="transaction-desc" class="w-full" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 py-3 rounded-xl font-bold mt-4">Hareketi Kaydet</button>
            </form>
        </div>
    </div>

    <!-- Ã–ÄŸrenci ModalÄ± -->
    <div id="student-modal" class="fixed inset-0 bg-black/90 hidden z-[60] flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-lg rounded-2xl p-6 relative">
            <button onclick="closeModal('student-modal')" class="absolute top-4 right-4 text-slate-400"><i class="fas fa-times"></i></button>
            <h2 id="student-modal-title" class="text-xl font-bold mb-6">Ã–ÄŸrenci KaydÄ±</h2>
            <form id="student-form" class="space-y-4" onsubmit="saveStudent(event)">
                <input type="hidden" id="student-id">
                <div class="flex flex-col items-center mb-4">
                    <div id="student-photo-preview" class="w-24 h-24 rounded-full bg-slate-800 border-2 border-dashed border-slate-600 flex items-center justify-center mb-2 overflow-hidden">
                        <i class="fas fa-user text-3xl text-slate-600"></i>
                    </div>
                    <input type="file" id="student-photo-input" accept="image/*" class="text-[10px] w-48" onchange="handleStudentPhoto(event)">
                </div>
                <div>
                    <label class="block text-xs mb-1 text-slate-500 uppercase">Tam AdÄ±</label>
                    <input type="text" id="student-name" class="w-full" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs mb-1 text-slate-500 uppercase">EÄŸitim Seviyesi</label>
                        <select id="student-grade" class="w-full">
                            <option value="1">1. SÄ±nÄ±f</option><option value="2">2. SÄ±nÄ±f</option><option value="3">3. SÄ±nÄ±f</option><option value="4">4. SÄ±nÄ±f</option><option value="5">5. SÄ±nÄ±f</option><option value="6">6. SÄ±nÄ±f</option><option value="7">7. SÄ±nÄ±f</option><option value="8">8. SÄ±nÄ±f</option><option value="9">9. SÄ±nÄ±f</option><option value="10">10. SÄ±nÄ±f</option><option value="11">11. SÄ±nÄ±f</option><option value="12">12. SÄ±nÄ±f</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs mb-1 text-slate-500 uppercase">Birim Ders Ãœcreti (â‚º)</label>
                        <input type="number" id="student-price" class="w-full" required>
                    </div>
                </div>
                <div>
                    <label class="block text-xs mb-1 text-slate-500 uppercase">EÄŸitmen NotlarÄ±</label>
                    <textarea id="student-notes" class="w-full h-24"></textarea>
                </div>
                <div id="price-log-container" class="hidden bg-slate-800/50 p-3 rounded-lg">
                    <p class="text-[9px] font-bold text-slate-500 uppercase mb-2">Fiyat Revizyon GeÃ§miÅŸi</p>
                    <ul id="price-log-list" class="text-[10px] text-slate-400 space-y-1"></ul>
                </div>
                <button type="submit" class="w-full bg-green-600 py-3 rounded-xl font-bold mt-4">KayÄ±t Ä°ÅŸlemini Tamamla</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzgqFZut49ZI6TwqKPYIR9Vaa4HNpgA6InHarWwzqZ40wNucWpYst_jVjGHpcZPIeZ8/exec";
        
        let appState = {
            currentTab: 'calendar',
            students: [],
            lessons: [],
            accounting: [],
            priceLogs: [],
            currentWeekOffset: 0,
            branches: ["Matematik", "TÃ¼rkÃ§e", "Hayat Bilgisi", "Sosyal Bilgiler", "Fen Bilimleri", "Ä°ngilizce", "Bilsem", "Robotik Kodlama", "AkÄ±l ve Zeka OyunlarÄ±"],
            charts: { mood: null, subjectsSuccess: null, performance: null, reading: null }
        };

        let tempStudentPhoto = "";
        let tempLessonMedia = [];

        // --- MEDIA HANDLERS ---
        function handleStudentPhoto(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                tempStudentPhoto = e.target.result;
                document.getElementById('student-photo-preview').innerHTML = `<img src="${tempStudentPhoto}" class="w-full h-full object-cover">`;
            };
            reader.readAsDataURL(file);
        }

        function handleLessonMedia(event) {
            const files = event.target.files;
            const preview = document.getElementById('lesson-media-preview');
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = e.target.result;
                    tempLessonMedia.push({ data, type: file.type });
                    const el = document.createElement('div');
                    el.className = "relative group";
                    if (file.type.startsWith('video/')) {
                        el.innerHTML = `<video src="${data}" class="media-preview"></video><i class="fas fa-play absolute inset-0 flex items-center justify-center text-[10px] text-white"></i>`;
                    } else {
                        el.innerHTML = `<img src="${data}" class="media-preview">`;
                    }
                    preview.appendChild(el);
                };
                reader.readAsDataURL(file);
            });
        }

        // --- CORE FUNCTIONS ---
        function getWeekId() {
            const today = new Date();
            const first = new Date(today);
            const dayNum = today.getDay();
            const diff = today.getDate() - dayNum + (dayNum === 0 ? -6 : 1) + (appState.currentWeekOffset * 7);
            first.setDate(diff);
            first.setHours(0,0,0,0);
            return first.toISOString().split('T')[0];
        }

        async function fetchData() {
            if(!API_URL) return;
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                if(data && typeof data === 'object' && Object.keys(data).length > 0) {
                    appState = {...appState, ...data};
                }
                document.getElementById('loader').classList.add('hidden');
                
                const branchSelect = document.getElementById('stats-branch-select');
                if(branchSelect) {
                    branchSelect.innerHTML = '<option value="ALL">TÃ¼m BranÅŸlar (Ã–ÄŸrenci OrtalamasÄ±)</option>';
                    appState.branches.forEach(b => {
                        branchSelect.innerHTML += `<option value="${b}">${b}</option>`;
                    });
                }
                initCalendar();
            } catch(e) {
                console.error("Fetch hatasÄ±:", e);
                document.getElementById('loader').classList.add('hidden');
                initCalendar();
            }
        }

        async function saveToCloud() {
            if(!API_URL) return;
            document.getElementById('sync-status').innerHTML = '<i class="fas fa-sync-alt animate-spin text-blue-400 mr-1"></i> Kaydediliyor...';
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(appState)
                });
                document.getElementById('sync-status').innerHTML = '<i class="fas fa-check-circle text-green-500 mr-1"></i> Senkronize';
            } catch(e) {
                document.getElementById('sync-status').innerHTML = '<i class="fas fa-times-circle text-red-500 mr-1"></i> KayÄ±t HatasÄ±';
            }
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`section-${tabId}`).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('tab-active'));
            document.getElementById(`nav-${tabId}`)?.classList.add('tab-active');
            
            document.querySelectorAll('[id^="m-nav-"]').forEach(el => el.classList.replace('text-blue-400', 'text-slate-400'));
            document.getElementById(`m-nav-${tabId}`)?.classList.replace('text-slate-400', 'text-blue-400');

            if(tabId === 'stats') initStats();
            if(tabId === 'students') renderStudents();
            if(tabId === 'accounting') renderAccounting();
        }

        // --- TAKVÄ°M ---
        function initCalendar() {
            const grid = document.getElementById('calendar-grid');
            if(!grid) return;
            grid.innerHTML = '';
            const days = ['Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi', 'Pazar'];
            
            updateCalendarRange();
            days.forEach((day, index) => {
                const dayEl = document.createElement('div');
                dayEl.className = 'glass-card p-3 rounded-xl min-h-[300px] flex flex-col';
                dayEl.innerHTML = `
                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-slate-700">
                        <span class="font-bold text-xs text-blue-400 uppercase tracking-tighter">${day}</span>
                    </div>
                    <div id="day-lessons-${index}" class="flex-1 space-y-2"></div>
                    <button onclick="openLessonModal(${index})" class="mt-4 w-full py-2 border border-dashed border-slate-600 rounded-lg text-[9px] hover:bg-slate-800 text-slate-500 font-bold uppercase">
                        Yeni Ders
                    </button>
                `;
                grid.appendChild(dayEl);
            });
            renderAllLessons();
        }

        function updateCalendarRange() {
            const today = new Date();
            const first = new Date(today);
            const dayNum = today.getDay();
            const diff = today.getDate() - dayNum + (dayNum === 0 ? -6 : 1) + (appState.currentWeekOffset * 7);
            first.setDate(diff);
            const last = new Date(first); last.setDate(first.getDate() + 6);
            const opt = { day: 'numeric', month: 'long' };
            const rangeText = document.getElementById('calendar-date-range');
            if (rangeText) rangeText.innerText = `${first.toLocaleDateString('tr-TR', opt)} - ${last.toLocaleDateString('tr-TR', opt)} ${last.getFullYear()}`;
        }

        function changeWeek(off) { appState.currentWeekOffset += off; initCalendar(); }
        function jumpToWeek(v) { if(!v) return; appState.currentWeekOffset = 0; initCalendar(); }

        function renderAllLessons() {
            const currentWeekId = getWeekId();
            document.querySelectorAll('[id^="day-lessons-"]').forEach(el => el.innerHTML = '');
            appState.lessons.forEach(l => {
                if (l.weekId !== currentWeekId) return;
                const container = document.getElementById(`day-lessons-${l.day}`);
                if(container) {
                    const node = document.createElement('div');
                    node.className = `lesson-node p-2 rounded-lg text-[10px] ${l.attendance ? 'attendance-true' : 'attendance-false'}`;
                    node.onclick = () => openLessonModal(l.day, l.id);
                    node.innerHTML = `
                        <div class="font-bold truncate flex justify-between">
                            <span>${l.time}</span>
                            <span class="text-[9px] opacity-70">${getStudentName(l.studentId)}</span>
                        </div>
                        <div class="text-[9px] text-slate-400 mt-1 truncate">${(l.selectedBranches || []).join(', ')} ${ (l.media && l.media.length > 0) ? '<i class="fas fa-paperclip ml-1"></i>' : '' }</div>
                    `;
                    container.appendChild(node);
                }
            });
        }

        // --- DERS Ä°ÅLEMLERÄ° ---
        function openLessonModal(day, id = null) {
            const modal = document.getElementById('lesson-modal');
            const form = document.getElementById('lesson-form');
            form.reset();
            tempLessonMedia = [];
            document.getElementById('lesson-media-preview').innerHTML = '';
            document.getElementById('lesson-student').innerHTML = appState.students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            const bc = document.getElementById('branch-container');
            bc.innerHTML = appState.branches.map(b => `<div class="branch-chip" onclick="toggleBranchChip(this)">${b}</div>`).join('');
            document.getElementById('test-rows-container').innerHTML = '';
            document.getElementById('lesson-day').value = day;
            document.getElementById('lesson-id').value = id || "";
            const deleteBtn = document.getElementById('btn-lesson-delete');
            if(id) {
                deleteBtn.classList.remove('hidden');
                const l = appState.lessons.find(x => String(x.id) === String(id));
                if (l) {
                    document.getElementById('lesson-student').value = l.studentId;
                    document.getElementById('lesson-time').value = l.time;
                    document.getElementById('lesson-attendance').checked = l.attendance;
                    document.getElementById('l-words').value = l.words || "";
                    document.getElementById('l-comp').value = l.comprehension || "";
                    document.getElementById('lesson-notes').value = l.notes || "";
                    document.getElementById('lesson-reminders').value = l.reminders || "";
                    if(l.mood) { const r = form.querySelector(`input[name="mood"][value="${l.mood}"]`); if(r) r.checked = true; }
                    (l.selectedBranches || []).forEach(bName => {
                        const chip = [...bc.children].find(c => c.innerText === bName);
                        if(chip) chip.classList.add('active');
                    });
                    (l.tests || []).forEach(t => addTestRow(t));
                    
                    if (l.media) {
                        tempLessonMedia = [...l.media];
                        l.media.forEach(m => {
                            const el = document.createElement('div');
                            el.className = "relative group";
                            if (m.type.startsWith('video/')) {
                                el.innerHTML = `<video src="${m.data}" class="media-preview"></video><i class="fas fa-play absolute inset-0 flex items-center justify-center text-[10px] text-white"></i>`;
                            } else {
                                el.innerHTML = `<img src="${m.data}" class="media-preview">`;
                            }
                            document.getElementById('lesson-media-preview').appendChild(el);
                        });
                    }
                }
            } else { deleteBtn.classList.add('hidden'); }
            modal.classList.remove('hidden');
        }

        function toggleBranchChip(el) { el.classList.toggle('active'); }

        function addTestRow(data = null) {
            const container = document.getElementById('test-rows-container');
            const row = document.createElement('div');
            row.className = 'grid grid-cols-6 gap-2 items-center';
            row.innerHTML = `
                <select class="text-[10px] col-span-2 py-1">
                    ${appState.branches.map(b => `<option ${data?.branch === b ? 'selected' : ''}>${b}</option>`).join('')}
                </select>
                <input type="number" placeholder="S" class="text-[10px] py-1" value="${data?.q || ''}">
                <input type="number" placeholder="D" class="text-[10px] py-1" value="${data?.d || ''}">
                <input type="number" placeholder="Y" class="text-[10px] py-1" value="${data?.w || ''}">
                <input type="number" placeholder="B" class="text-[10px] py-1" value="${data?.e || ''}">
                <button type="button" onclick="this.parentElement.remove()" class="text-red-500 text-xs"><i class="fas fa-trash-alt"></i></button>
            `;
            container.appendChild(row);
        }

        function saveLesson(e) {
            e.preventDefault();
            try {
                const id = document.getElementById('lesson-id').value;
                const branches = [...document.querySelectorAll('.branch-chip.active')].map(c => c.innerText);
                const tests = [];
                Array.from(document.getElementById('test-rows-container').children).forEach(row => {
                    const inputs = row.querySelectorAll('input');
                    tests.push({
                        branch: row.querySelector('select').value,
                        q: parseInt(inputs[0].value || 0),
                        d: parseInt(inputs[1].value || 0),
                        w: parseInt(inputs[2].value || 0),
                        e: parseInt(inputs[3].value || 0)
                    });
                });
                const studentId = parseInt(document.getElementById('lesson-student').value);
                const lesson = {
                    id: id ? (isNaN(id) ? id : parseInt(id)) : Date.now(),
                    weekId: getWeekId(),
                    studentId: studentId,
                    day: parseInt(document.getElementById('lesson-day').value),
                    time: document.getElementById('lesson-time').value,
                    attendance: document.getElementById('lesson-attendance').checked,
                    selectedBranches: branches,
                    tests: tests,
                    media: tempLessonMedia,
                    words: document.getElementById('l-words').value,
                    comprehension: document.getElementById('l-comp').value,
                    mood: document.querySelector('input[name="mood"]:checked')?.value || null,
                    notes: document.getElementById('lesson-notes').value,
                    reminders: document.getElementById('lesson-reminders').value,
                    unitPrice: getStudentPrice(studentId)
                };
                if(id) {
                    const idx = appState.lessons.findIndex(x => String(x.id) === String(id));
                    if (idx !== -1) appState.lessons[idx] = lesson;
                } else { appState.lessons.push(lesson); }
                closeModal('lesson-modal');
                renderAllLessons();
                saveToCloud();
            } catch (err) { console.error("Hata:", err); }
        }

        function deleteCurrentLesson() {
            const id = document.getElementById('lesson-id').value;
            if(!id || !confirm("Bu dersi silmek istediÄŸinize emin misiniz?")) return;
            appState.lessons = appState.lessons.filter(l => String(l.id) !== String(id));
            closeModal('lesson-modal');
            renderAllLessons();
            if(appState.currentTab === 'accounting') renderAccounting();
            saveToCloud();
        }

        // --- Ä°STATÄ°STÄ°K ---
        function loadStudentStats(id) {
            const container = document.getElementById('stats-container');
            const emptyState = document.getElementById('stats-empty-state');
            if(!id) {
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }
            container.classList.remove('hidden');
            emptyState.classList.add('hidden');
            initStats();
        }

        function initStats() {
            if (appState.charts.mood) appState.charts.mood.destroy();
            if (appState.charts.subjectsSuccess) appState.charts.subjectsSuccess.destroy();
            if (appState.charts.performance) appState.charts.performance.destroy();
            if (appState.charts.reading) appState.charts.reading.destroy();
            const studentId = parseInt(document.getElementById('stats-student-select').value);
            if(!studentId) return;
            const selectedBranch = document.getElementById('stats-branch-select').value;
            const dataPool = appState.lessons.filter(l => String(l.studentId) === String(studentId));
            const moodCtx = document.getElementById('chart-mood');
            if (moodCtx) {
                const moods = [0,0,0,0,0]; dataPool.forEach(l => { if(l.mood) moods[l.mood-1]++; });
                appState.charts.mood = new Chart(moodCtx, {
                    type: 'doughnut',
                    data: { labels: ['KÃ¶tÃ¼','ZayÄ±f','Normal','Ä°yi','Harika'], datasets:[{ data: moods, backgroundColor:['#ef4444','#f97316','#eab308','#3b82f6','#22c55e'] }] },
                    options: { maintainAspectRatio:false, plugins:{ legend:{position:'bottom', labels:{color:'#94a3b8', font:{size:9}}} } }
                });
            }
            const successCtx = document.getElementById('chart-subjects-success');
            if (successCtx) {
                const branchStats = {}; 
                appState.branches.forEach(b => branchStats[b] = { total: 0, correct: 0 });
                dataPool.forEach(l => {
                    (l.tests || []).forEach(t => {
                        if (branchStats[t.branch]) {
                            branchStats[t.branch].total += t.q || 0;
                            branchStats[t.branch].correct += t.d || 0;
                        }
                    });
                });
                const labels = appState.branches;
                const data = labels.map(b => branchStats[b].total > 0 ? ((branchStats[b].correct / branchStats[b].total) * 100).toFixed(1) : 0);
                appState.charts.subjectsSuccess = new Chart(successCtx, {
                    type: 'bar',
                    data: { labels, datasets:[{ label:'Ã–ÄŸrenci BaÅŸarÄ± %', data, backgroundColor:'#3b82f6' }] },
                    options: { maintainAspectRatio:false, scales:{ y:{ min:0, max:100, ticks:{color:'#94a3b8'} }, x:{ticks:{color:'#94a3b8', font:{size:8}}} } }
                });
            }
            const perfCtx = document.getElementById('chart-test-performance');
            if (perfCtx) {
                const testHistory = [];
                dataPool.forEach(l => {
                    (l.tests || []).forEach(t => {
                        const successRate = t.q > 0 ? (t.d / t.q) * 100 : 0;
                        testHistory.push({ branch: t.branch, rate: successRate, date: l.id });
                    });
                });
                let filteredHistory = [];
                let title = "Test BaÅŸarÄ± GeliÅŸimi (%)";
                if (selectedBranch === "ALL") {
                    const grouped = {};
                    testHistory.forEach(th => {
                        if(!grouped[th.date]) grouped[th.date] = { sum: 0, count: 0 };
                        grouped[th.date].sum += th.rate;
                        grouped[th.date].count++;
                    });
                    filteredHistory = Object.keys(grouped).sort().map(key => grouped[key].sum / grouped[key].count);
                } else {
                    filteredHistory = testHistory.filter(th => th.branch === selectedBranch).map(th => th.rate);
                    title = `${selectedBranch} BaÅŸarÄ± GrafiÄŸi (%)`;
                }
                document.getElementById('chart-main-title').innerText = title;
                const labels = filteredHistory.map((_, i) => `${i+1}. Test`);
                appState.charts.performance = new Chart(perfCtx, {
                    type: 'line',
                    data: { labels, datasets:[{ label: 'BaÅŸarÄ± %', data: filteredHistory, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4 }] },
                    options: { maintainAspectRatio:false, scales: { y: { min: 0, max: 100, ticks: { color: '#94a3b8' } }, x: { ticks: { color: '#94a3b8' } } } }
                });
            }
            const readCtx = document.getElementById('chart-reading');
            if (readCtx) {
                const pool = dataPool.filter(l => l.words || l.comprehension).slice(-15);
                const labels = pool.map((_, i) => `Ders ${i+1}`);
                appState.charts.reading = new Chart(readCtx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [
                            { label: 'Kelime/Dak.', data: pool.map(l => l.words || 0), borderColor: '#a855f7', tension: 0.3, yAxisID: 'y' },
                            { label: 'Anlama %', data: pool.map(l => l.comprehension || 0), borderColor: '#22c55e', tension: 0.3, yAxisID: 'y1' }
                        ]
                    },
                    options: { maintainAspectRatio:false, scales: { y:{type:'linear', display:true, position:'left', ticks:{color:'#94a3b8'}}, y1:{type:'linear', display:true, position:'right', grid:{drawOnChartArea:false}, ticks:{color:'#22c55e'}} } }
                });
            }
        }

        // --- MUHASEBE ---
        function renderAccounting(q = "") {
            const body = document.getElementById('accounting-table-body');
            if (!body) return;
            body.innerHTML = '';
            let tD = 0, tP = 0, tE = 0;
            appState.students.filter(s => s.name.toLowerCase().includes(q.toLowerCase())).forEach(s => {
                const lessons = appState.lessons.filter(l => String(l.studentId) === String(s.id) && l.attendance);
                const lessonDebt = lessons.reduce((sum, l) => sum + (l.unitPrice || s.price), 0);
                const extraExpenses = appState.accounting.filter(a => String(a.studentId) === String(s.id) && a.type === 'expense').reduce((sum, a) => sum + a.amount, 0);
                const paid = appState.accounting.filter(a => String(a.studentId) === String(s.id) && a.type === 'payment').reduce((sum, a) => sum + a.amount, 0);
                const totalDebt = lessonDebt + extraExpenses;
                const balance = totalDebt - paid;
                tD += lessonDebt; tP += paid; tE += extraExpenses;
                const row = document.createElement('tr');
                row.className = 'border-b border-slate-800 hover:bg-slate-800/20';
                row.innerHTML = `
                    <td class="p-4 font-bold">${s.name}</td>
                    <td class="p-4">${lessons.length}</td>
                    <td class="p-4 text-blue-400">â‚º${lessonDebt}</td>
                    <td class="p-4 text-orange-400">â‚º${extraExpenses}</td>
                    <td class="p-4 text-green-500 font-bold">â‚º${paid}</td>
                    <td class="p-4 font-bold ${balance > 0 ? 'text-red-500' : 'text-blue-500'}">â‚º${balance}</td>
                    <td class="p-4 text-center">
                        <button onclick="viewHistory('${s.id}')" class="bg-slate-800 hover:bg-slate-700 p-2 rounded text-slate-400 hover:text-white">
                            <i class="fas fa-history"></i>
                        </button>
                    </td>
                `;
                body.appendChild(row);
            });
            document.getElementById('acc-total-debt').innerText = `â‚º${tD}`;
            document.getElementById('acc-total-paid').innerText = `â‚º${tP}`;
            document.getElementById('acc-total-expense').innerText = `â‚º${tE}`;
            document.getElementById('acc-balance').innerText = `â‚º${tP - tE}`;
        }

        function viewHistory(studentId) {
            const student = appState.students.find(s => String(s.id) === String(studentId));
            if (!student) return;
            const history = appState.accounting.filter(a => String(a.studentId) === String(studentId));
            const modal = document.getElementById('acc-history-modal');
            const list = document.getElementById('acc-history-list');
            document.getElementById('acc-history-title').innerText = `${student.name} - Ä°ÅŸlem GeÃ§miÅŸi`;
            list.innerHTML = history.length === 0 ? '<p class="text-center text-slate-500 py-4">Ä°ÅŸlem bulunamadÄ±.</p>' : 
            history.map(a => `
                <div class="flex justify-between items-center p-3 glass-card rounded-xl border-l-4 ${a.type === 'payment' ? 'border-green-500' : 'border-orange-500'}">
                    <div><p class="font-bold text-sm">${a.desc}</p><p class="text-[10px] text-slate-500">${a.date}</p></div>
                    <div class="text-right"><p class="font-bold ${a.type === 'payment' ? 'text-green-400' : 'text-orange-400'}">${a.type === 'payment' ? '+' : '-'} â‚º${a.amount}</p></div>
                </div>
            `).join('');
            modal.classList.remove('hidden');
        }

        function openTransactionModal(type) {
            const m = document.getElementById('transaction-modal');
            document.getElementById('transaction-type').value = type;
            document.getElementById('transaction-modal-title').innerText = type === 'payment' ? 'Ã–deme TahsilatÄ±' : 'Harcama GiriÅŸi (BorÃ§ Ekle)';
            const studentSelect = document.getElementById('transaction-student');
            studentSelect.innerHTML = appState.students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            m.classList.remove('hidden');
        }

        function saveTransaction(e) {
            e.preventDefault();
            appState.accounting.push({
                id: Date.now(),
                type: document.getElementById('transaction-type').value,
                studentId: parseInt(document.getElementById('transaction-student').value),
                amount: parseFloat(document.getElementById('transaction-amount').value),
                desc: document.getElementById('transaction-desc').value,
                date: new Date().toLocaleString('tr-TR')
            });
            closeModal('transaction-modal');
            renderAccounting();
            saveToCloud();
        }

        // --- Ã–ÄRENCÄ° YÃ–NETÄ°MÄ° ---
        function renderStudents(filter = "") {
            const list = document.getElementById('student-list');
            const empty = document.getElementById('empty-student-msg');
            if (!list) return;
            list.innerHTML = '';
            const data = appState.students.filter(s => s.name.toLowerCase().includes(filter.toLowerCase()));
            if(data.length === 0) { empty?.classList.remove('hidden'); } else { empty?.classList.add('hidden'); }
            data.forEach(s => {
                const card = document.createElement('div');
                card.className = 'glass-card p-4 rounded-xl flex flex-col justify-between border-l-4 border-blue-500';
                card.innerHTML = `
                    <div class="flex gap-3">
                        <div class="w-16 h-16 rounded-lg bg-slate-800 flex-shrink-0 overflow-hidden border border-slate-700">
                            ${s.photo ? `<img src="${s.photo}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-slate-600"><i class="fas fa-user text-xl"></i></div>`}
                        </div>
                        <div class="flex-1 overflow-hidden">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-[9px] bg-slate-800 text-slate-400 px-2 py-1 rounded uppercase font-bold">${s.grade}. SÄ±nÄ±f</span>
                                <div class="space-x-1">
                                    <button onclick="openStudentModal('${s.id}')" class="text-xs text-slate-500 hover:text-white p-1"><i class="fas fa-edit"></i></button>
                                    <button onclick="deleteStudent('${s.id}')" class="text-xs text-red-900 hover:text-red-500 p-1"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            <h3 class="font-bold text-base truncate">${s.name}</h3>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-between items-center pt-3 border-t border-slate-800">
                        <span class="font-bold text-green-500 text-sm">â‚º${s.price} <span class="text-[9px] opacity-40">/ saat</span></span>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function openStudentModal(id = null) {
            const m = document.getElementById('student-modal');
            const f = document.getElementById('student-form'); f.reset();
            tempStudentPhoto = "";
            document.getElementById('student-photo-preview').innerHTML = `<i class="fas fa-user text-3xl text-slate-600"></i>`;
            document.getElementById('student-id').value = id || "";
            document.getElementById('price-log-container').classList.add('hidden');
            if(id) {
                const s = appState.students.find(x => String(x.id) === String(id));
                if (s) {
                    document.getElementById('student-name').value = s.name;
                    document.getElementById('student-grade').value = s.grade;
                    document.getElementById('student-price').value = s.price;
                    document.getElementById('student-notes').value = s.notes || "";
                    if (s.photo) {
                        tempStudentPhoto = s.photo;
                        document.getElementById('student-photo-preview').innerHTML = `<img src="${s.photo}" class="w-full h-full object-cover">`;
                    }
                    const logs = appState.priceLogs.filter(l => String(l.studentId) === String(id));
                    if(logs.length > 0) {
                        document.getElementById('price-log-container').classList.remove('hidden');
                        document.getElementById('price-log-list').innerHTML = logs.map(l => `<li>${l.date}: â‚º${l.old} â” â‚º${l.new}</li>`).join('');
                    }
                }
            }
            m.classList.remove('hidden');
        }

        function saveStudent(e) {
            e.preventDefault();
            const id = document.getElementById('student-id').value;
            const price = parseFloat(document.getElementById('student-price').value);
            if(id) {
                const idx = appState.students.findIndex(x => String(x.id) === String(id));
                const old = appState.students[idx];
                if(old.price !== price) {
                    appState.priceLogs.push({ studentId: isNaN(id) ? id : parseInt(id), old: old.price, new: price, date: new Date().toLocaleString('tr-TR') });
                }
                appState.students[idx] = { ...old, photo: tempStudentPhoto, name: document.getElementById('student-name').value, grade: document.getElementById('student-grade').value, price, notes: document.getElementById('student-notes').value };
            } else {
                appState.students.push({ id: Date.now(), photo: tempStudentPhoto, name: document.getElementById('student-name').value, grade: document.getElementById('student-grade').value, price, notes: document.getElementById('student-notes').value });
            }
            closeModal('student-modal');
            renderStudents();
            updateStatsSelect();
            saveToCloud();
        }

        function deleteStudent(id) {
            if(!id || !confirm("Ã–ÄŸrenciyi ve tÃ¼m kayÄ±tlarÄ±nÄ± silmek istediÄŸinize emin misiniz?")) return;
            appState.students = appState.students.filter(s => String(s.id) !== String(id));
            appState.lessons = appState.lessons.filter(l => String(l.studentId) !== String(id));
            appState.accounting = appState.accounting.filter(a => String(a.studentId) !== String(id));
            renderStudents();
            updateStatsSelect();
            if(appState.currentTab === 'accounting') renderAccounting();
            saveToCloud();
        }

        // --- HELPERS ---
        function getStudentName(id) { return appState.students.find(s => String(s.id) === String(id))?.name || "Bilinmiyor"; }
        function getStudentPrice(id) { return appState.students.find(s => String(s.id) === String(id))?.price || 0; }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function filterStudents(q) { renderStudents(q); }
        function updateStatsSelect() { 
            const select = document.getElementById('stats-student-select');
            if (select) select.innerHTML = '<option value="">Ã–ÄŸrenci SeÃ§iniz</option>' + appState.students.map(s => `<option value="${s.id}">${s.name}</option>`).join(''); 
        }

        async function exportFullCalendarPDF() {
            const el = document.getElementById('calendar-grid');
            const canvas = await html2canvas(el, { backgroundColor:'#0f172a', scale:2 });
            const pdf = new jspdf.jsPDF('l', 'mm', 'a4');
            pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 10, 10, 277, 150);
            pdf.save('Haftalik_Program.pdf');
        }

        function exportSingleLessonPDF() {
            const id = document.getElementById('lesson-id').value;
            const l = appState.lessons.find(x => String(x.id) === String(id));
            if(!l) return;
            const pdf = new jspdf.jsPDF();
            pdf.setFontSize(22); pdf.text('DERS RAPORU', 105, 20, {align:'center'});
            pdf.setFontSize(10); pdf.text(`Ã–ÄŸrenci: ${getStudentName(l.studentId)}`, 20, 40);
            pdf.text('TEST SONUÃ‡LARI:', 20, 80);
            (l.tests || []).forEach((t, i) => { pdf.text(`${t.branch}: ${t.q}S - ${t.d}D`, 25, 90 + (i*7)); });
            pdf.save(`${getStudentName(l.studentId)}_Ders.pdf`);
        }

        async function exportStatsPDF() {
            const el = document.getElementById('stats-container');
            const canvas = await html2canvas(el, { backgroundColor:'#0f172a', scale:2 });
            const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
            pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 10, 20, 190, 260);
            pdf.save('Gelisim_Raporu.pdf');
        }

        async function exportAccountingPDF() {
            const el = document.getElementById('section-accounting');
            const canvas = await html2canvas(el, { backgroundColor:'#0f172a', scale:2 });
            const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
            pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 10, 10, 190, 150);
            pdf.save('Muhasebe_Raporu.pdf');
        }

        window.onload = fetchData;
    </script>
</body>
</html>
