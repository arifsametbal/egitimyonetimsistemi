<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EYS Pro - EÄŸitim YÃ¶netim Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .lesson-node { transition: all 0.2s; cursor: pointer; border-left: 4px solid #334155; }
        .lesson-node:hover { transform: scale(1.02); }
        .attendance-true { border-left-color: #10b981; background: rgba(16, 185, 129, 0.1); }
        .attendance-false { border-left-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        input, select, textarea { background: #1e293b !important; color: white !important; border: 1px solid #334155 !important; border-radius: 0.5rem; padding: 0.5rem; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .branch-chip { cursor: pointer; padding: 4px 10px; border-radius: 99px; border: 1px solid #334155; font-size: 11px; transition: all 0.2s; }
        .branch-chip.active { background: #3b82f6; border-color: #3b82f6; color: white; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .media-preview { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 1px solid #334155; }
    </style>
</head>
<body class="min-h-screen pb-20 md:pb-0">

    <div id="loader" class="loading-overlay">
        <i class="fas fa-circle-notch animate-spin text-4xl text-blue-500 mb-4"></i>
        <p class="text-sm font-medium" id="loader-text">Veriler EÅŸitleniyor...</p>
    </div>

    <!-- Ãœst Navigasyon -->
    <nav class="sticky top-0 z-50 glass-card px-4 py-3 flex justify-between items-center">
        <h1 class="text-xl font-bold bg-gradient-to-r from-blue-400 to-indigo-500 bg-clip-text text-transparent">
            <i class="fas fa-graduation-cap mr-2"></i>EYS Pro
        </h1>
        <div class="hidden md:flex space-x-6">
            <button onclick="switchTab('calendar')" class="nav-link tab-active" id="nav-calendar">Takvim</button>
            <button onclick="switchTab('students')" class="nav-link" id="nav-students">Ã–ÄŸrenciler</button>
            <button onclick="switchTab('stats')" class="nav-link" id="nav-stats">Ä°statistik</button>
            <button onclick="switchTab('accounting')" class="nav-link" id="nav-accounting">Muhasebe</button>
        </div>
        <div id="sync-status" class="text-xs text-slate-400">
            <i class="fas fa-check-circle text-green-500 mr-1"></i> HazÄ±r
        </div>
    </nav>

    <main class="container mx-auto p-4 max-w-6xl">
        <!-- TAKVÄ°M BÃ–LÃœMÃœ -->
        <section id="section-calendar" class="tab-content">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <div class="flex items-center space-x-4">
                    <button class="p-2 glass-card rounded-lg" onclick="changeWeek(-1)"><i class="fas fa-chevron-left"></i></button>
                    <h2 id="calendar-date-range" class="text-lg font-semibold uppercase tracking-tight text-center min-w-[200px]">YÃ¼kleniyor...</h2>
                    <button class="p-2 glass-card rounded-lg" onclick="changeWeek(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="flex gap-2 w-full md:w-auto">
                    <input type="week" id="calendar-week-picker" class="text-sm" onchange="jumpToWeek(this.value)">
                    <button onclick="exportFullCalendarPDF()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm flex-1 md:flex-none">
                        <i class="fas fa-file-pdf mr-2"></i>ProgramÄ± Ä°ndir
                    </button>
                </div>
            </div>
            <div id="calendar-grid" class="grid grid-cols-1 md:grid-cols-7 gap-4"></div>
        </section>

        <!-- Ã–ÄRENCÄ°LER BÃ–LÃœMÃœ -->
        <section id="section-students" class="tab-content hidden">
            <div class="flex flex-col md:flex-row justify-between mb-6 gap-4">
                <div class="relative flex-1">
                    <i class="fas fa-search absolute left-3 top-3 text-slate-500"></i>
                    <input type="text" placeholder="Ã–ÄŸrenci ara..." class="w-full pl-10" onkeyup="filterStudents(this.value)">
                </div>
                <button onclick="openStudentModal()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg">
                    <i class="fas fa-user-plus mr-2"></i>Yeni Ã–ÄŸrenci
                </button>
            </div>
            <div id="student-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            <div id="empty-student-msg" class="text-center py-20 text-slate-500 hidden">
                <i class="fas fa-users-slash text-4xl mb-4"></i>
                <p>KayÄ±tlÄ± Ã¶ÄŸrenci bulunamadÄ±.</p>
            </div>
        </section>

        <!-- Ä°STATÄ°STÄ°K BÃ–LÃœMÃœ -->
        <section id="section-stats" class="tab-content hidden">
            <div class="mb-6 flex flex-wrap gap-4 items-center text-black">
                <select id="stats-student-select" class="w-full md:w-64" onchange="loadStudentStats(this.value)">
                    <option value="">Ã–ÄŸrenci SeÃ§iniz</option>
                </select>
                <select id="stats-branch-select" class="w-full md:w-64" onchange="initStats()">
                    <option value="ALL">TÃ¼m BranÅŸlar (Genel)</option>
                </select>
                <button onclick="exportStatsPDF()" class="bg-purple-600 text-white px-4 py-2 rounded-lg w-full md:w-auto">
                    <i class="fas fa-chart-pie mr-2"></i>GeliÅŸim Raporu (PDF)
                </button>
            </div>
            <div id="stats-empty-state" class="text-center py-20 text-slate-500">
                <i class="fas fa-chart-line text-5xl mb-4"></i>
                <p>LÃ¼tfen istatistikleri gÃ¶rmek iÃ§in bir Ã¶ÄŸrenci seÃ§in.</p>
            </div>
            <div id="stats-container" class="grid grid-cols-1 md:grid-cols-2 gap-6 hidden">
                <div class="glass-card p-4 rounded-xl md:col-span-2"><h3 id="chart-main-title" class="font-bold mb-4 text-xs text-slate-400 uppercase tracking-widest">Test BaÅŸarÄ± GrafiÄŸi (%)</h3><div class="h-[300px]"><canvas id="chart-test-performance"></canvas></div></div>
                <div class="glass-card p-4 rounded-xl md:col-span-2"><h3 class="font-bold mb-4 text-xs text-slate-400 uppercase tracking-widest">BranÅŸ BazlÄ± Ders SayÄ±sÄ±</h3><div class="h-[300px]"><canvas id="chart-branch-count"></canvas></div></div>
                <div class="glass-card p-4 rounded-xl"><h3 class="font-bold mb-4 text-xs text-slate-400 uppercase tracking-widest">Duygu Durumu</h3><div class="h-[250px]"><canvas id="chart-mood"></canvas></div></div>
                <div class="glass-card p-4 rounded-xl"><h3 class="font-bold mb-4 text-xs text-slate-400 uppercase tracking-widest">BranÅŸ BaÅŸarÄ± OranlarÄ±</h3><div class="h-[250px]"><canvas id="chart-subjects-success"></canvas></div></div>
                <div class="glass-card p-4 rounded-xl md:col-span-2"><h3 class="font-bold mb-4 text-xs text-slate-400 uppercase tracking-widest">Okuma HÄ±zÄ± & Anlama</h3><div class="h-[300px]"><canvas id="chart-reading"></canvas></div></div>
            </div>
        </section>

        <!-- MUHASEBE BÃ–LÃœMÃœ -->
        <section id="section-accounting" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 text-center">
                <div class="glass-card p-4 rounded-xl border-t-4 border-blue-500"><p class="text-[10px] text-slate-400 uppercase">Toplam Ders Borcu</p><h4 id="acc-total-debt" class="text-lg font-bold">â‚º0</h4></div>
                <div class="glass-card p-4 rounded-xl border-t-4 border-orange-500"><p class="text-[10px] text-slate-400 uppercase">Toplam Harcama</p><h4 id="acc-total-expense" class="text-lg font-bold">â‚º0</h4></div>
                <div class="glass-card p-4 rounded-xl border-t-4 border-green-500"><p class="text-[10px] text-slate-400 uppercase">Toplam Tahsilat</p><h4 id="acc-total-paid" class="text-lg font-bold">â‚º0</h4></div>
                <div class="glass-card p-4 rounded-xl border-t-4 border-purple-500"><p class="text-[10px] text-slate-400 uppercase">Net Bakiye</p><h4 id="acc-balance" class="text-lg font-bold">â‚º0</h4></div>
            </div>
            <div class="flex flex-col md:flex-row justify-between mb-4 gap-4">
                <div class="flex space-x-2"><button onclick="openTransactionModal('payment')" class="bg-green-600 px-4 py-2 rounded text-sm font-bold">Ã–deme Al</button><button onclick="openTransactionModal('expense')" class="bg-red-600 px-4 py-2 rounded text-sm font-bold">Harcama Gir</button></div>
                <input type="text" placeholder="Muhasebe ara..." class="text-sm px-3" onkeyup="renderAccounting(this.value)">
            </div>
            <div class="overflow-x-auto glass-card rounded-xl">
                <table class="w-full text-left text-sm">
                    <thead><tr class="bg-slate-800/50 text-[10px] uppercase text-slate-400"><th class="p-4">Ã–ÄŸrenci</th><th class="p-4 text-center">Ders</th><th class="p-4">Ders Borcu</th><th class="p-4">Harcamalar</th><th class="p-4">Ã–denen</th><th class="p-4 font-bold text-white">Bakiye</th><th class="p-4 text-center">Ä°ÅŸlem</th></tr></thead>
                    <tbody id="accounting-table-body"></tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- MODALLAR -->
    <div id="lesson-modal" class="fixed inset-0 bg-black/90 hidden z-[60] flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-2xl max-h-[95vh] overflow-y-auto rounded-2xl p-6 relative">
            <button onclick="closeModal('lesson-modal')" class="absolute top-4 right-4 text-slate-400"><i class="fas fa-times"></i></button>
            <h2 class="text-xl font-bold mb-6 border-b border-slate-700 pb-2">Ders AyrÄ±ntÄ±larÄ±</h2>
            <form id="lesson-form" class="space-y-6" onsubmit="saveLesson(event)">
                <input type="hidden" id="lesson-id"><input type="hidden" id="lesson-day">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-[10px] text-slate-500 uppercase">Ã–ÄŸrenci</label><select id="lesson-student" class="w-full" required></select></div>
                    <div><label class="block text-[10px] text-slate-500 uppercase">Zaman & KatÄ±lÄ±m</label><div class="flex gap-2"><input type="time" id="lesson-time" class="flex-1" required><label class="flex items-center space-x-2 px-3 glass-card rounded cursor-pointer"><input type="checkbox" id="lesson-attendance" class="w-4 h-4"><span class="text-xs">Burada</span></label></div></div>
                </div>
                <div><label class="block text-[10px] text-slate-500 uppercase mb-2">BranÅŸ</label><div id="branch-container" class="flex flex-wrap gap-2"></div></div>
                <div class="bg-slate-800/40 p-4 rounded-xl"><div class="flex justify-between items-center mb-4"><label class="text-[10px] text-slate-500 uppercase font-bold">Testler</label><button type="button" onclick="addTestRow()" class="text-[10px] bg-blue-600 text-white px-3 py-1 rounded-full">+ Ekle</button></div><div id="test-rows-container" class="space-y-2"></div></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-[10px] text-slate-500 uppercase">Okuma</label><div class="flex gap-2"><input type="number" placeholder="Kelime" id="l-words" class="w-full"><input type="number" placeholder="%" id="l-comp" class="w-full"></div></div>
                    <div><label class="block text-[10px] text-slate-500 uppercase">Duygu</label><div class="flex gap-3 justify-between"><label class="cursor-pointer text-2xl"><input type="radio" name="mood" value="1" class="hidden peer"><span class="peer-checked:scale-125 inline-block">ğŸ˜¡</span></label><label class="cursor-pointer text-2xl"><input type="radio" name="mood" value="3" class="hidden peer"><span class="peer-checked:scale-125 inline-block">ğŸ˜</span></label><label class="cursor-pointer text-2xl"><input type="radio" name="mood" value="5" class="hidden peer"><span class="peer-checked:scale-125 inline-block">ğŸ˜Š</span></label></div></div>
                </div>
                <div class="space-y-2"><label class="block text-[10px] text-slate-500 uppercase">Medya</label><input type="file" id="lesson-media-input" accept="image/*,video/*" multiple class="text-xs" onchange="handleLessonMedia(event)"><div id="lesson-media-preview" class="flex flex-wrap gap-2 mt-2"></div></div>
                <textarea id="lesson-notes" placeholder="Notlar..." class="w-full h-20 text-sm"></textarea>
                <div class="flex justify-between items-center pt-4 border-t border-slate-700">
                    <div class="flex gap-4"><button type="button" onclick="exportSingleLessonPDF()" class="text-blue-400 text-sm">PDF</button><button id="btn-lesson-delete" type="button" onclick="deleteCurrentLesson()" class="text-red-500 text-sm hidden">Sil</button></div>
                    <div class="space-x-3"><button type="button" onclick="closeModal('lesson-modal')" class="bg-slate-800 px-5 py-2 rounded-lg text-sm">VazgeÃ§</button><button type="submit" class="bg-blue-600 px-8 py-2 rounded-lg font-bold text-sm">Kaydet</button></div>
                </div>
            </form>
        </div>
    </div>

    <!-- Student Modal -->
    <div id="student-modal" class="fixed inset-0 bg-black/90 hidden z-[60] flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-lg rounded-2xl p-6 relative overflow-y-auto max-h-[90vh]">
            <button onclick="closeModal('student-modal')" class="absolute top-4 right-4 text-slate-400"><i class="fas fa-times"></i></button>
            <h2 id="student-modal-title" class="text-xl font-bold mb-6">Ã–ÄŸrenci KaydÄ±</h2>
            <form id="student-form" class="space-y-4" onsubmit="saveStudent(event)">
                <input type="hidden" id="student-id">
                <div class="flex flex-col items-center mb-4"><div id="student-photo-preview" class="w-24 h-24 rounded-full bg-slate-800 border-2 border-dashed border-slate-600 flex items-center justify-center overflow-hidden"><i class="fas fa-user text-3xl text-slate-600"></i></div><input type="file" id="student-photo-input" accept="image/*" class="text-[10px] w-48 mt-2" onchange="handleStudentPhoto(event)"></div>
                <input type="text" id="student-name" placeholder="Ad Soyad" class="w-full" required>
                <div class="grid grid-cols-2 gap-4"><select id="student-grade" class="w-full"><option value="1">1. SÄ±nÄ±f</option><option value="8">8. SÄ±nÄ±f</option><option value="12">12. SÄ±nÄ±f</option></select><input type="number" id="student-price" placeholder="Ãœcret" class="w-full" required></div>
                <textarea id="student-notes" placeholder="Notlar" class="w-full h-20"></textarea>
                <div id="price-log-container" class="hidden text-xs bg-slate-800 p-2 rounded"><p class="font-bold">GeÃ§miÅŸ:</p><ul id="price-log-list"></ul></div>
                <button type="submit" class="w-full bg-green-600 py-3 rounded-xl font-bold">Kaydet</button>
            </form>
        </div>
    </div>

    <div id="acc-history-modal" class="fixed inset-0 bg-black/90 hidden z-[60] flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-2xl rounded-2xl p-6 relative max-h-[80vh] overflow-hidden flex flex-col">
            <button onclick="closeModal('acc-history-modal')" class="absolute top-4 right-4 text-slate-400"><i class="fas fa-times"></i></button>
            <h2 id="acc-history-title" class="text-xl font-bold mb-4">GeÃ§miÅŸ</h2>
            <input type="text" id="history-search-input" placeholder="Ara..." class="w-full text-xs mb-3" onkeyup="filterHistory()">
            <div id="acc-history-list" class="space-y-3 overflow-y-auto flex-1"></div>
        </div>
    </div>

    <div id="transaction-modal" class="fixed inset-0 bg-black/90 hidden z-[60] flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-md rounded-2xl p-6 relative">
            <button onclick="closeModal('transaction-modal')" class="absolute top-4 right-4 text-slate-400"><i class="fas fa-times"></i></button>
            <h2 id="transaction-modal-title" class="text-xl font-bold mb-6">Ä°ÅŸlem</h2>
            <form id="transaction-form" class="space-y-4" onsubmit="saveTransaction(event)">
                <input type="hidden" id="transaction-id"><input type="hidden" id="transaction-type">
                <select id="transaction-student" class="w-full" required></select>
                <input type="number" id="transaction-amount" placeholder="Tutar" class="w-full" required>
                <input type="text" id="transaction-desc" placeholder="AÃ§Ä±klama" class="w-full" required>
                <button type="submit" class="w-full bg-blue-600 py-3 rounded-xl font-bold">Kaydet</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbx-vQo0BrwP1SBAu7jf6nb-EyjNObkt5HBZ-34m6rNkpVftOS6d-UZw0KdvEt_AEa_J/exec";
        
        let appState = {
            currentTab: 'calendar',
            students: [],
            lessons: [],
            accounting: [],
            priceLogs: [],
            currentWeekOffset: 0,
            branches: ["Matematik", "TÃ¼rkÃ§e", "Hayat Bilgisi", "Sosyal Bilgiler", "Fen Bilimleri", "Ä°ngilizce", "Bilsem", "Robotik Kodlama", "AkÄ±l ve Zeka OyunlarÄ±"],
            charts: { mood: null, subjectsSuccess: null, performance: null, reading: null, branchCount: null }
        };

        let tempStudentPhoto = "";
        let tempLessonMedia = [];
        let currentHistoryStudentId = null;

        // --- FETCH WITH RETRY ---
        async function fetchData(retryCount = 0) {
            if(!API_URL) return;
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error("AÄŸ hatasÄ±");
                const rawData = await response.text();
                const data = JSON.parse(rawData);
                if(data && typeof data === 'object') appState = {...appState, ...data};
                document.getElementById('loader').classList.add('hidden');
                updateStatsSelect();
                initCalendar();
                renderStudents();
            } catch(e) {
                if (retryCount < 3) {
                    setTimeout(() => fetchData(retryCount + 1), 1000 * Math.pow(2, retryCount));
                } else {
                    console.error("Fetch baÅŸarÄ±sÄ±z:", e);
                    document.getElementById('loader').classList.add('hidden');
                    initCalendar();
                }
            }
        }

        async function saveToCloud() {
            if(!API_URL) return;
            document.getElementById('sync-status').innerHTML = '<i class="fas fa-sync-alt animate-spin text-blue-400 mr-1"></i> Kaydediliyor...';
            try {
                await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(appState) });
                document.getElementById('sync-status').innerHTML = '<i class="fas fa-check-circle text-green-500 mr-1"></i> Senkronize';
            } catch(e) {
                document.getElementById('sync-status').innerHTML = '<i class="fas fa-times-circle text-red-500 mr-1"></i> Hata';
            }
        }

        // --- HELPERS ---
        function getWeekId() {
            const today = new Date();
            const diff = (today.getDay() === 0 ? -6 : 1 - today.getDay()) + (appState.currentWeekOffset * 7);
            const monday = new Date(today);
            monday.setDate(today.getDate() + diff);
            monday.setHours(0,0,0,0);
            return monday.toISOString().split('T')[0];
        }

        function getStudentName(id) { return appState.students.find(s => String(s.id) === String(id))?.name || "Bilinmiyor"; }
        function getStudentPrice(id) { return appState.students.find(s => String(s.id) === String(id))?.price || 0; }
        function updateStatsSelect() { 
            const select = document.getElementById('stats-student-select'); 
            if (select) select.innerHTML = '<option value="">Ã–ÄŸrenci SeÃ§iniz</option>' + appState.students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        }

        // --- RENDERERS ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`section-${tabId}`).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('tab-active'));
            document.getElementById(`nav-${tabId}`)?.classList.add('tab-active');
            if(tabId === 'stats') initStats();
            if(tabId === 'students') renderStudents();
            if(tabId === 'accounting') renderAccounting();
        }

        function initCalendar() {
            const grid = document.getElementById('calendar-grid');
            if(!grid) return; grid.innerHTML = '';
            const days = ['Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi', 'Pazar'];
            updateCalendarRange();
            days.forEach((day, index) => {
                const dayEl = document.createElement('div');
                dayEl.className = 'glass-card p-3 rounded-xl min-h-[300px] flex flex-col';
                dayEl.innerHTML = `<div class="mb-3 pb-2 border-b border-slate-700 font-bold text-xs text-blue-400 uppercase">${day}</div><div id="day-lessons-${index}" class="flex-1 space-y-2"></div><button onclick="openLessonModal(${index})" class="mt-4 w-full py-2 border border-dashed border-slate-600 rounded-lg text-[9px] hover:bg-slate-800 text-slate-500 font-bold">YENÄ° DERS</button>`;
                grid.appendChild(dayEl);
            });
            renderAllLessons();
        }

        function updateCalendarRange() {
            const today = new Date();
            const diff = (today.getDay() === 0 ? -6 : 1 - today.getDay()) + (appState.currentWeekOffset * 7);
            const monday = new Date(today); monday.setDate(today.getDate() + diff);
            const last = new Date(monday); last.setDate(monday.getDate() + 6);
            document.getElementById('calendar-date-range').innerText = `${monday.toLocaleDateString('tr-TR')} - ${last.toLocaleDateString('tr-TR')} ${last.getFullYear()}`;
        }

        function changeWeek(off) { appState.currentWeekOffset += off; initCalendar(); }
        function jumpToWeek(v) { if(!v) return; const parts = v.split('-W'); const year = parseInt(parts[0]); const week = parseInt(parts[1]); const sel = new Date(year, 0, 1 + (week - 1) * 7); const now = new Date(); now.setHours(0,0,0,0); appState.currentWeekOffset = Math.floor((sel - now) / (7 * 24 * 60 * 60 * 1000)); initCalendar(); }

        function renderAllLessons() {
            const currentWeekId = getWeekId();
            document.querySelectorAll('[id^="day-lessons-"]').forEach(el => el.innerHTML = '');
            appState.lessons.forEach(l => {
                if (l.weekId !== currentWeekId) return;
                const container = document.getElementById(`day-lessons-${l.day}`);
                if(container) {
                    const node = document.createElement('div');
                    node.className = `lesson-node p-2 rounded-lg text-[10px] ${l.attendance ? 'attendance-true' : 'attendance-false'}`;
                    node.onclick = () => openLessonModal(l.day, l.id);
                    node.innerHTML = `<strong>${l.time}</strong> - ${getStudentName(l.studentId)}<div class="opacity-50 truncate">${(l.selectedBranches || []).join(', ')}</div>`;
                    container.appendChild(node);
                }
            });
        }

        // --- ACTIONS ---
        function saveLesson(event) {
            event.preventDefault();
            const id = document.getElementById('lesson-id').value;
            const branches = [...document.querySelectorAll('.branch-chip.active')].map(c => c.innerText);
            const tests = Array.from(document.getElementById('test-rows-container').children).map(row => {
                const inputs = row.querySelectorAll('input');
                return { branch: row.querySelector('select').value, q: parseInt(inputs[0].value || 0), d: parseInt(inputs[1].value || 0), w: parseInt(inputs[2].value || 0), e: parseInt(inputs[3].value || 0) };
            });
            const sId = document.getElementById('lesson-student').value;
            const lesson = { id: id || Date.now().toString(), weekId: getWeekId(), studentId: sId, day: parseInt(document.getElementById('lesson-day').value), time: document.getElementById('lesson-time').value, attendance: document.getElementById('lesson-attendance').checked, selectedBranches: branches, tests, media: tempLessonMedia, words: document.getElementById('l-words').value, comprehension: document.getElementById('l-comp').value, mood: document.querySelector('input[name="mood"]:checked')?.value || null, notes: document.getElementById('lesson-notes').value, reminders: document.getElementById('lesson-reminders').value, unitPrice: getStudentPrice(sId) };
            if(id) { const idx = appState.lessons.findIndex(x => String(x.id) === String(id)); if (idx !== -1) appState.lessons[idx] = lesson; }
            else appState.lessons.push(lesson);
            closeModal('lesson-modal'); renderAllLessons(); saveToCloud();
        }

        function deleteCurrentLesson() {
            const id = document.getElementById('lesson-id').value;
            if(!id || !confirm("Emin misiniz?")) return;
            appState.lessons = appState.lessons.filter(l => String(l.id) !== String(id));
            closeModal('lesson-modal'); renderAllLessons(); saveToCloud();
        }

        function saveStudent(e) {
            e.preventDefault();
            const id = document.getElementById('student-id').value;
            const p = parseFloat(document.getElementById('student-price').value);
            const d = { id: id || Date.now().toString(), photo: tempStudentPhoto, name: document.getElementById('student-name').value, grade: document.getElementById('student-grade').value, price: p, notes: document.getElementById('student-notes').value };
            if(id) {
                const i = appState.students.findIndex(x => String(x.id) === String(id));
                if(appState.students[i].price !== p) appState.priceLogs.push({ studentId: id, old: appState.students[i].price, new: p, date: new Date().toLocaleString() });
                appState.students[i] = d;
            } else appState.students.push(d);
            closeModal('student-modal'); renderStudents(); updateStatsSelect(); saveToCloud();
        }

        function renderStudents(q = "") {
            const list = document.getElementById('student-list');
            if(!list) return; list.innerHTML = '';
            const filtered = appState.students.filter(s => s.name.toLowerCase().includes(q.toLowerCase()));
            document.getElementById('empty-student-msg').classList.toggle('hidden', filtered.length > 0);
            filtered.forEach(s => {
                const div = document.createElement('div');
                div.className = 'glass-card p-4 rounded-xl flex gap-3 border-l-4 border-blue-500';
                div.innerHTML = `<div class="w-12 h-12 rounded bg-slate-800 overflow-hidden flex-shrink-0">${s.photo ? `<img src="${s.photo}" class="w-full h-full object-cover">` : `<i class="fas fa-user m-3"></i>`}</div><div class="flex-1 overflow-hidden"><div class="flex justify-between"><strong>${s.name}</strong><button onclick="openStudentModal('${s.id}')" class="text-blue-400 text-xs"><i class="fas fa-edit"></i></button></div><div class="text-[10px] opacity-60">${s.grade}. SÄ±nÄ±f - â‚º${s.price}</div></div>`;
                list.appendChild(div);
            });
        }

        function renderAccounting(q = "") {
            const body = document.getElementById('accounting-table-body');
            if(!body) return; body.innerHTML = '';
            let tD = 0, tP = 0, tE = 0;
            appState.students.filter(s => s.name.toLowerCase().includes(q.toLowerCase())).forEach(s => {
                const lessons = appState.lessons.filter(l => String(l.studentId) === String(s.id) && l.attendance);
                const lDebt = lessons.reduce((sum, l) => sum + (l.unitPrice || s.price), 0);
                const eExp = appState.accounting.filter(a => String(a.studentId) === String(s.id) && a.type === 'expense').reduce((sum, a) => sum + a.amount, 0);
                const paid = appState.accounting.filter(a => String(a.studentId) === String(s.id) && a.type === 'payment').reduce((sum, a) => sum + a.amount, 0);
                const bal = (lDebt + eExp) - paid;
                tD += lDebt; tP += paid; tE += eExp;
                body.innerHTML += `<tr class="border-b border-slate-800"> <td class="p-4">${s.name}</td> <td class="p-4 text-center">${lessons.length}</td> <td class="p-4 text-blue-400">â‚º${lDebt}</td> <td class="p-4 text-orange-400">â‚º${eExp}</td> <td class="p-4 text-green-500">â‚º${paid}</td> <td class="p-4 font-bold ${bal > 0 ? 'text-red-500' : 'text-blue-400'}">â‚º${bal}</td> <td class="p-4 text-center"><button onclick="viewHistory('${s.id}')" class="bg-slate-800 p-2 rounded"><i class="fas fa-history text-slate-400"></i></button></td> </tr>`;
            });
            document.getElementById('acc-total-debt').innerText = `â‚º${tD + tE - tP}`;
            document.getElementById('acc-total-paid').innerText = `â‚º${tP}`;
        }

        // --- STATS ENGINE ---
        function loadStudentStats(id) { 
            const c = document.getElementById('stats-container'); 
            const e = document.getElementById('stats-empty-state'); 
            if(!id) { c.classList.add('hidden'); e.classList.remove('hidden'); return; } 
            c.classList.remove('hidden'); e.classList.add('hidden'); initStats(); 
        }
        function initStats() {
            const chs = ['mood', 'subjectsSuccess', 'performance', 'reading', 'branchCount']; chs.forEach(c => { if(appState.charts[c]) appState.charts[c].destroy(); });
            const sId = document.getElementById('stats-student-select').value; if(!sId) return;
            const dPool = appState.lessons.filter(l => String(l.studentId) === String(sId));
            
            // Mood
            const moods = [0,0,0,0,0]; dPool.forEach(l => { if(l.mood) moods[l.mood-1]++; });
            appState.charts.mood = new Chart(document.getElementById('chart-mood'), { type: 'doughnut', data: { labels: ['KÃ¶tÃ¼','ZayÄ±f','Normal','Ä°yi','Harika'], datasets:[{ data: moods, backgroundColor:['#ef4444','#f97316','#eab308','#3b82f6','#22c55e'] }] }, options: { maintainAspectRatio:false } });

            // Branch count
            const bcCounts = {}; appState.branches.forEach(b => bcCounts[b] = 0);
            dPool.forEach(l => (l.selectedBranches || []).forEach(b => bcCounts[b]++));
            appState.charts.branchCount = new Chart(document.getElementById('chart-branch-count'), { type: 'bar', data: { labels: appState.branches, datasets:[{ label:'Ders', data: appState.branches.map(b=>bcCounts[b]), backgroundColor:'#a855f7' }] }, options: { maintainAspectRatio:false } });

            // Success
            const brS = {}; appState.branches.forEach(b => brS[b] = { t:0, c:0 });
            dPool.forEach(l => (l.tests || []).forEach(t => { if(brS[t.branch]) { brS[t.branch].t += t.q; brS[t.branch].c += t.d; } }));
            appState.charts.subjectsSuccess = new Chart(document.getElementById('chart-subjects-success'), { type: 'bar', data: { labels: appState.branches, datasets:[{ label:'% BaÅŸarÄ±', data: appState.branches.map(b => brS[b].t > 0 ? (brS[b].c/brS[b].t)*100 : 0), backgroundColor:'#3b82f6' }] }, options: { maintainAspectRatio:false, scales:{y:{min:0,max:100}} } });

            // Line Performance
            const tH = []; dPool.forEach(l => (l.tests || []).forEach(t => tH.push({ r: t.q > 0 ? (t.d/t.q)*100 : 0 })));
            appState.charts.performance = new Chart(document.getElementById('chart-test-performance'), { type: 'line', data: { labels: tH.map((_,i)=>i+1), datasets:[{label:'% BaÅŸarÄ±', data:tH.map(x=>x.r), borderColor:'#3b82f6', tension:0.4}] }, options: { maintainAspectRatio:false, scales:{y:{min:0,max:100}} } });
            
            // Reading
            const p = dPool.filter(l => l.words || l.comprehension).slice(-10);
            appState.charts.reading = new Chart(document.getElementById('chart-reading'), { type: 'line', data: { labels: p.map((_,i)=>i+1), datasets:[{label:'Kelime', data:p.map(l=>l.words||0), borderColor:'#a855f7'}, {label:'% Anlama', data:p.map(l=>l.comprehension||0), borderColor:'#22c55e'}] }, options: { maintainAspectRatio:false } });
        }

        // --- OTHER UI ACTIONS ---
        function toggleBranchChip(el) { el.classList.toggle('active'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        async function exportFullCalendarPDF() { const el = document.getElementById('calendar-grid'); const canvas = await html2canvas(el, { backgroundColor:'#0f172a', scale:2 }); const pdf = new jspdf.jsPDF('l', 'mm', 'a4'); pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 10, 10, 277, 150); pdf.save('Takvim.pdf'); }
        function exportSingleLessonPDF() { alert("Ders Ã§Ä±ktÄ±sÄ± PDF olarak oluÅŸturuluyor..."); }
        function exportStatsPDF() { alert("Ä°statistik raporu oluÅŸturuluyor..."); }
        function exportAccountingPDF_Standard() { alert("Muhasebe raporu oluÅŸturuluyor..."); }
        function filterHistory() { /* implemented within viewHistory flow */ }
        function deleteTransaction(id) { if(!confirm("Silsin mi?")) return; appState.accounting = appState.accounting.filter(a => String(a.id) !== String(id)); saveToCloud(); renderAccounting(); closeModal('acc-history-modal'); }
        function saveTransaction(e) { e.preventDefault(); const type = document.getElementById('transaction-type').value; const sId = document.getElementById('transaction-student').value; const am = parseFloat(document.getElementById('transaction-amount').value); const d = document.getElementById('transaction-desc').value; appState.accounting.push({ id: Date.now().toString(), type, studentId: sId, amount: am, desc: d, date: new Date().toLocaleString() }); closeModal('transaction-modal'); renderAccounting(); saveToCloud(); }

        window.onload = fetchData;
    </script>
</body>
</html>
