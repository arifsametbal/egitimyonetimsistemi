<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EYS Pro - EÄŸitim YÃ¶netim Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .lesson-node { transition: all 0.2s; cursor: pointer; border-left: 4px solid #334155; margin-bottom: 0.5rem; }
        .lesson-node:hover { transform: scale(1.01); }
        .attendance-true { border-left-color: #10b981; background: rgba(16, 185, 129, 0.1); }
        .attendance-false { border-left-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        input, select, textarea { background: #1e293b !important; color: white !important; border: 1px solid #334155 !important; border-radius: 0.5rem; padding: 0.5rem; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .branch-chip { cursor: pointer; padding: 4px 12px; border-radius: 99px; border: 1px solid #334155; font-size: 11px; transition: all 0.2s; background: #1e293b; color: #94a3b8; }
        .branch-chip.active { background: #3b82f6; border-color: #3b82f6; color: white; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .media-preview { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid #334155; }
    </style>
</head>
<body class="min-h-screen pb-20 md:pb-0">

    <div id="loader" class="loading-overlay">
        <i class="fas fa-circle-notch animate-spin text-4xl text-blue-500 mb-4"></i>
        <p class="text-sm font-medium" id="loader-text">VeritabanÄ± Senkronize Ediliyor...</p>
        <p id="loader-error" class="text-xs text-red-400 mt-4 hidden">BaÄŸlantÄ± kesildi. LÃ¼tfen sayfayÄ± yenileyin.</p>
    </div>

    <!-- Ãœst Navigasyon -->
    <nav class="sticky top-0 z-50 glass-card px-4 py-3 flex justify-between items-center">
        <h1 class="text-xl font-bold bg-gradient-to-r from-blue-400 to-indigo-500 bg-clip-text text-transparent">
            <i class="fas fa-graduation-cap mr-2"></i>EYS Pro
        </h1>
        <div class="hidden md:flex space-x-6 text-sm font-medium">
            <button onclick="switchTab('calendar')" class="nav-link tab-active" id="nav-calendar">Takvim</button>
            <button onclick="switchTab('students')" class="nav-link" id="nav-students">Ã–ÄŸrenciler</button>
            <button onclick="switchTab('stats')" class="nav-link" id="nav-stats">Ä°statistik</button>
            <button onclick="switchTab('accounting')" class="nav-link" id="nav-accounting">Muhasebe</button>
        </div>
        <div id="sync-status" class="text-[10px] text-slate-500">
            <i class="fas fa-circle text-green-500 mr-1 animate-pulse"></i> Ã‡evrimiÃ§i
        </div>
    </nav>

    <main class="container mx-auto p-4 max-w-6xl">
        <!-- TAKVÄ°M BÃ–LÃœMÃœ -->
        <section id="section-calendar" class="tab-content">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <div class="flex items-center space-x-4">
                    <button class="p-2 glass-card rounded-lg" onclick="changeWeek(-1)"><i class="fas fa-chevron-left"></i></button>
                    <h2 id="calendar-date-range" class="text-sm font-bold uppercase tracking-widest text-center min-w-[220px]">Hafta</h2>
                    <button class="p-2 glass-card rounded-lg" onclick="changeWeek(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="flex gap-2 w-full md:w-auto">
                    <input type="week" id="calendar-week-picker" class="text-xs" onchange="jumpToWeek(this.value)">
                    <button onclick="exportFullCalendarPDF()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-xs flex-1 md:flex-none">
                        <i class="fas fa-file-pdf mr-1"></i>PDF
                    </button>
                </div>
            </div>
            <div id="calendar-grid" class="grid grid-cols-1 md:grid-cols-7 gap-3"></div>
        </section>

        <!-- Ã–ÄRENCÄ°LER BÃ–LÃœMÃœ -->
        <section id="section-students" class="tab-content hidden">
            <div class="flex flex-col md:flex-row justify-between mb-6 gap-4">
                <div class="relative flex-1">
                    <i class="fas fa-search absolute left-3 top-3.5 text-slate-500 text-xs"></i>
                    <input type="text" placeholder="Ã–ÄŸrenci adÄ± ile ara..." class="w-full pl-9 text-sm" onkeyup="renderStudents(this.value)">
                </div>
                <button onclick="openStudentModal()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2.5 rounded-lg text-sm font-bold">
                    <i class="fas fa-user-plus mr-2"></i>Yeni Ã–ÄŸrenci
                </button>
            </div>
            <div id="student-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            <div id="empty-student-msg" class="text-center py-20 text-slate-500 hidden">
                <i class="fas fa-users-slash text-4xl mb-4 opacity-20"></i>
                <p>HenÃ¼z kayÄ±tlÄ± Ã¶ÄŸrenci bulunmuyor.</p>
            </div>
        </section>

        <!-- Ä°STATÄ°STÄ°K BÃ–LÃœMÃœ -->
        <section id="section-stats" class="tab-content hidden">
            <div class="mb-6 flex flex-wrap gap-4 items-center">
                <select id="stats-student-select" class="w-full md:w-64 text-sm text-black" onchange="loadStudentStats(this.value)">
                    <option value="">Ã–ÄŸrenci SeÃ§iniz</option>
                </select>
                <select id="stats-branch-select" class="w-full md:w-64 text-sm text-black" onchange="initStats()">
                    <option value="ALL">TÃ¼m BranÅŸlar (Genel)</option>
                </select>
                <button onclick="exportStatsPDF()" class="bg-purple-600 text-white px-5 py-2.5 rounded-lg text-sm font-bold w-full md:w-auto">
                    <i class="fas fa-chart-pie mr-2"></i>GeliÅŸim Raporu (PDF)
                </button>
            </div>
            <div id="stats-empty-state" class="text-center py-20 text-slate-500">
                <i class="fas fa-chart-line text-5xl mb-4 opacity-20"></i>
                <p>Ä°statistikleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in lÃ¼tfen bir Ã¶ÄŸrenci seÃ§in.</p>
            </div>
            <div id="stats-container" class="space-y-6 hidden">
                <!-- Grafikler -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-card p-4 rounded-xl md:col-span-2"><h3 id="chart-main-title" class="font-bold mb-4 text-[10px] text-slate-400 uppercase tracking-widest">Test BaÅŸarÄ± GrafiÄŸi (%)</h3><div class="h-[250px]"><canvas id="chart-test-performance"></canvas></div></div>
                    <div class="glass-card p-4 rounded-xl md:col-span-2"><h3 class="font-bold mb-4 text-[10px] text-slate-400 uppercase tracking-widest">BranÅŸ BazlÄ± Ders SayÄ±sÄ±</h3><div class="h-[250px]"><canvas id="chart-branch-count"></canvas></div></div>
                    <div class="glass-card p-4 rounded-xl"><h3 class="font-bold mb-4 text-[10px] text-slate-400 uppercase tracking-widest">Duygu Durumu</h3><div class="h-[200px]"><canvas id="chart-mood"></canvas></div></div>
                    <div class="glass-card p-4 rounded-xl"><h3 class="font-bold mb-4 text-[10px] text-slate-400 uppercase tracking-widest">BranÅŸ BaÅŸarÄ± OranlarÄ± (%)</h3><div class="h-[200px]"><canvas id="chart-subjects-success"></canvas></div></div>
                    <div class="glass-card p-4 rounded-xl md:col-span-2"><h3 class="font-bold mb-4 text-[10px] text-slate-400 uppercase tracking-widest">Okuma HÄ±zÄ± & Anlama GeliÅŸimi</h3><div class="h-[250px]"><canvas id="chart-reading"></canvas></div></div>
                </div>

                <!-- DERS LOG KAYITLARI BÃ–LÃœMÃœ -->
                <div class="glass-card p-6 rounded-2xl border border-blue-500/20 shadow-xl">
                    <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 border-b border-slate-700/50 pb-4 gap-4">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-history text-blue-500 text-xl"></i>
                            <h3 class="font-bold text-sm uppercase tracking-widest text-slate-200">Ders Log KayÄ±tlarÄ±</h3>
                        </div>
                        <div class="flex items-center gap-2 flex-1 md:max-w-sm">
                            <input type="text" id="log-search-input" placeholder="Tarihe gÃ¶re filtrele (Ã¶rn: 12 Ocak)..." class="w-full text-xs px-3 py-1.5" onkeyup="filterLessonLogs()">
                            <span id="log-count" class="text-[10px] bg-blue-600 px-2 py-1.5 rounded-lg font-bold whitespace-nowrap">0 Ders</span>
                        </div>
                    </div>
                    <div id="lesson-logs-list" class="space-y-4 max-h-[500px] overflow-y-auto pr-2">
                        <!-- Loglar buraya render edilecek -->
                    </div>
                </div>
            </div>
        </section>

        <!-- MUHASEBE BÃ–LÃœMÃœ -->
        <section id="section-accounting" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 text-center">
                <div class="glass-card p-5 rounded-xl border-t-4 border-red-500"><p class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Toplam Kalan Bakiye</p><h4 id="acc-total-debt" class="text-2xl font-bold mt-1 text-red-400">â‚º0</h4></div>
                <div class="glass-card p-5 rounded-xl border-t-4 border-green-500"><p class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Toplam Tahsilat</p><h4 id="acc-total-paid" class="text-2xl font-bold mt-1 text-green-400">â‚º0</h4></div>
            </div>
            <div class="flex flex-col md:flex-row justify-between mb-4 gap-4">
                <div class="flex space-x-2">
                    <button onclick="openTransactionModal('payment')" class="bg-green-600 px-5 py-2.5 rounded-lg text-xs font-bold shadow-lg shadow-green-500/10">Ã–DEME AL</button>
                    <button onclick="openTransactionModal('expense')" class="bg-red-600 px-5 py-2.5 rounded-lg text-xs font-bold shadow-lg shadow-red-500/10">HARCAMA GÄ°R</button>
                </div>
                <input type="text" placeholder="Muhasebe tablosunda ara..." class="text-xs px-4 flex-1 md:max-w-xs" onkeyup="renderAccounting(this.value)">
            </div>
            <div class="overflow-x-auto glass-card rounded-xl">
                <table class="w-full text-left text-sm">
                    <thead><tr class="bg-slate-800/50 text-[10px] uppercase text-slate-400"><th class="p-4">Ã–ÄŸrenci</th><th class="p-4 text-center">Ders</th><th class="p-4">BorÃ§</th><th class="p-4">Harcama</th><th class="p-4">Ã–denen</th><th class="p-4 font-bold text-white">Kalan</th><th class="p-4 text-center">Detay</th></tr></thead>
                    <tbody id="accounting-table-body"></tbody>
                    <tfoot id="accounting-table-foot" class="font-bold bg-slate-800/40 text-xs text-blue-400 uppercase"></tfoot>
                </table>
            </div>
        </section>
    </main>

    <!-- MODALLAR -->
    <!-- Ders Modal -->
    <div id="lesson-modal" class="fixed inset-0 bg-black/90 hidden z-[60] flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-2xl max-h-[95vh] overflow-y-auto rounded-2xl p-6 relative">
            <button onclick="closeModal('lesson-modal')" class="absolute top-4 right-4 text-slate-400"><i class="fas fa-times text-xl"></i></button>
            <h2 class="text-xl font-bold mb-6 border-b border-slate-700 pb-2 text-slate-200">Ders AyrÄ±ntÄ±larÄ±</h2>
            <form id="lesson-form" class="space-y-6" onsubmit="saveLesson(event)">
                <input type="hidden" id="lesson-id"><input type="hidden" id="lesson-day">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-[10px] text-slate-500 uppercase mb-1">Ã–ÄŸrenci</label><select id="lesson-student" class="w-full text-sm" required></select></div>
                    <div><label class="block text-[10px] text-slate-500 uppercase mb-1">Zaman</label><div class="flex gap-2"><input type="time" id="lesson-time" class="flex-1 text-sm" required><label class="flex items-center space-x-2 px-3 glass-card rounded cursor-pointer"><input type="checkbox" id="lesson-attendance" class="w-4 h-4"><span class="text-xs">Burada</span></label></div></div>
                </div>
                <div><label class="block text-[10px] text-slate-500 uppercase mb-2">BranÅŸ SeÃ§imi</label><div id="branch-container" class="flex flex-wrap gap-2"></div></div>
                <div class="bg-slate-800/40 p-4 rounded-xl"><div class="flex justify-between items-center mb-4"><label class="text-[10px] text-slate-500 uppercase font-bold">Akademik Test GiriÅŸi</label><button type="button" onclick="addTestRow()" class="text-[10px] bg-blue-600 text-white px-3 py-1 rounded-full">+ Ekle</button></div><div id="test-rows-container" class="space-y-2"></div></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-[10px] text-slate-500 uppercase mb-1">HÄ±zlÄ± Okuma</label><div class="flex gap-2"><input type="number" placeholder="Kelime" id="l-words" class="w-full text-sm"><input type="number" placeholder="%" id="l-comp" class="w-full text-sm"></div></div>
                    <div><label class="block text-[10px] text-slate-500 uppercase mb-2">Duygu Durumu</label><div class="flex gap-3 justify-between">
                        <label class="cursor-pointer text-2xl opacity-30 hover:opacity-100 peer-checked:opacity-100"><input type="radio" name="mood" value="1" class="hidden peer"><span class="peer-checked:scale-125 inline-block">ğŸ˜¡</span></label>
                        <label class="cursor-pointer text-2xl opacity-30 hover:opacity-100 peer-checked:opacity-100"><input type="radio" name="mood" value="2" class="hidden peer"><span class="peer-checked:scale-125 inline-block">ğŸ˜•</span></label>
                        <label class="cursor-pointer text-2xl opacity-30 hover:opacity-100 peer-checked:opacity-100"><input type="radio" name="mood" value="3" class="hidden peer"><span class="peer-checked:scale-125 inline-block">ğŸ˜</span></label>
                        <label class="cursor-pointer text-2xl opacity-30 hover:opacity-100 peer-checked:opacity-100"><input type="radio" name="mood" value="4" class="hidden peer"><span class="peer-checked:scale-125 inline-block">ğŸ™‚</span></label>
                        <label class="cursor-pointer text-2xl opacity-30 hover:opacity-100 peer-checked:opacity-100"><input type="radio" name="mood" value="5" class="hidden peer"><span class="peer-checked:scale-125 inline-block">ğŸ˜Š</span></label>
                    </div></div>
                </div>
                <div class="space-y-2"><label class="block text-[10px] text-slate-500 uppercase">Medya (GÃ¶rsel/Video)</label><input type="file" id="lesson-media-input" accept="image/*,video/*" multiple class="text-xs" onchange="handleLessonMedia(event)"><div id="lesson-media-preview" class="flex flex-wrap gap-2 mt-2"></div></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <textarea id="lesson-notes" placeholder="Derste yapÄ±lanlar..." class="w-full h-24 text-sm"></textarea>
                    <textarea id="lesson-reminders" placeholder="Ã–nemli hatÄ±rlatmalar..." class="w-full h-24 text-sm border-dashed border-yellow-500/30"></textarea>
                </div>
                <div class="flex justify-between items-center pt-4 border-t border-slate-700">
                    <div class="flex gap-4"><button type="button" onclick="exportSingleLessonPDF()" class="text-blue-400 text-sm">PDF</button><button id="btn-lesson-delete" type="button" onclick="deleteCurrentLesson()" class="text-red-500 text-sm hidden">Sil</button></div>
                    <div class="space-x-3"><button type="button" onclick="closeModal('lesson-modal')" class="bg-slate-800 px-5 py-2 rounded-lg text-sm text-slate-300">VazgeÃ§</button><button type="submit" class="bg-blue-600 px-8 py-2 rounded-lg font-bold text-sm">Kaydet</button></div>
                </div>
            </form>
        </div>
    </div>

    <!-- Ã–ÄŸrenci Modal -->
    <div id="student-modal" class="fixed inset-0 bg-black/90 hidden z-[60] flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-lg rounded-2xl p-6 relative overflow-y-auto max-h-[90vh]">
            <button onclick="closeModal('student-modal')" class="absolute top-4 right-4 text-slate-400"><i class="fas fa-times text-xl"></i></button>
            <h2 id="student-modal-title" class="text-xl font-bold mb-6 text-slate-200">Ã–ÄŸrenci KaydÄ±</h2>
            <form id="student-form" class="space-y-4" onsubmit="saveStudent(event)">
                <input type="hidden" id="student-id">
                <div class="flex flex-col items-center mb-4">
                    <div id="student-photo-preview" class="w-24 h-24 rounded-full bg-slate-800 border-2 border-dashed border-slate-600 flex items-center justify-center overflow-hidden">
                        <i class="fas fa-user text-3xl text-slate-600"></i>
                    </div>
                    <input type="file" id="student-photo-input" accept="image/*" class="text-[10px] w-48 mt-2" onchange="handleStudentPhoto(event)">
                </div>
                <div><label class="block text-xs text-slate-500 uppercase mb-1">Tam AdÄ±</label><input type="text" id="student-name" class="w-full text-sm" required></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs text-slate-500 uppercase mb-1">SÄ±nÄ±f</label><select id="student-grade" class="w-full text-sm"><option value="1">1. SÄ±nÄ±f</option><option value="2">2. SÄ±nÄ±f</option><option value="3">3. SÄ±nÄ±f</option><option value="4">4. SÄ±nÄ±f</option><option value="5">5. SÄ±nÄ±f</option><option value="6">6. SÄ±nÄ±f</option><option value="7">7. SÄ±nÄ±f</option><option value="8">8. SÄ±nÄ±f</option><option value="9">9. SÄ±nÄ±f</option><option value="10">10. SÄ±nÄ±f</option><option value="11">11. SÄ±nÄ±f</option><option value="12">12. SÄ±nÄ±f</option></select></div>
                    <div><label class="block text-xs text-slate-500 uppercase mb-1">Birim Ãœcret (â‚º)</label><input type="number" id="student-price" class="w-full text-sm" required></div>
                </div>
                <div><label class="block text-xs text-slate-500 uppercase mb-1">EÄŸitmen NotlarÄ±</label><textarea id="student-notes" class="w-full h-24 text-sm"></textarea></div>
                <div id="price-log-container" class="hidden bg-slate-800/50 p-3 rounded-lg mt-4"><p class="text-[9px] font-bold text-slate-400 uppercase mb-2 text-slate-400">Fiyat GeÃ§miÅŸi</p><ul id="price-log-list" class="text-[10px] text-slate-400 space-y-1"></ul></div>
                <button type="submit" class="w-full bg-green-600 py-3 rounded-xl font-bold mt-4 shadow-lg shadow-green-500/10 text-sm">Ã–ÄŸrenciyi Kaydet</button>
            </form>
        </div>
    </div>

    <!-- Ä°ÅŸlem Modal -->
    <div id="transaction-modal" class="fixed inset-0 bg-black/90 hidden z-[70] flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-md rounded-2xl p-6 relative">
            <button onclick="closeModal('transaction-modal')" class="absolute top-4 right-4 text-slate-400"><i class="fas fa-times text-xl"></i></button>
            <h2 id="transaction-modal-title" class="text-xl font-bold mb-6 text-slate-200">Finansal Ä°ÅŸlem</h2>
            <form id="transaction-form" class="space-y-4" onsubmit="saveTransaction(event)">
                <input type="hidden" id="transaction-id"><input type="hidden" id="transaction-type">
                <div><label class="block text-xs text-slate-500 uppercase mb-1">Ä°lgili Ã–ÄŸrenci</label><select id="transaction-student" class="w-full text-sm text-black" required></select></div>
                <div><label class="block text-xs text-slate-500 uppercase mb-1">Tutar (â‚º)</label><input type="number" id="transaction-amount" class="w-full text-sm" required></div>
                <div><label class="block text-xs text-slate-500 uppercase mb-1">AÃ§Ä±klama</label><input type="text" id="transaction-desc" class="w-full text-sm" required></div>
                <button type="submit" class="w-full bg-blue-600 py-3 rounded-xl font-bold mt-4 shadow-lg shadow-blue-500/20 text-sm">Hareketi Kaydet</button>
            </form>
        </div>
    </div>

    <!-- GeÃ§miÅŸ ModalÄ± -->
    <div id="acc-history-modal" class="fixed inset-0 bg-black/90 hidden z-[60] flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-2xl rounded-2xl p-6 relative max-h-[80vh] overflow-hidden flex flex-col">
            <button onclick="closeModal('acc-history-modal')" class="absolute top-4 right-4 text-slate-400"><i class="fas fa-times"></i></button>
            <h2 id="acc-history-title" class="text-xl font-bold mb-4 text-slate-200">Ä°ÅŸlem KayÄ±tlarÄ±</h2>
            <input type="text" id="history-search-input" placeholder="Tarih veya aÃ§Ä±klama ile ara..." class="w-full text-xs mb-3 font-medium" onkeyup="filterHistory()">
            <div id="acc-history-list" class="space-y-3 overflow-y-auto flex-1 pr-2"></div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbx-vQo0BrwP1SBAu7jf6nb-EyjNObkt5HBZ-34m6rNkpVftOS6d-UZw0KdvEt_AEa_J/exec";
        
        let appState = {
            currentTab: 'calendar',
            students: [],
            lessons: [],
            accounting: [],
            priceLogs: [],
            currentWeekOffset: 0,
            branches: ["Matematik", "TÃ¼rkÃ§e", "Hayat Bilgisi", "Sosyal Bilgiler", "Fen Bilimleri", "Ä°ngilizce", "Bilsem", "Robotik Kodlama", "AkÄ±l ve Zeka OyunlarÄ±"],
            charts: { mood: null, subjectsSuccess: null, performance: null, reading: null, branchCount: null },
            isLoaded: false
        };

        let tempStudentPhoto = "";
        let tempLessonMedia = [];
        let currentHistoryStudentId = null;

        // --- CORE HELPERS ---
        function getStudentName(id) { return appState.students.find(s => String(s.id) === String(id))?.name || "Bilinmiyor"; }
        function getStudentPrice(id) { return appState.students.find(s => String(s.id) === String(id))?.price || 0; }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        
        function updateStatsSelect() { 
            const select = document.getElementById('stats-student-select'); 
            const accSelect = document.getElementById('transaction-student');
            const branchSelect = document.getElementById('stats-branch-select');
            
            if (select && accSelect) {
                const options = '<option value="">Ã–ÄŸrenci SeÃ§iniz</option>' + appState.students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                select.innerHTML = options;
                accSelect.innerHTML = options;
            }
            
            if (branchSelect) {
                const branchOptions = '<option value="ALL">TÃ¼m BranÅŸlar (Genel)</option>' + appState.branches.map(b => `<option value="${b}">${b}</option>`).join('');
                branchSelect.innerHTML = branchOptions;
            }
        }

        // --- FETCH ENGINE ---
        async function fetchData(retry = 0) {
            if(!API_URL) return;
            try {
                const response = await fetch(API_URL);
                const rawData = await response.text();
                if (!rawData || rawData === "Success") throw new Error("BoÅŸ veri");
                const data = JSON.parse(rawData);
                appState = {...appState, ...data, isLoaded: true};
                document.getElementById('loader').classList.add('hidden');
                updateStatsSelect();
                initCalendar();
                renderStudents();
                renderAccounting();
            } catch(e) {
                console.error("Fetch HatasÄ±:", e);
                if (retry < 3) {
                    setTimeout(() => fetchData(retry + 1), 2000);
                } else {
                    document.getElementById('loader-text').innerText = "Veri okunamadÄ±. SayfayÄ± yenileyin.";
                    document.getElementById('loader-error').classList.remove('hidden');
                }
            }
        }

        async function saveToCloud() {
            if(!API_URL || !appState.isLoaded) return;
            document.getElementById('sync-status').innerHTML = '<i class="fas fa-sync-alt animate-spin text-blue-400 mr-1"></i> Kaydediliyor...';
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(appState)
                });
                document.getElementById('sync-status').innerHTML = '<i class="fas fa-check-circle text-green-500 mr-1"></i> Senkronize';
            } catch(e) {
                document.getElementById('sync-status').innerHTML = '<i class="fas fa-times-circle text-red-500 mr-1"></i> Hata';
            }
        }

        // --- UI LOGIC ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`section-${tabId}`).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('tab-active'));
            document.getElementById(`nav-${tabId}`)?.classList.add('tab-active');
            if(tabId === 'stats') initStats();
            if(tabId === 'students') renderStudents();
            if(tabId === 'accounting') renderAccounting();
        }

        function getWeekId() {
            const today = new Date();
            const diff = (today.getDay() === 0 ? -6 : 1 - today.getDay()) + (appState.currentWeekOffset * 7);
            const monday = new Date(today);
            monday.setDate(today.getDate() + diff);
            monday.setHours(0,0,0,0);
            return monday.toISOString().split('T')[0];
        }

        function initCalendar() {
            const grid = document.getElementById('calendar-grid');
            if(!grid) return; grid.innerHTML = '';
            const days = ['Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi', 'Pazar'];
            updateCalendarRange();
            days.forEach((day, index) => {
                const dayEl = document.createElement('div');
                dayEl.className = 'glass-card p-3 rounded-xl min-h-[300px] flex flex-col';
                dayEl.innerHTML = `<div class="mb-3 pb-2 border-b border-slate-700 font-bold text-[10px] text-blue-400 uppercase tracking-tighter">${day}</div><div id="day-lessons-${index}" class="flex-1 space-y-2"></div><button onclick="openLessonModal(${index})" class="mt-4 w-full py-2 border border-dashed border-slate-600 rounded-lg text-[9px] hover:bg-slate-800 text-slate-500 font-bold uppercase tracking-widest">Yeni Ders</button>`;
                grid.appendChild(dayEl);
            });
            renderAllLessons();
        }

        function updateCalendarRange() {
            const today = new Date();
            const diff = (today.getDay() === 0 ? -6 : 1 - today.getDay()) + (appState.currentWeekOffset * 7);
            const monday = new Date(today); monday.setDate(today.getDate() + diff);
            const last = new Date(monday); last.setDate(monday.getDate() + 6);
            document.getElementById('calendar-date-range').innerText = `${monday.toLocaleDateString('tr-TR')} - ${last.toLocaleDateString('tr-TR')} ${last.getFullYear()}`;
        }

        function changeWeek(off) { appState.currentWeekOffset += off; initCalendar(); }
        function jumpToWeek(v) { if(!v) return; const parts = v.split('-W'); const year = parseInt(parts[0]); const week = parseInt(parts[1]); const sel = new Date(year, 0, 1 + (week - 1) * 7); const now = new Date(); now.setHours(0,0,0,0); appState.currentWeekOffset = Math.round((sel - now) / (7 * 24 * 60 * 60 * 1000) / 7); initCalendar(); }

        function renderAllLessons() {
            const currentWeekId = getWeekId();
            document.querySelectorAll('[id^="day-lessons-"]').forEach(el => el.innerHTML = '');
            appState.lessons.forEach(l => {
                if (l.weekId !== currentWeekId) return;
                const container = document.getElementById(`day-lessons-${l.day}`);
                if(container) {
                    const node = document.createElement('div');
                    node.className = `lesson-node p-2 rounded-lg text-[10px] ${l.attendance ? 'attendance-true' : 'attendance-false'}`;
                    node.onclick = () => openLessonModal(l.day, l.id);
                    node.innerHTML = `<strong>${l.time}</strong> - ${getStudentName(l.studentId)}<div class="opacity-50 truncate mt-1">${(l.selectedBranches || []).join(', ')}</div>`;
                    container.appendChild(node);
                }
            });
        }

        // --- LESSON ---
        function openLessonModal(day, id = null) {
            const modal = document.getElementById('lesson-modal');
            const form = document.getElementById('lesson-form');
            form.reset();
            tempLessonMedia = [];
            document.getElementById('lesson-media-preview').innerHTML = '';
            document.getElementById('lesson-student').innerHTML = appState.students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            
            const bc = document.getElementById('branch-container');
            bc.innerHTML = appState.branches.map(b => `<div class="branch-chip" onclick="toggleBranchChip(this)">${b}</div>`).join('');
            
            document.getElementById('test-rows-container').innerHTML = '';
            document.getElementById('lesson-day').value = day;
            document.getElementById('lesson-id').value = id || "";
            const delBtn = document.getElementById('btn-lesson-delete');
            
            if(id) {
                delBtn.classList.remove('hidden');
                const l = appState.lessons.find(x => String(x.id) === String(id));
                if (l) {
                    document.getElementById('lesson-student').value = l.studentId;
                    document.getElementById('lesson-time').value = l.time;
                    document.getElementById('lesson-attendance').checked = l.attendance;
                    document.getElementById('l-words').value = l.words || "";
                    document.getElementById('l-comp').value = l.comprehension || "";
                    document.getElementById('lesson-notes').value = l.notes || "";
                    document.getElementById('lesson-reminders').value = l.reminders || "";
                    if(l.mood) { const r = form.querySelector(`input[name="mood"][value="${l.mood}"]`); if(r) r.checked = true; }
                    (l.selectedBranches || []).forEach(bName => { const chip = [...bc.children].find(c => c.innerText === bName); if(chip) chip.classList.add('active'); });
                    (l.tests || []).forEach(t => addTestRow(t));
                    if (l.media) { tempLessonMedia = [...l.media]; l.media.forEach(m => { const el = document.createElement('div'); el.innerHTML = `<img src="${m.data}" class="media-preview">`; document.getElementById('lesson-media-preview').appendChild(el); }); }
                }
            } else delBtn.classList.add('hidden');
            modal.classList.remove('hidden');
        }

        function addTestRow(data = null) {
            const container = document.getElementById('test-rows-container');
            const row = document.createElement('div');
            row.className = 'grid grid-cols-6 gap-2 items-center';
            row.innerHTML = `<select class="text-[10px] col-span-2 py-1 text-black">${appState.branches.map(b => `<option ${data?.branch === b ? 'selected' : ''}>${b}</option>`).join('')}</select><input type="number" placeholder="S" class="text-[10px] py-1" value="${data?.q || ''}"><input type="number" placeholder="D" class="text-[10px] py-1" value="${data?.d || ''}"><input type="number" placeholder="Y" class="text-[10px] py-1" value="${data?.w || ''}"><input type="number" placeholder="B" class="text-[10px] py-1" value="${data?.e || ''}"><button type="button" onclick="this.parentElement.remove()" class="text-red-500 text-xs"><i class="fas fa-trash-alt"></i></button>`;
            container.appendChild(row);
        }

        function toggleBranchChip(el) { el.classList.toggle('active'); }

        function saveLesson(event) {
            event.preventDefault();
            const id = document.getElementById('lesson-id').value;
            const branches = [...document.querySelectorAll('.branch-chip.active')].map(c => c.innerText);
            const tests = Array.from(document.getElementById('test-rows-container').children).map(row => {
                const inputs = row.querySelectorAll('input');
                return { branch: row.querySelector('select').value, q: parseInt(inputs[0].value || 0), d: parseInt(inputs[1].value || 0), w: parseInt(inputs[2].value || 0), e: parseInt(inputs[3].value || 0) };
            });
            const sId = document.getElementById('lesson-student').value;
            const lesson = { id: id || Date.now().toString(), weekId: getWeekId(), studentId: sId, day: parseInt(document.getElementById('lesson-day').value), time: document.getElementById('lesson-time').value, attendance: document.getElementById('lesson-attendance').checked, selectedBranches: branches, tests, media: tempLessonMedia, words: document.getElementById('l-words').value, comprehension: document.getElementById('l-comp').value, mood: document.querySelector('input[name="mood"]:checked')?.value || null, notes: document.getElementById('lesson-notes').value, reminders: document.getElementById('lesson-reminders').value, unitPrice: getStudentPrice(sId) };
            if(id) { const idx = appState.lessons.findIndex(x => String(x.id) === String(id)); if (idx !== -1) appState.lessons[idx] = lesson; }
            else appState.lessons.push(lesson);
            closeModal('lesson-modal'); renderAllLessons(); saveToCloud();
        }

        function deleteCurrentLesson() {
            const id = document.getElementById('lesson-id').value;
            if(!id || !confirm("Emin misiniz?")) return;
            appState.lessons = appState.lessons.filter(l => String(l.id) !== String(id));
            closeModal('lesson-modal'); renderAllLessons(); saveToCloud();
        }

        // --- STUDENT ---
        function renderStudents(q = "") {
            const list = document.getElementById('student-list');
            if(!list) return; list.innerHTML = '';
            const filtered = appState.students.filter(s => s.name.toLowerCase().includes(q.toLowerCase()));
            document.getElementById('empty-student-msg').classList.toggle('hidden', filtered.length > 0);
            filtered.forEach(s => {
                const div = document.createElement('div');
                div.className = 'glass-card p-4 rounded-xl flex gap-3 border-l-4 border-blue-500';
                div.innerHTML = `<div class="w-12 h-12 rounded bg-slate-800 overflow-hidden flex-shrink-0">${s.photo ? `<img src="${s.photo}" class="w-full h-full object-cover">` : `<i class="fas fa-user m-3"></i>`}</div><div class="flex-1 overflow-hidden"><div class="flex justify-between"><strong>${s.name}</strong><div class="flex gap-1"><button onclick="openStudentModal('${s.id}')" class="text-blue-400 text-xs"><i class="fas fa-edit"></i></button><button onclick="deleteStudent('${s.id}')" class="text-red-500 text-xs"><i class="fas fa-trash"></i></button></div></div><div class="text-[10px] opacity-60">${s.grade}. SÄ±nÄ±f - â‚º${s.price}</div></div>`;
                list.appendChild(div);
            });
        }

        function openStudentModal(id = null) {
            const m = document.getElementById('student-modal');
            const f = document.getElementById('student-form');
            f.reset();
            const logContainer = document.getElementById('price-log-container');
            const logList = document.getElementById('price-log-list');
            tempStudentPhoto = "";
            document.getElementById('student-photo-preview').innerHTML = `<i class="fas fa-user text-3xl text-slate-600"></i>`;
            document.getElementById('student-id').value = id || "";
            logContainer.classList.add('hidden');
            logList.innerHTML = "";
            if(id) {
                const s = appState.students.find(x => String(x.id) === String(id));
                if (s) {
                    document.getElementById('student-name').value = s.name; document.getElementById('student-grade').value = s.grade; document.getElementById('student-price').value = s.price; document.getElementById('student-notes').value = s.notes || "";
                    if (s.photo) { tempStudentPhoto = s.photo; document.getElementById('student-photo-preview').innerHTML = `<img src="${s.photo}" class="w-full h-full object-cover">`; }
                    const logs = (appState.priceLogs || []).filter(l => String(l.studentId) === String(id));
                    if (logs.length > 0) { logContainer.classList.remove('hidden'); logList.innerHTML = logs.map(l => `<li class="flex justify-between border-b border-slate-700/50 pb-1 text-slate-300"><span>${l.date}</span><span class="font-bold">â‚º${l.old} â” â‚º${l.new}</span></li>`).join(''); }
                }
            }
            m.classList.remove('hidden');
        }

        function saveStudent(e) {
            e.preventDefault();
            const id = document.getElementById('student-id').value;
            const price = parseFloat(document.getElementById('student-price').value);
            const data = { id: id || Date.now().toString(), photo: tempStudentPhoto, name: document.getElementById('student-name').value, grade: document.getElementById('student-grade').value, price, notes: document.getElementById('student-notes').value };
            if(id) {
                const idx = appState.students.findIndex(x => String(x.id) === String(id));
                if(appState.students[idx].price !== price) appState.priceLogs.push({ studentId: id, old: appState.students[idx].price, new: price, date: new Date().toLocaleString() });
                appState.students[idx] = data;
            } else appState.students.push(data);
            closeModal('student-modal'); renderStudents(); updateStatsSelect(); saveToCloud();
        }

        function deleteStudent(id) {
            if(!confirm("Emin misiniz?")) return;
            appState.students = appState.students.filter(s => String(s.id) !== String(id));
            appState.lessons = appState.lessons.filter(l => String(l.studentId) !== String(id));
            appState.accounting = appState.accounting.filter(a => String(a.studentId) !== String(id));
            renderStudents(); updateStatsSelect(); saveToCloud();
        }

        // --- ACCOUNTING ---
        function renderAccounting(q = "") {
            const body = document.getElementById('accounting-table-body');
            const foot = document.getElementById('accounting-table-foot');
            if(!body) return; body.innerHTML = '';
            let tD = 0, tP = 0, tE = 0, tL = 0;
            appState.students.filter(s => s.name.toLowerCase().includes(q.toLowerCase())).forEach(s => {
                const lessons = appState.lessons.filter(l => String(l.studentId) === String(s.id) && l.attendance);
                const lDebt = lessons.reduce((sum, l) => sum + (l.unitPrice || s.price), 0);
                const eExp = appState.accounting.filter(a => String(a.studentId) === String(s.id) && a.type === 'expense').reduce((sum, a) => sum + a.amount, 0);
                const paid = appState.accounting.filter(a => String(a.studentId) === String(s.id) && a.type === 'payment').reduce((sum, a) => sum + a.amount, 0);
                const bal = (lDebt + eExp) - paid;
                tD += lDebt; tP += paid; tE += eExp; tL += lessons.length;
                body.innerHTML += `<tr class="border-b border-slate-800 hover:bg-slate-800/20"><td class="p-4 font-bold text-xs">${s.name}</td><td class="p-4 text-center text-xs">${lessons.length}</td><td class="p-4 text-blue-400 text-xs">â‚º${lDebt}</td><td class="p-4 text-orange-400 text-xs">â‚º${eExp}</td><td class="p-4 text-green-500 font-bold text-xs">â‚º${paid}</td><td class="p-4 font-bold ${bal > 0 ? 'text-red-500' : 'text-blue-400'} text-xs">â‚º${bal}</td><td class="p-4 text-center"><button onclick="viewHistory('${s.id}')" class="bg-slate-800 p-2 rounded text-slate-400 hover:text-white"><i class="fas fa-history"></i></button></td></tr>`;
            });
            if(foot) foot.innerHTML = `<tr><td class="p-4 uppercase text-[10px]">GENEL TOPLAM</td><td class="p-4 text-center text-slate-300">${tL}</td><td class="p-4">â‚º${tD}</td><td class="p-4">â‚º${tE}</td><td class="p-4">â‚º${tP}</td><td class="p-4">â‚º${tD + tE - tP}</td><td></td></tr>`;
            document.getElementById('acc-total-debt').innerText = `â‚º${tD + tE - tP}`;
            document.getElementById('acc-total-paid').innerText = `â‚º${tP}`;
        }

        function viewHistory(id) { currentHistoryStudentId = id; document.getElementById('acc-history-modal').classList.remove('hidden'); filterHistory(); }
        function filterHistory() {
            const q = document.getElementById('history-search-input').value.toLowerCase();
            const list = document.getElementById('acc-history-list');
            const filtered = appState.accounting.filter(a => String(a.studentId) === String(currentHistoryStudentId)).filter(a => a.desc.toLowerCase().includes(q) || a.date.toLowerCase().includes(q) || a.amount.toString().includes(q));
            list.innerHTML = filtered.map(a => `<div class="flex justify-between p-3 glass-card rounded border-l-4 ${a.type === 'payment' ? 'border-green-500' : 'border-orange-500'}"><div><p class="font-bold text-xs">${a.desc}</p><p class="text-[9px] opacity-50 text-slate-400">${a.date}</p></div><div class="flex items-center gap-2"><div><p class="font-bold text-xs">â‚º${a.amount}</p></div><button onclick="editTransaction('${a.id}')" class="text-blue-400 p-1.5 bg-slate-800 rounded hover:bg-slate-700 transition-all"><i class="fas fa-edit"></i></button><button onclick="deleteTransaction('${a.id}')" class="text-red-500 p-1.5 bg-slate-800 rounded hover:bg-slate-700 transition-all"><i class="fas fa-trash"></i></button></div></div>`).join('');
        }

        function editTransaction(id) { 
            const t = appState.accounting.find(a => String(a.id) === String(id)); 
            if (!t) return; 
            openTransactionModal(t.type); 
            document.getElementById('transaction-modal-title').innerText = "Ä°ÅŸlem DÃ¼zenle";
            document.getElementById('transaction-id').value = t.id; 
            document.getElementById('transaction-student').value = t.studentId; 
            document.getElementById('transaction-amount').value = t.amount; 
            document.getElementById('transaction-desc').value = t.desc; 
        }
        
        function deleteTransaction(id) { 
            if(!confirm("Silsin mi?")) return; 
            appState.accounting = appState.accounting.filter(a => String(a.id) !== String(id)); 
            filterHistory(); renderAccounting(); saveToCloud(); 
        }
        
        function openTransactionModal(type) { 
            const m = document.getElementById('transaction-modal'); 
            document.getElementById('transaction-form').reset(); 
            document.getElementById('transaction-id').value = ""; 
            document.getElementById('transaction-type').value = type; 
            document.getElementById('transaction-student').innerHTML = appState.students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            m.classList.remove('hidden'); 
        }

        function saveTransaction(e) { 
            e.preventDefault(); 
            const id = document.getElementById('transaction-id').value; 
            const sId = document.getElementById('transaction-student').value; 
            const type = document.getElementById('transaction-type').value; 
            const am = parseFloat(document.getElementById('transaction-amount').value); 
            const d = document.getElementById('transaction-desc').value; 
            if(id) { 
                const idx = appState.accounting.findIndex(a => String(a.id) === String(id)); 
                if(idx !== -1) { appState.accounting[idx] = { ...appState.accounting[idx], studentId: sId, amount: am, desc: d }; }
            } else { 
                appState.accounting.push({ id: Date.now().toString(), type, studentId: sId, amount: am, desc: d, date: new Date().toLocaleString('tr-TR') }); 
            } 
            closeModal('transaction-modal'); renderAccounting(); saveToCloud(); if(currentHistoryStudentId) filterHistory();
        }

        // --- STATS ENGINE & LESSON LOGS ---
        function loadStudentStats(id) { 
            const c = document.getElementById('stats-container'); 
            const e = document.getElementById('stats-empty-state'); 
            if(!id) { c.classList.add('hidden'); e.classList.remove('hidden'); return; } 
            c.classList.remove('hidden'); e.classList.add('hidden'); 
            
            // Log arama kutusunu sÄ±fÄ±rla
            document.getElementById('log-search-input').value = "";
            
            initStats(); 
            renderLessonLogs(id);
        }

        function filterLessonLogs() {
            const sId = document.getElementById('stats-student-select').value;
            if(!sId) return;
            renderLessonLogs(sId, document.getElementById('log-search-input').value.toLowerCase());
        }

        function renderLessonLogs(sId, query = "") {
            const list = document.getElementById('lesson-logs-list');
            const countLabel = document.getElementById('log-count');
            if(!list) return;
            
            const moodMap = { "1": "Berbat", "2": "ZayÄ±f", "3": "Normal", "4": "Ä°yi", "5": "Harika" };
            const moodIcons = { "1": "ğŸ˜¡", "2": "ğŸ˜•", "3": "ğŸ˜", "4": "ğŸ™‚", "5": "ğŸ˜Š" };

            const attendedLessons = appState.lessons
                .filter(l => String(l.studentId) === String(sId) && l.attendance)
                .map(l => {
                    // Exact date calculation: weekId (Monday) + day index
                    const dateObj = new Date(l.weekId);
                    dateObj.setDate(dateObj.getDate() + l.day);
                    return { ...l, exactDate: dateObj };
                })
                .sort((a, b) => b.exactDate - a.exactDate) // Sort by calculated exact date descending
                .filter(l => {
                    if(!query) return true;
                    const dateStr = l.exactDate.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' }).toLowerCase();
                    return dateStr.includes(query);
                });

            countLabel.innerText = `${attendedLessons.length} Ders`;
            
            if(attendedLessons.length === 0) {
                list.innerHTML = `<p class="text-center py-10 text-slate-500 text-xs italic">${query ? 'Arama kriterine uygun ders bulunamadÄ±.' : 'SeÃ§ilen Ã¶ÄŸrenciye ait katÄ±lÄ±m kaydÄ± bulunamadÄ±.'}</p>`;
                return;
            }

            list.innerHTML = attendedLessons.map(l => {
                const dateStr = l.exactDate.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
                return `
                    <div class="p-4 glass-card rounded-xl border-l-4 border-blue-500 bg-slate-800/20 hover:bg-slate-800/40 transition-all">
                        <div class="flex flex-wrap justify-between items-start gap-2 mb-3">
                            <div>
                                <p class="text-xs font-bold text-blue-400">${dateStr}</p>
                                <p class="text-[10px] text-slate-500 font-medium">${l.time} â€¢ ${(l.selectedBranches || []).join(', ')}</p>
                            </div>
                            <span class="text-[10px] bg-slate-700 px-2 py-1 rounded-lg text-slate-300 font-bold">
                                ${moodIcons[l.mood] || "â“"} ${moodMap[l.mood] || "Belirtilmedi"}
                            </span>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                            <div class="bg-black/20 p-2.5 rounded-lg border border-slate-700/30">
                                <p class="text-[9px] uppercase text-slate-500 font-bold mb-1.5">Ders NotlarÄ±</p>
                                <p class="text-xs text-slate-300 leading-relaxed">${l.notes || "Not bÄ±rakÄ±lmamÄ±ÅŸ."}</p>
                            </div>
                            <div class="bg-black/20 p-2.5 rounded-lg border border-slate-700/30">
                                <p class="text-[9px] uppercase text-slate-500 font-bold mb-1.5">HatÄ±rlatmalar</p>
                                <p class="text-xs text-yellow-500/80 leading-relaxed">${l.reminders || "HatÄ±rlatma yok."}</p>
                            </div>
                        </div>
                        ${l.tests && l.tests.length > 0 ? `
                        <div class="mt-3 pt-3 border-t border-slate-700/50">
                            <p class="text-[9px] uppercase text-slate-500 font-bold mb-2">Akademik Performans</p>
                            <div class="flex flex-wrap gap-2">
                                ${l.tests.map(t => `<span class="text-[10px] bg-slate-800 px-2.5 py-1 rounded border border-slate-700 text-blue-100 font-medium">${t.branch}: ${t.d}D / ${t.q}S</span>`).join('')}
                            </div>
                        </div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function initStats() {
            const chs = ['mood', 'subjectsSuccess', 'performance', 'reading', 'branchCount']; chs.forEach(c => { if(appState.charts[c]) appState.charts[c].destroy(); });
            const sId = document.getElementById('stats-student-select').value; if(!sId) return;
            const selectedBranch = document.getElementById('stats-branch-select').value;
            const basePool = appState.lessons.filter(l => String(l.studentId) === String(sId));
            let dPool = basePool; if(selectedBranch !== "ALL") { dPool = basePool.filter(l => (l.selectedBranches || []).includes(selectedBranch)); }
            appState.charts.mood = new Chart(document.getElementById('chart-mood'), { type: 'doughnut', data: { labels: ['Berbat','ZayÄ±f','Normal','Ä°yi','Harika'], datasets:[{ data: [1,2,3,4,5].map(m=>dPool.filter(l=>l.mood==m).length), backgroundColor:['#ef4444','#f97316','#eab308','#3b82f6','#22c55e'] }] }, options: { maintainAspectRatio:false } });
            const bcCounts = {}; appState.branches.forEach(b => bcCounts[b] = 0); basePool.forEach(l => (l.selectedBranches || []).forEach(b => { if(bcCounts[b] !== undefined) bcCounts[b]++; }));
            appState.charts.branchCount = new Chart(document.getElementById('chart-branch-count'), { type: 'bar', data: { labels: appState.branches, datasets:[{ label:'Ders SayÄ±sÄ±', data: appState.branches.map(b=>bcCounts[b]), backgroundColor:'#a855f7' }] }, options: { maintainAspectRatio:false } });
            const brS = {}; appState.branches.forEach(b => brS[b] = { t:0, c:0 }); basePool.forEach(l => (l.tests || []).forEach(t => { if(brS[t.branch]) { brS[t.branch].t += t.q; brS[t.branch].c += t.d; } }));
            appState.charts.subjectsSuccess = new Chart(document.getElementById('chart-subjects-success'), { type: 'bar', data: { labels: appState.branches, datasets:[{ label:'% BaÅŸarÄ±', data: appState.branches.map(b => brS[b].t > 0 ? (brS[b].c/brS[b].t)*100 : 0), backgroundColor:'#3b82f6' }] }, options: { maintainAspectRatio:false, scales:{y:{min:0,max:100}} } });
            const testHistory = []; basePool.forEach(l => (l.tests || []).forEach(t => { if(selectedBranch === "ALL" || t.branch === selectedBranch) testHistory.push({ r: t.q > 0 ? (t.d/t.q)*100 : 0 }); }));
            appState.charts.performance = new Chart(document.getElementById('chart-test-performance'), { type: 'line', data: { labels: testHistory.map((_,i)=>i+1), datasets:[{label:'% BaÅŸarÄ±', data: testHistory.map(x=>x.r), borderColor:'#3b82f6', tension:0.4, fill:true, backgroundColor:'rgba(59, 130, 246, 0.1)'}] }, options: { maintainAspectRatio:false, scales:{y:{min:0,max:100}} } });
            const p = dPool.filter(l => l.words || l.comprehension).slice(-10);
            appState.charts.reading = new Chart(document.getElementById('chart-reading'), { type: 'line', data: { labels: p.map((_,i)=>i+1), datasets:[{label:'Kelime', data:p.map(l=>l.words||0), borderColor:'#a855f7'}, {label:'% Anlama', data:p.map(l=>l.comprehension||0), borderColor:'#22c55e'}] }, options: { maintainAspectRatio:false } });
        }

        // --- MEDIA OPS ---
        async function compressImg(b64, w = 150) { return new Promise(r => { const i = new Image(); i.src = b64; i.onload = () => { const c = document.createElement('canvas'); const s = w/i.width; c.width = w; c.height = i.height*s; const ctx = c.getContext('2d'); ctx.drawImage(i,0,0,c.width,c.height); r(c.toDataURL('image/jpeg', 0.5)); }; }); }
        async function handleStudentPhoto(ev) { const f = ev.target.files[0]; if(!f) return; const rd = new FileReader(); rd.onload = async (e) => { const opt = await compressImg(e.target.result, 120); tempStudentPhoto = opt; document.getElementById('student-photo-preview').innerHTML = `<img src="${opt}" class="w-full h-full object-cover">`; }; rd.readAsDataURL(f); }
        async function handleLessonMedia(ev) { const fs = ev.target.files; const pr = document.getElementById('lesson-media-preview'); for(let f of fs) { const rd = new FileReader(); rd.onload = async (e) => { let d = e.target.result; if(f.type.startsWith('image/')) d = await compressImg(d, 200); tempLessonMedia.push({data:d, type:f.type}); const el = document.createElement('div'); el.innerHTML = `<img src="${d}" class="media-preview">`; pr.appendChild(el); }; rd.readAsDataURL(f); } }

        // --- PDF & OTHER ---
        async function exportFullCalendarPDF() { html2canvas(document.getElementById('calendar-grid')).then(canvas => { const pdf = new jspdf.jsPDF('l', 'mm', 'a4'); pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 10, 10, 277, 150); pdf.save('Haftalik_Program.pdf'); }); }
        function exportSingleLessonPDF() { alert("HazÄ±rlanÄ±yor..."); }
        async function exportStatsPDF() { const el = document.getElementById('stats-container'); html2canvas(el).then(canvas => { const pdf = new jspdf.jsPDF('p', 'mm', 'a4'); const imgWidth = pdf.internal.pageSize.getWidth() - 20; pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 10, 10, imgWidth, (canvas.height * imgWidth) / canvas.width); pdf.save('Gelisim_Raporu.pdf'); }); }

        window.onload = fetchData;
    </script>
</body>
</html>
