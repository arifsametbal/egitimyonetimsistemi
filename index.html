<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EYS - EÄŸitim YÃ¶netim Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .lesson-node { transition: all 0.2s; cursor: pointer; border-left: 4px solid #334155; }
        .lesson-node:hover { transform: scale(1.02); }
        .attendance-true { border-left-color: #10b981; background: rgba(16, 185, 129, 0.1); }
        .attendance-false { border-left-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        input, select, textarea { background: #1e293b !important; color: white !important; border: 1px solid #334155 !important; border-radius: 0.5rem; padding: 0.5rem; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .branch-chip { cursor: pointer; padding: 4px 10px; border-radius: 99px; border: 1px solid #334155; font-size: 11px; transition: all 0.2s; }
        .branch-chip.active { background: #3b82f6; border-color: #3b82f6; color: white; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .media-preview { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 1px solid #334155; }
    </style>
</head>
<body class="min-h-screen pb-20 md:pb-0">

    <div id="loader" class="loading-overlay">
        <i class="fas fa-circle-notch animate-spin text-4xl text-blue-500 mb-4"></i>
        <p class="text-sm font-medium" id="loader-text">Veriler EÅŸitleniyor...</p>
    </div>

    <!-- Ãœst Navigasyon -->
    <nav class="sticky top-0 z-50 glass-card px-4 py-3 flex justify-between items-center">
        <h1 class="text-xl font-bold bg-gradient-to-r from-blue-400 to-indigo-500 bg-clip-text text-transparent">
            <i class="fas fa-graduation-cap mr-2"></i>EYS Pro
        </h1>
        <div class="hidden md:flex space-x-6">
            <button onclick="switchTab('calendar')" class="nav-link tab-active" id="nav-calendar">Takvim</button>
            <button onclick="switchTab('students')" class="nav-link" id="nav-students">Ã–ÄŸrenciler</button>
            <button onclick="switchTab('stats')" class="nav-link" id="nav-stats">Ä°statistik</button>
            <button onclick="switchTab('accounting')" class="nav-link" id="nav-accounting">Muhasebe</button>
        </div>
        <div id="sync-status" class="text-xs text-slate-400">
            <i class="fas fa-check-circle text-green-500 mr-1"></i> BaÄŸlÄ±
        </div>
    </nav>

    <!-- Ana Ä°Ã§erik -->
    <main class="container mx-auto p-4 max-w-6xl">
        <!-- TAKVÄ°M BÃ–LÃœMÃœ -->
        <section id="section-calendar" class="tab-content">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <div class="flex items-center space-x-4">
                    <button class="p-2 glass-card rounded-lg" onclick="changeWeek(-1)"><i class="fas fa-chevron-left"></i></button>
                    <h2 id="calendar-date-range" class="text-lg font-semibold uppercase tracking-tight text-center min-w-[200px]">Hafta</h2>
                    <button class="p-2 glass-card rounded-lg" onclick="changeWeek(1)"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="flex gap-2 w-full md:w-auto">
                    <input type="week" id="calendar-week-picker" class="text-sm" onchange="jumpToWeek(this.value)">
                    <button onclick="exportFullCalendarPDF()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm flex-1 md:flex-none">
                        <i class="fas fa-file-pdf mr-2"></i>ProgramÄ± Ä°ndir
                    </button>
                </div>
            </div>
            <div id="calendar-grid" class="grid grid-cols-1 md:grid-cols-7 gap-4"></div>
        </section>

        <!-- Ã–ÄRENCÄ°LER BÃ–LÃœMÃœ -->
        <section id="section-students" class="tab-content hidden">
            <div class="flex flex-col md:flex-row justify-between mb-6 gap-4">
                <div class="relative flex-1">
                    <i class="fas fa-search absolute left-3 top-3 text-slate-500"></i>
                    <input type="text" placeholder="Ã–ÄŸrenci adÄ± ile ara..." class="w-full pl-10" onkeyup="filterStudents(this.value)">
                </div>
                <button onclick="openStudentModal()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg">
                    <i class="fas fa-user-plus mr-2"></i>Yeni Ã–ÄŸrenci
                </button>
            </div>
            <div id="student-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            <div id="empty-student-msg" class="text-center py-20 text-slate-500 hidden">
                <i class="fas fa-users-slash text-4xl mb-4"></i>
                <p>KayÄ±tlÄ± Ã¶ÄŸrenci bulunamadÄ±.</p>
            </div>
        </section>

        <!-- Ä°STATÄ°STÄ°K BÃ–LÃœMÃœ -->
        <section id="section-stats" class="tab-content hidden">
            <div class="mb-6 flex flex-wrap gap-4 items-center">
                <select id="stats-student-select" class="w-full md:w-64" onchange="loadStudentStats(this.value)">
                    <option value="">Ã–ÄŸrenci SeÃ§iniz</option>
                </select>
                <select id="stats-branch-select" class="w-full md:w-64" onchange="initStats()">
                    <option value="ALL">TÃ¼m BranÅŸlar (Ã–ÄŸrenci OrtalamasÄ±)</option>
                </select>
                <button onclick="exportStatsPDF()" class="bg-purple-600 text-white px-4 py-2 rounded-lg w-full md:w-auto">
                    <i class="fas fa-chart-pie mr-2"></i>GeliÅŸim Raporu (PDF)
                </button>
            </div>
            <div id="stats-empty-state" class="text-center py-20 text-slate-500">
                <i class="fas fa-chart-line text-5xl mb-4"></i>
                <p>Ä°statistikleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in lÃ¼tfen bir Ã¶ÄŸrenci seÃ§in.</p>
            </div>
            <div id="stats-container" class="grid grid-cols-1 md:grid-cols-2 gap-6 hidden">
                <div class="glass-card p-4 rounded-xl md:col-span-2">
                    <h3 id="chart-main-title" class="font-bold mb-4 text-xs text-slate-400 uppercase tracking-widest">Test BaÅŸarÄ± GeliÅŸimi (%)</h3>
                    <div class="h-[300px]"><canvas id="chart-test-performance"></canvas></div>
                </div>
                <div class="glass-card p-4 rounded-xl md:col-span-2">
                    <h3 class="font-bold mb-4 text-xs text-slate-400 uppercase tracking-widest">BranÅŸ BazlÄ± Ders SayÄ±sÄ±</h3>
                    <div class="h-[300px]"><canvas id="chart-branch-count"></canvas></div>
                </div>
                <div class="glass-card p-4 rounded-xl">
                    <h3 class="font-bold mb-4 text-xs text-slate-400 uppercase tracking-widest">Duygu Durumu DaÄŸÄ±lÄ±mÄ±</h3>
                    <div class="h-[250px]"><canvas id="chart-mood"></canvas></div>
                </div>
                <div class="glass-card p-4 rounded-xl">
                    <h3 class="font-bold mb-4 text-xs text-slate-400 uppercase tracking-widest">BranÅŸ BazlÄ± Ortalama BaÅŸarÄ± (%)</h3>
                    <div class="h-[250px]"><canvas id="chart-subjects-success"></canvas></div>
                </div>
                <div class="glass-card p-4 rounded-xl md:col-span-2">
                    <h3 class="font-bold mb-4 text-xs text-slate-400 uppercase tracking-widest">Okuma HÄ±zÄ± & Anlama OranÄ± GeliÅŸimi</h3>
                    <div class="h-[300px]"><canvas id="chart-reading"></canvas></div>
                </div>
            </div>
        </section>

        <!-- MUHASEBE BÃ–LÃœMÃœ -->
        <section id="section-accounting" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 text-center">
                <div class="glass-card p-4 rounded-xl border-t-4 border-blue-500">
                    <p class="text-[10px] text-slate-400 uppercase">Toplam Ders Borcu</p>
                    <h4 id="acc-total-debt" class="text-lg font-bold">â‚º0</h4>
                </div>
                <div class="glass-card p-4 rounded-xl border-t-4 border-orange-500">
                    <p class="text-[10px] text-slate-400 uppercase">Toplam Harcama</p>
                    <h4 id="acc-total-expense" class="text-lg font-bold">â‚º0</h4>
                </div>
                <div class="glass-card p-4 rounded-xl border-t-4 border-green-500">
                    <p class="text-[10px] text-slate-400 uppercase">Toplam Tahsilat</p>
                    <h4 id="acc-total-paid" class="text-lg font-bold">â‚º0</h4>
                </div>
                <div class="glass-card p-4 rounded-xl border-t-4 border-purple-500">
                    <p class="text-[10px] text-slate-400 uppercase">Net Bakiye</p>
                    <h4 id="acc-balance" class="text-lg font-bold">â‚º0</h4>
                </div>
            </div>

            <div class="flex flex-col md:flex-row justify-between mb-4 gap-4">
                <div class="flex space-x-2">
                    <button onclick="openTransactionModal('payment')" class="bg-green-600 px-4 py-2 rounded text-sm font-bold"><i class="fas fa-plus-circle mr-2"></i>Ã–deme Al</button>
                    <button onclick="openTransactionModal('expense')" class="bg-red-600 px-4 py-2 rounded text-sm font-bold"><i class="fas fa-shopping-cart mr-2"></i>Harcama Gir</button>
                </div>
                <div class="flex gap-2">
                    <input type="text" placeholder="Tabloda ara..." class="text-sm px-3" onkeyup="renderAccounting(this.value)">
                    <button onclick="exportAccountingPDF_Standard()" class="bg-slate-700 px-4 py-2 rounded text-sm"><i class="fas fa-print"></i></button>
                </div>
            </div>

            <div class="overflow-x-auto glass-card rounded-xl">
                <table class="w-full text-left text-sm">
                    <thead>
                        <tr class="bg-slate-800/50 text-[10px] uppercase text-slate-400">
                            <th class="p-4">Ã–ÄŸrenci</th>
                            <th class="p-4 text-center">Ders</th>
                            <th class="p-4">Ders Borcu</th>
                            <th class="p-4">Harcamalar</th>
                            <th class="p-4">Ã–denen</th>
                            <th class="p-4 font-bold text-white">Kalan Bakiye</th>
                            <th class="p-4 text-center">Detay</th>
                        </tr>
                    </thead>
                    <tbody id="accounting-table-body"></tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- MODALLAR -->
    <!-- Ders ModalÄ± -->
    <div id="lesson-modal" class="fixed inset-0 bg-black/90 hidden z-[60] flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-2xl max-h-[95vh] overflow-y-auto rounded-2xl p-6 relative">
            <button onclick="closeModal('lesson-modal')" class="absolute top-4 right-4 text-slate-400"><i class="fas fa-times text-xl"></i></button>
            <h2 class="text-xl font-bold mb-6 border-b border-slate-700 pb-2">Ders AyrÄ±ntÄ±larÄ±</h2>
            <form id="lesson-form" class="space-y-6" onsubmit="saveLesson(event)">
                <input type="hidden" id="lesson-id">
                <input type="hidden" id="lesson-day">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] mb-1 text-slate-500 uppercase">Ã–ÄŸrenci</label>
                        <select id="lesson-student" class="w-full" required></select>
                    </div>
                    <div>
                        <label class="block text-[10px] mb-1 text-slate-500 uppercase">Zamanlama & KatÄ±lÄ±m</label>
                        <div class="flex gap-2">
                            <input type="time" id="lesson-time" class="flex-1" required>
                            <label class="flex items-center space-x-2 px-3 glass-card rounded cursor-pointer select-none">
                                <input type="checkbox" id="lesson-attendance" class="w-4 h-4 rounded text-blue-600">
                                <span class="text-xs">Burada</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] mb-2 text-slate-500 uppercase">BranÅŸ SeÃ§imi</label>
                    <div id="branch-container" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="bg-slate-800/40 p-4 rounded-xl border border-slate-700/50">
                    <div class="flex justify-between items-center mb-4">
                        <label class="text-[10px] text-slate-500 uppercase font-bold">Akademik Test GiriÅŸleri</label>
                        <button type="button" onclick="addTestRow()" class="text-[10px] bg-blue-500 text-white px-3 py-1 rounded-full hover:bg-blue-600">
                            <i class="fas fa-plus mr-1"></i>Test Ekle
                        </button>
                    </div>
                    <div id="test-rows-container" class="space-y-2"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] mb-1 text-slate-500 uppercase">HÄ±zlÄ± Okuma PerformansÄ±</label>
                        <div class="flex gap-2">
                            <input type="number" placeholder="Dak./Kelime" id="l-words" class="w-full">
                            <input type="number" placeholder="Anlama %" id="l-comp" class="w-full">
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] mb-2 text-slate-500 uppercase">GÃ¶zlemlenen Duygu Durumu</label>
                        <div class="flex gap-3 justify-between">
                            <label class="cursor-pointer text-3xl opacity-30 hover:opacity-100 transition-all"><input type="radio" name="mood" value="1" class="hidden peer"> <span class="peer-checked:opacity-100 peer-checked:scale-125 inline-block">ğŸ˜¡</span></label>
                            <label class="cursor-pointer text-3xl opacity-30 hover:opacity-100 transition-all"><input type="radio" name="mood" value="2" class="hidden peer"> <span class="peer-checked:opacity-100 peer-checked:scale-125 inline-block">ğŸ˜•</span></label>
                            <label class="cursor-pointer text-3xl opacity-30 hover:opacity-100 transition-all"><input type="radio" name="mood" value="3" class="hidden peer"> <span class="peer-checked:opacity-100 peer-checked:scale-125 inline-block">ğŸ˜</span></label>
                            <label class="cursor-pointer text-3xl opacity-30 hover:opacity-100 transition-all"><input type="radio" name="mood" value="4" class="hidden peer"> <span class="peer-checked:opacity-100 peer-checked:scale-125 inline-block">ğŸ™‚</span></label>
                            <label class="cursor-pointer text-3xl opacity-30 hover:opacity-100 transition-all"><input type="radio" name="mood" value="5" class="hidden peer"> <span class="peer-checked:opacity-100 peer-checked:scale-125 inline-block">ğŸ˜Š</span></label>
                        </div>
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="block text-[10px] text-slate-500 uppercase">Ders MedyasÄ± (GÃ¶rsel / Video)</label>
                    <input type="file" id="lesson-media-input" accept="image/*,video/*" multiple class="text-xs" onchange="handleLessonMedia(event)">
                    <div id="lesson-media-preview" class="flex flex-wrap gap-2 mt-2"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <textarea id="lesson-notes" placeholder="Ders NotlarÄ±..." class="w-full h-24 text-sm"></textarea>
                    <textarea id="lesson-reminders" placeholder="HatÄ±rlatmalar..." class="w-full h-24 text-sm border-dashed border-yellow-500/30"></textarea>
                </div>
                <div class="flex justify-between items-center pt-6 border-t border-slate-700">
                    <div class="flex gap-4">
                        <button type="button" onclick="exportSingleLessonPDF()" class="text-blue-400 text-sm hover:underline"><i class="fas fa-file-download mr-1"></i>PDF</button>
                        <button id="btn-lesson-delete" type="button" onclick="deleteCurrentLesson()" class="text-red-500 text-sm hover:underline hidden"><i class="fas fa-trash-alt mr-1"></i>Dersi Sil</button>
                    </div>
                    <div class="space-x-3">
                        <button type="button" onclick="closeModal('lesson-modal')" class="bg-slate-800 px-5 py-2 rounded-lg text-sm">VazgeÃ§</button>
                        <button type="submit" class="bg-blue-600 px-8 py-2 rounded-lg font-bold text-sm">Kaydet</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Ä°ÅŸlem GeÃ§miÅŸi ModalÄ± -->
    <div id="acc-history-modal" class="fixed inset-0 bg-black/90 hidden z-[60] flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-2xl rounded-2xl p-6 relative max-h-[80vh] overflow-hidden flex flex-col">
            <button onclick="closeModal('acc-history-modal')" class="absolute top-4 right-4 text-slate-400"><i class="fas fa-times"></i></button>
            <h2 id="acc-history-title" class="text-xl font-bold mb-4">Ä°ÅŸlem GeÃ§miÅŸi</h2>
            <div class="relative mb-4">
                <i class="fas fa-search absolute left-3 top-3 text-slate-500 text-xs"></i>
                <input type="text" id="history-search-input" placeholder="Arama yapÄ±n..." class="w-full pl-9 text-xs" onkeyup="filterHistory()">
            </div>
            <div id="acc-history-list" class="space-y-3 overflow-y-auto flex-1 pr-2"></div>
        </div>
    </div>

    <!-- Ã–ÄŸrenci ModalÄ± -->
    <div id="student-modal" class="fixed inset-0 bg-black/90 hidden z-[60] flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-lg rounded-2xl p-6 relative overflow-y-auto max-h-[90vh]">
            <button onclick="closeModal('student-modal')" class="absolute top-4 right-4 text-slate-400"><i class="fas fa-times"></i></button>
            <h2 id="student-modal-title" class="text-xl font-bold mb-6">Ã–ÄŸrenci KaydÄ±</h2>
            <form id="student-form" class="space-y-4" onsubmit="saveStudent(event)">
                <input type="hidden" id="student-id">
                <div class="flex flex-col items-center mb-4">
                    <div id="student-photo-preview" class="w-24 h-24 rounded-full bg-slate-800 border-2 border-dashed border-slate-600 flex items-center justify-center overflow-hidden">
                        <i class="fas fa-user text-3xl text-slate-600"></i>
                    </div>
                    <input type="file" id="student-photo-input" accept="image/*" class="text-[10px] w-48 mt-2" onchange="handleStudentPhoto(event)">
                </div>
                <div>
                    <label class="block text-xs mb-1 text-slate-500 uppercase">Tam AdÄ±</label>
                    <input type="text" id="student-name" class="w-full" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs mb-1 text-slate-500 uppercase">SÄ±nÄ±f</label>
                        <select id="student-grade" class="w-full">
                            <option value="1">1. SÄ±nÄ±f</option><option value="2">2. SÄ±nÄ±f</option><option value="3">3. SÄ±nÄ±f</option><option value="4">4. SÄ±nÄ±f</option><option value="5">5. SÄ±nÄ±f</option><option value="6">6. SÄ±nÄ±f</option><option value="7">7. SÄ±nÄ±f</option><option value="8">8. SÄ±nÄ±f</option><option value="9">9. SÄ±nÄ±f</option><option value="10">10. SÄ±nÄ±f</option><option value="11">11. SÄ±nÄ±f</option><option value="12">12. SÄ±nÄ±f</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs mb-1 text-slate-500 uppercase">Birim Ãœcret (â‚º)</label>
                        <input type="number" id="student-price" class="w-full" required>
                    </div>
                </div>
                <div>
                    <label class="block text-xs mb-1 text-slate-500 uppercase">EÄŸitmen NotlarÄ±</label>
                    <textarea id="student-notes" class="w-full h-24"></textarea>
                </div>
                <div id="price-log-container" class="hidden bg-slate-800/50 p-3 rounded-lg mt-4">
                    <p class="text-[9px] font-bold text-slate-400 uppercase mb-2">Ãœcret GeÃ§miÅŸi</p>
                    <ul id="price-log-list" class="text-[10px] text-slate-400 space-y-1"></ul>
                </div>
                <button type="submit" class="w-full bg-green-600 py-3 rounded-xl font-bold mt-4">Kaydet</button>
            </form>
        </div>
    </div>

    <!-- Ä°ÅŸlem ModalÄ± -->
    <div id="transaction-modal" class="fixed inset-0 bg-black/90 hidden z-[60] flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-md rounded-2xl p-6 relative">
            <button onclick="closeModal('transaction-modal')" class="absolute top-4 right-4 text-slate-400"><i class="fas fa-times"></i></button>
            <h2 id="transaction-modal-title" class="text-xl font-bold mb-6">Ä°ÅŸlem GiriÅŸi</h2>
            <form id="transaction-form" class="space-y-4" onsubmit="saveTransaction(event)">
                <input type="hidden" id="transaction-id">
                <input type="hidden" id="transaction-type">
                <div>
                    <label class="block text-xs mb-1 text-slate-500 uppercase">Ã–ÄŸrenci</label>
                    <select id="transaction-student" class="w-full" required></select>
                </div>
                <div>
                    <label class="block text-xs mb-1 text-slate-500 uppercase">Tutar (â‚º)</label>
                    <input type="number" id="transaction-amount" class="w-full" required>
                </div>
                <div>
                    <label class="block text-xs mb-1 text-slate-500 uppercase">AÃ§Ä±klama</label>
                    <input type="text" id="transaction-desc" class="w-full" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 py-3 rounded-xl font-bold mt-4">Kaydet</button>
            </form>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzgqFZut49ZI6TwqKPYIR9Vaa4HNpgA6InHarWwzqZ40wNucWpYst_jVjGHpcZPIeZ8/exec";
        
        let appState = {
            currentTab: 'calendar',
            students: [],
            lessons: [],
            accounting: [],
            priceLogs: [],
            currentWeekOffset: 0,
            branches: ["Matematik", "TÃ¼rkÃ§e", "Hayat Bilgisi", "Sosyal Bilgiler", "Fen Bilimleri", "Ä°ngilizce", "Bilsem", "Robotik Kodlama", "AkÄ±l ve Zeka OyunlarÄ±"],
            charts: { mood: null, subjectsSuccess: null, performance: null, reading: null, branchCount: null }
        };

        let tempStudentPhoto = "";
        let tempLessonMedia = [];
        let currentHistoryStudentId = null;

        // --- CORE FUNCTIONS ---
        async function fetchData() {
            if(!API_URL) return;
            try {
                const response = await fetch(API_URL);
                const rawData = await response.text();
                const data = JSON.parse(rawData);
                if(data && typeof data === 'object') appState = {...appState, ...data};
                document.getElementById('loader').classList.add('hidden');
                updateStatsSelect();
                initCalendar();
                renderStudents();
            } catch(e) {
                console.error("Fetch hatasÄ±:", e);
                document.getElementById('loader').classList.add('hidden');
                initCalendar();
            }
        }

        async function saveToCloud() {
            if(!API_URL) return;
            document.getElementById('sync-status').innerHTML = '<i class="fas fa-sync-alt animate-spin text-blue-400 mr-1"></i> Kaydediliyor...';
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(appState)
                });
                document.getElementById('sync-status').innerHTML = '<i class="fas fa-check-circle text-green-500 mr-1"></i> Senkronize';
            } catch(e) {
                document.getElementById('sync-status').innerHTML = '<i class="fas fa-times-circle text-red-500 mr-1"></i> KayÄ±t HatasÄ±';
            }
        }

        function updateStatsSelect() { 
            const select = document.getElementById('stats-student-select'); 
            if (select) {
                select.innerHTML = '<option value="">Ã–ÄŸrenci SeÃ§iniz</option>' + 
                    appState.students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            }
        }

        function getWeekId() {
            const today = new Date();
            const dayNum = today.getDay();
            const monday = new Date(today);
            monday.setDate(today.getDate() - (dayNum === 0 ? 6 : dayNum - 1) + (appState.currentWeekOffset * 7));
            monday.setHours(0,0,0,0);
            const y = monday.getFullYear();
            const m = String(monday.getMonth() + 1).padStart(2, '0');
            const d = String(monday.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        // --- IMAGE OPTIMIZER ---
        async function compressImage(base64Str, maxWidth = 200) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = base64Str;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = maxWidth / img.width;
                    if (scale >= 1) return resolve(base64Str);
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
            });
        }

        // --- HANDLERS ---
        async function handleStudentPhoto(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const optimized = await compressImage(e.target.result, 180);
                tempStudentPhoto = optimized;
                document.getElementById('student-photo-preview').innerHTML = `<img src="${optimized}" class="w-full h-full object-cover">`;
            };
            reader.readAsDataURL(file);
        }

        async function handleLessonMedia(event) {
            const files = event.target.files;
            const preview = document.getElementById('lesson-media-preview');
            for (let file of files) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    let data = e.target.result;
                    if (file.type.startsWith('image/')) data = await compressImage(data, 300);
                    tempLessonMedia.push({ data, type: file.type });
                    const el = document.createElement('div');
                    el.className = "relative";
                    el.innerHTML = file.type.startsWith('video/') ? `<video src="${data}" class="media-preview"></video>` : `<img src="${data}" class="media-preview">`;
                    preview.appendChild(el);
                };
                reader.readAsDataURL(file);
            }
        }

        // --- UI LOGIC ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`section-${tabId}`).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('tab-active'));
            document.getElementById(`nav-${tabId}`)?.classList.add('tab-active');
            if(tabId === 'stats') initStats();
            if(tabId === 'students') renderStudents();
            if(tabId === 'accounting') renderAccounting();
        }

        function initCalendar() {
            const grid = document.getElementById('calendar-grid');
            if(!grid) return; grid.innerHTML = '';
            const days = ['Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi', 'Pazar'];
            updateCalendarRange();
            days.forEach((day, index) => {
                const dayEl = document.createElement('div');
                dayEl.className = 'glass-card p-3 rounded-xl min-h-[300px] flex flex-col';
                dayEl.innerHTML = `<div class="mb-3 pb-2 border-b border-slate-700 font-bold text-xs text-blue-400 uppercase">${day}</div><div id="day-lessons-${index}" class="flex-1 space-y-2"></div><button onclick="openLessonModal(${index})" class="mt-4 w-full py-2 border border-dashed border-slate-600 rounded-lg text-[9px] hover:bg-slate-800 text-slate-500 font-bold">YENÄ° DERS</button>`;
                grid.appendChild(dayEl);
            });
            renderAllLessons();
        }

        function updateCalendarRange() {
            const today = new Date();
            const dayNum = today.getDay();
            const monday = new Date(today);
            monday.setDate(today.getDate() - (dayNum === 0 ? 6 : dayNum - 1) + (appState.currentWeekOffset * 7));
            const last = new Date(monday); last.setDate(monday.getDate() + 6);
            const opt = { day: 'numeric', month: 'long' };
            document.getElementById('calendar-date-range').innerText = `${monday.toLocaleDateString('tr-TR', opt)} - ${last.toLocaleDateString('tr-TR', opt)} ${last.getFullYear()}`;
        }

        function changeWeek(off) { appState.currentWeekOffset += off; initCalendar(); }
        function jumpToWeek(v) { if(!v) return; const parts = v.split('-W'); const year = parseInt(parts[0]); const week = parseInt(parts[1]); const sel = new Date(year, 0, 1 + (week - 1) * 7); const now = new Date(); now.setHours(0,0,0,0); const diff = Math.round((sel - now) / (7 * 24 * 60 * 60 * 1000)); appState.currentWeekOffset = Math.floor(diff / 7); initCalendar(); }

        function renderAllLessons() {
            const currentWeekId = getWeekId();
            document.querySelectorAll('[id^="day-lessons-"]').forEach(el => el.innerHTML = '');
            appState.lessons.forEach(l => {
                if (l.weekId !== currentWeekId) return;
                const container = document.getElementById(`day-lessons-${l.day}`);
                if(container) {
                    const node = document.createElement('div');
                    node.className = `lesson-node p-2 rounded-lg text-[10px] ${l.attendance ? 'attendance-true' : 'attendance-false'}`;
                    node.onclick = () => openLessonModal(l.day, l.id);
                    node.innerHTML = `<div class="font-bold truncate">${l.time} - ${getStudentName(l.studentId)}</div><div class="text-[9px] text-slate-400 mt-1 truncate">${(l.selectedBranches || []).join(', ')}</div>`;
                    container.appendChild(node);
                }
            });
        }

        function openLessonModal(day, id = null) {
            const modal = document.getElementById('lesson-modal');
            const form = document.getElementById('lesson-form');
            form.reset();
            tempLessonMedia = [];
            document.getElementById('lesson-media-preview').innerHTML = '';
            document.getElementById('lesson-student').innerHTML = appState.students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            const bc = document.getElementById('branch-container');
            bc.innerHTML = appState.branches.map(b => `<div class="branch-chip" onclick="toggleBranchChip(this)">${b}</div>`).join('');
            document.getElementById('test-rows-container').innerHTML = '';
            document.getElementById('lesson-day').value = day;
            document.getElementById('lesson-id').value = id || "";
            const deleteBtn = document.getElementById('btn-lesson-delete');
            if(id) {
                deleteBtn.classList.remove('hidden');
                const l = appState.lessons.find(x => String(x.id) === String(id));
                if (l) {
                    document.getElementById('lesson-student').value = l.studentId;
                    document.getElementById('lesson-time').value = l.time;
                    document.getElementById('lesson-attendance').checked = l.attendance;
                    document.getElementById('l-words').value = l.words || "";
                    document.getElementById('l-comp').value = l.comprehension || "";
                    document.getElementById('lesson-notes').value = l.notes || "";
                    document.getElementById('lesson-reminders').value = l.reminders || "";
                    if(l.mood) { const r = form.querySelector(`input[name="mood"][value="${l.mood}"]`); if(r) r.checked = true; }
                    (l.selectedBranches || []).forEach(bName => {
                        const chip = [...bc.children].find(c => c.innerText === bName);
                        if(chip) chip.classList.add('active');
                    });
                    (l.tests || []).forEach(t => addTestRow(t));
                    if (l.media) {
                        tempLessonMedia = [...l.media];
                        l.media.forEach(m => {
                            const el = document.createElement('div');
                            el.innerHTML = m.type.startsWith('video/') ? `<video src="${m.data}" class="media-preview"></video>` : `<img src="${m.data}" class="media-preview">`;
                            document.getElementById('lesson-media-preview').appendChild(el);
                        });
                    }
                }
            } else deleteBtn.classList.add('hidden');
            modal.classList.remove('hidden');
        }

        function addTestRow(data = null) {
            const container = document.getElementById('test-rows-container');
            const row = document.createElement('div');
            row.className = 'grid grid-cols-6 gap-2 items-center';
            row.innerHTML = `<select class="text-[10px] col-span-2 py-1">${appState.branches.map(b => `<option ${data?.branch === b ? 'selected' : ''}>${b}</option>`).join('')}</select><input type="number" placeholder="S" class="text-[10px] py-1" value="${data?.q || ''}"><input type="number" placeholder="D" class="text-[10px] py-1" value="${data?.d || ''}"><input type="number" placeholder="Y" class="text-[10px] py-1" value="${data?.w || ''}"><input type="number" placeholder="B" class="text-[10px] py-1" value="${data?.e || ''}"><button type="button" onclick="this.parentElement.remove()" class="text-red-500 text-xs"><i class="fas fa-trash-alt"></i></button>`;
            container.appendChild(row);
        }

        function saveLesson(event) {
            event.preventDefault();
            const id = document.getElementById('lesson-id').value;
            const branches = [...document.querySelectorAll('.branch-chip.active')].map(c => c.innerText);
            const tests = Array.from(document.getElementById('test-rows-container').children).map(row => {
                const inputs = row.querySelectorAll('input');
                return { branch: row.querySelector('select').value, q: parseInt(inputs[0].value || 0), d: parseInt(inputs[1].value || 0), w: parseInt(inputs[2].value || 0), e: parseInt(inputs[3].value || 0) };
            });
            const lesson = { id: id || Date.now().toString(), weekId: getWeekId(), studentId: document.getElementById('lesson-student').value, day: parseInt(document.getElementById('lesson-day').value), time: document.getElementById('lesson-time').value, attendance: document.getElementById('lesson-attendance').checked, selectedBranches: branches, tests, media: tempLessonMedia, words: document.getElementById('l-words').value, comprehension: document.getElementById('l-comp').value, mood: document.querySelector('input[name="mood"]:checked')?.value || null, notes: document.getElementById('lesson-notes').value, reminders: document.getElementById('lesson-reminders').value, unitPrice: getStudentPrice(document.getElementById('lesson-student').value) };
            if(id) {
                const idx = appState.lessons.findIndex(x => String(x.id) === String(id));
                if (idx !== -1) appState.lessons[idx] = lesson;
            } else appState.lessons.push(lesson);
            closeModal('lesson-modal'); renderAllLessons(); saveToCloud();
        }

        function deleteCurrentLesson() {
            const id = document.getElementById('lesson-id').value;
            if(!id || !confirm("Emin misiniz?")) return;
            appState.lessons = appState.lessons.filter(l => String(l.id) !== String(id));
            closeModal('lesson-modal'); renderAllLessons(); saveToCloud();
        }

        function toggleBranchChip(el) { el.classList.toggle('active'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        // --- STUDENT & ACCOUNTING ---
        function saveStudent(e) {
            e.preventDefault();
            const id = document.getElementById('student-id').value;
            const price = parseFloat(document.getElementById('student-price').value);
            const data = { id: id || Date.now().toString(), photo: tempStudentPhoto, name: document.getElementById('student-name').value, grade: document.getElementById('student-grade').value, price, notes: document.getElementById('student-notes').value };
            if(id) {
                const idx = appState.students.findIndex(x => String(x.id) === String(id));
                if(appState.students[idx].price !== price) appState.priceLogs.push({ studentId: id, old: appState.students[idx].price, new: price, date: new Date().toLocaleString() });
                appState.students[idx] = data;
            } else appState.students.push(data);
            closeModal('student-modal'); renderStudents(); updateStatsSelect(); saveToCloud();
        }

        function renderStudents() {
            const list = document.getElementById('student-list');
            if(!list) return; list.innerHTML = '';
            appState.students.forEach(s => {
                const card = document.createElement('div');
                card.className = 'glass-card p-4 rounded-xl flex gap-3 border-l-4 border-blue-500';
                card.innerHTML = `<div class="w-16 h-16 rounded bg-slate-800 overflow-hidden">${s.photo ? `<img src="${s.photo}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-slate-600"><i class="fas fa-user"></i></div>`}</div><div class="flex-1"><div class="flex justify-between"><span>${s.grade}. SÄ±nÄ±f</span><div><button onclick="openStudentModal('${s.id}')" class="text-blue-400 mr-2"><i class="fas fa-edit"></i></button><button onclick="deleteStudent('${s.id}')" class="text-red-400"><i class="fas fa-trash"></i></button></div></div><h3 class="font-bold">${s.name}</h3><p class="text-green-500">â‚º${s.price}</p></div>`;
                list.appendChild(card);
            });
        }

        function deleteStudent(id) {
            if(!confirm("Emin misiniz?")) return;
            appState.students = appState.students.filter(s => String(s.id) !== String(id));
            appState.lessons = appState.lessons.filter(l => String(l.studentId) !== String(id));
            appState.accounting = appState.accounting.filter(a => String(a.studentId) !== String(id));
            renderStudents(); updateStatsSelect(); saveToCloud();
        }

        function renderAccounting(q = "") {
            const body = document.getElementById('accounting-table-body');
            if(!body) return; body.innerHTML = '';
            let tD = 0, tP = 0, tE = 0;
            appState.students.filter(s => s.name.toLowerCase().includes(q.toLowerCase())).forEach(s => {
                const lessons = appState.lessons.filter(l => String(l.studentId) === String(s.id) && l.attendance);
                const lDebt = lessons.reduce((sum, l) => sum + (l.unitPrice || s.price), 0);
                const eExp = appState.accounting.filter(a => String(a.studentId) === String(s.id) && a.type === 'expense').reduce((sum, a) => sum + a.amount, 0);
                const paid = appState.accounting.filter(a => String(a.studentId) === String(s.id) && a.type === 'payment').reduce((sum, a) => sum + a.amount, 0);
                const bal = (lDebt + eExp) - paid;
                tD += lDebt; tP += paid; tE += eExp;
                body.innerHTML += `<tr class="border-b border-slate-800 hover:bg-slate-800/20"><td class="p-4">${s.name}</td><td class="p-4 text-center">${lessons.length}</td><td class="p-4 text-blue-400">â‚º${lDebt}</td><td class="p-4 text-orange-400">â‚º${eExp}</td><td class="p-4 text-green-500">â‚º${paid}</td><td class="p-4 font-bold ${bal > 0 ? 'text-red-500' : 'text-blue-500'}">â‚º${bal}</td><td class="p-4 text-center"><button onclick="viewHistory('${s.id}')" class="bg-slate-800 p-2 rounded"><i class="fas fa-history"></i></button></td></tr>`;
            });
            document.getElementById('acc-total-debt').innerText = `â‚º${tD + tE - tP}`;
            document.getElementById('acc-total-paid').innerText = `â‚º${tP}`;
            document.getElementById('acc-total-expense').innerText = `â‚º${tE}`;
            document.getElementById('acc-balance').innerText = `â‚º${tD + tE - tP}`;
        }

        function viewHistory(id) { currentHistoryStudentId = id; document.getElementById('acc-history-modal').classList.remove('hidden'); filterHistory(); }
        function filterHistory() {
            const query = document.getElementById('history-search-input').value.toLowerCase();
            const filtered = appState.accounting.filter(a => String(a.studentId) === String(currentHistoryStudentId)).filter(a => a.desc.toLowerCase().includes(query) || a.date.toLowerCase().includes(query));
            document.getElementById('acc-history-list').innerHTML = filtered.map(a => `<div class="flex justify-between p-3 glass-card rounded border-l-4 ${a.type === 'payment' ? 'border-green-500' : 'border-orange-500'}"><div><p class="font-bold">${a.desc}</p><p class="text-[10px]">${a.date}</p></div><div class="flex items-center gap-2"><span>â‚º${a.amount}</span><button onclick="deleteTransaction('${a.id}')" class="text-red-500"><i class="fas fa-trash"></i></button></div></div>`).join('');
        }

        function deleteTransaction(id) {
            if(!confirm("Silinsin mi?")) return;
            appState.accounting = appState.accounting.filter(a => String(a.id) !== String(id));
            filterHistory(); renderAccounting(); saveToCloud();
        }

        function openTransactionModal(type) {
            const m = document.getElementById('transaction-modal');
            document.getElementById('transaction-form').reset();
            document.getElementById('transaction-id').value = "";
            document.getElementById('transaction-type').value = type;
            document.getElementById('transaction-student').innerHTML = appState.students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            m.classList.remove('hidden');
        }

        function saveTransaction(e) {
            e.preventDefault();
            appState.accounting.push({ id: Date.now().toString(), type: document.getElementById('transaction-type').value, studentId: document.getElementById('transaction-student').value, amount: parseFloat(document.getElementById('transaction-amount').value), desc: document.getElementById('transaction-desc').value, date: new Date().toLocaleString() });
            closeModal('transaction-modal'); renderAccounting(); saveToCloud();
        }

        // --- STATS ---
        function loadStudentStats(id) {
            const container = document.getElementById('stats-container');
            const emptyState = document.getElementById('stats-empty-state');
            if(!id) { container.classList.add('hidden'); emptyState.classList.remove('hidden'); return; }
            container.classList.remove('hidden'); emptyState.classList.add('hidden'); initStats();
        }

        function initStats() {
            const charts = ['mood', 'subjectsSuccess', 'performance', 'reading', 'branchCount'];
            charts.forEach(c => { if(appState.charts[c]) appState.charts[c].destroy(); });
            const sId = document.getElementById('stats-student-select').value;
            if(!sId) return;
            const dataPool = appState.lessons.filter(l => String(l.studentId) === String(sId));
            
            // Mood
            const moods = [0,0,0,0,0]; dataPool.forEach(l => { if(l.mood) moods[l.mood-1]++; });
            appState.charts.mood = new Chart(document.getElementById('chart-mood'), { type: 'doughnut', data: { labels: ['KÃ¶tÃ¼','ZayÄ±f','Normal','Ä°yi','Harika'], datasets:[{ data: moods, backgroundColor:['#ef4444','#f97316','#eab308','#3b82f6','#22c55e'] }] }, options: { maintainAspectRatio:false } });

            // Branch count
            const bcCounts = {}; appState.branches.forEach(b => bcCounts[b] = 0);
            dataPool.forEach(l => (l.selectedBranches || []).forEach(b => bcCounts[b]++));
            appState.charts.branchCount = new Chart(document.getElementById('chart-branch-count'), { type: 'bar', data: { labels: appState.branches, datasets:[{ label:'Ders', data: appState.branches.map(b=>bcCounts[b]), backgroundColor:'#a855f7' }] }, options: { maintainAspectRatio:false } });

            // Success
            const brS = {}; appState.branches.forEach(b => brS[b] = { t:0, c:0 });
            dataPool.forEach(l => (l.tests || []).forEach(t => { if(brS[t.branch]) { brS[t.branch].t += t.q; brS[t.branch].c += t.d; } }));
            appState.charts.subjectsSuccess = new Chart(document.getElementById('chart-subjects-success'), { type: 'bar', data: { labels: appState.branches, datasets:[{ label:'% BaÅŸarÄ±', data: appState.branches.map(b => brS[b].t > 0 ? (brS[b].c/brS[b].t)*100 : 0), backgroundColor:'#3b82f6' }] }, options: { maintainAspectRatio:false, scales:{y:{min:0,max:100}} } });

            // Performance (Line Chart for success over time)
            const testHistory = []; dataPool.forEach(l => (l.tests || []).forEach(t => testHistory.push({ r: t.q > 0 ? (t.d/t.q)*100 : 0 })));
            appState.charts.performance = new Chart(document.getElementById('chart-test-performance'), { type: 'line', data: { labels: testHistory.map((_,i)=>i+1), datasets:[{label:'% BaÅŸarÄ±', data:testHistory.map(x=>x.r), borderColor:'#3b82f6', tension:0.4}] }, options: { maintainAspectRatio:false, scales:{y:{min:0,max:100}} } });

            // Reading
            const p = dataPool.filter(l => l.words || l.comprehension).slice(-10);
            appState.charts.reading = new Chart(document.getElementById('chart-reading'), { type: 'line', data: { labels: p.map((_,i)=>i+1), datasets:[{label:'Kelime', data:p.map(l=>l.words||0), borderColor:'#a855f7'}, {label:'% Anlama', data:p.map(l=>l.comprehension||0), borderColor:'#22c55e'}] }, options: { maintainAspectRatio:false } });
        }

        // --- EXPORTS ---
        async function exportFullCalendarPDF() { const el = document.getElementById('calendar-grid'); const canvas = await html2canvas(el, { backgroundColor:'#0f172a', scale:2 }); const pdf = new jspdf.jsPDF('l', 'mm', 'a4'); pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 10, 10, 277, 150); pdf.save('Takvim.pdf'); }
        function exportSingleLessonPDF() { const id = document.getElementById('lesson-id').value; const l = appState.lessons.find(x => String(x.id) === String(id)); if(!l) return; const pdf = new jspdf.jsPDF(); pdf.setFontSize(22); pdf.text('DERS RAPORU', 105, 20, {align:'center'}); pdf.setFontSize(10); pdf.text(`Ã–ÄŸrenci: ${getStudentName(l.studentId)}`, 20, 40); (l.tests || []).forEach((t, i) => { pdf.text(`${t.branch}: ${t.q}S - ${t.d}D`, 25, 90 + (i*7)); }); pdf.save(`${getStudentName(l.studentId)}_Ders.pdf`); }
        async function exportStatsPDF() { const el = document.getElementById('stats-container'); const canvas = await html2canvas(el, { backgroundColor:'#0f172a', scale:2 }); const pdf = new jspdf.jsPDF('p', 'mm', 'a4'); pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 10, 20, 190, 260); pdf.save('Stats.pdf'); }
        function exportAccountingPDF_Standard() { alert("DetaylÄ± rapor yakÄ±nda."); }

        window.onload = fetchData;
    </script>
</body>
</html>
