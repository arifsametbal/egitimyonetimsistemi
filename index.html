<!DOCTYPE html>
<html lang="tr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProEÄŸitim - YÃ¶netim Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/lucide-static@0.321.0/font/lucide.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f8fafc; overflow-x: hidden; }
        .glass-card { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); }
        .lesson-attended { border-left: 4px solid #10b981; background: rgba(16, 185, 129, 0.1); }
        .lesson-absent { border-left: 4px solid #ef4444; background: rgba(239, 68, 68, 0.1); }
        .lesson-pending { border-left: 4px solid #f59e0b; background: rgba(245, 158, 11, 0.1); }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        @media print { .no-print { display: none !important; } }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap: 0.75rem; }
        @media (max-width: 768px) { .calendar-grid:not(.exporting) { grid-template-columns: 1fr; } }
        .exporting.calendar-grid { grid-template-columns: repeat(7, minmax(0, 1fr)) !important; width: 1120px !important; padding: 20px !important; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const API_URL = "https://script.google.com/macros/s/AKfycbzzIH-BxBk4JSrB-5S2o6aQkPQ8D-GXphOnrOnAQJ4yZCzthc7IVvBhRgkiIEd8ZfY/exec"; 

        const BRANCHES = ["Matematik", "TÃ¼rkÃ§e", "Hayat Bilgisi", "Sosyal Bilgiler", "Fen Bilimleri", "Ä°ngilizce", "Bilsem", "Robotik Kodlama", "AkÄ±l ve Zeka OyunlarÄ±"];
        const EMOTIONS_MAP = [
            { icon: "ðŸ˜¢", label: "ÃœzgÃ¼n", color: "#ef4444" },
            { icon: "ðŸ¥±", label: "Yorgun", color: "#f59e0b" },
            { icon: "ðŸ˜", label: "HazÄ±r", color: "#3b82f6" },
            { icon: "ðŸ˜Š", label: "Keyifli", color: "#10b981" },
            { icon: "ðŸš€", label: "Enerjik", color: "#8b5cf6" }
        ];
        const GRADES = Array.from({length: 12}, (_, i) => i + 1);

        const App = () => {
            const [activeTab, setActiveTab] = useState('calendar');
            const [students, setStudents] = useState([]);
            const [lessons, setLessons] = useState([]);
            const [transactions, setTransactions] = useState([]);
            const [priceLogs, setPriceLogs] = useState([]);
            const [loading, setLoading] = useState(false);

            const fetchData = async () => {
                setLoading(true);
                try {
                    const response = await fetch(API_URL);
                    const data = await response.json();
                    if (data && data.students) {
                        setStudents(data.students || []);
                        setLessons(data.lessons || []);
                        setTransactions(data.transactions || []);
                        setPriceLogs(data.priceLogs || []);
                        localStorage.setItem('eys_backup', JSON.stringify(data));
                    }
                } catch (err) {
                    const saved = localStorage.getItem('eys_backup');
                    if (saved) {
                        const p = JSON.parse(saved);
                        setStudents(p.students || []);
                        setLessons(p.lessons || []);
                        setTransactions(p.transactions || []);
                        setPriceLogs(p.priceLogs || []);
                    }
                } finally { setLoading(false); }
            };

            const syncData = async (updatedData) => {
                localStorage.setItem('eys_backup', JSON.stringify(updatedData));
                setLoading(true);
                try {
                    await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'syncAll', data: updatedData })
                    });
                } catch (err) {
                    console.error("Senkronizasyon hatasÄ±");
                } finally { setLoading(false); }
            };

            useEffect(() => { fetchData(); }, []);

            const handleUpdate = (type, newData) => {
                // Mevcut state deÄŸerlerini en gÃ¼ncel haliyle almak iÃ§in fonksiyonel gÃ¼ncelleme mantÄ±ÄŸÄ±nÄ± simÃ¼le ediyoruz
                setStudents(prevStudents => {
                    setLessons(prevLessons => {
                        setTransactions(prevTransactions => {
                            setPriceLogs(prevPriceLogs => {
                                const finalData = {
                                    students: type === 'students' ? newData : prevStudents,
                                    lessons: type === 'lessons' ? newData : prevLessons,
                                    transactions: type === 'transactions' ? newData : prevTransactions,
                                    priceLogs: type === 'priceLogs' ? newData : prevPriceLogs
                                };
                                syncData(finalData);
                                return finalData.priceLogs;
                            });
                            return type === 'transactions' ? newData : prevTransactions;
                        });
                        return type === 'lessons' ? newData : prevLessons;
                    });
                    return type === 'students' ? newData : prevStudents;
                });
            };

            const exportPDF = (elementId, orientation = 'portrait', fileName = 'rapor.pdf') => {
                const element = document.getElementById(elementId);
                if (!element) return;
                const isCalendar = elementId === 'calendar-render';
                if (isCalendar) element.classList.add('exporting');
                const opt = {
                    margin: 5, filename: fileName, image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, backgroundColor: '#020617', width: orientation === 'landscape' ? 1120 : 794 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: orientation }
                };
                html2pdf().set(opt).from(element).save().then(() => {
                    if (isCalendar) element.classList.remove('exporting');
                });
            };

            const Sidebar = () => (
                <div className="fixed bottom-0 left-0 w-full bg-slate-900/90 backdrop-blur-md border-t border-slate-800 flex justify-around p-2 md:relative md:w-64 md:h-screen md:flex-col md:justify-start md:gap-1 md:border-r md:border-t-0 z-50 no-print">
                    <div className="hidden md:flex items-center gap-3 p-6 mb-4">
                        <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-500/20"><i className="lucide-graduation-cap w-5 h-5 text-white"></i></div>
                        <span className="text-xl font-black text-white tracking-tight italic uppercase">PROEÄžÄ°TÄ°M</span>
                    </div>
                    <NavItem icon="calendar" label="Takvim" active={activeTab === 'calendar'} onClick={() => setActiveTab('calendar')} />
                    <NavItem icon="users" label="Ã–ÄŸrenciler" active={activeTab === 'students'} onClick={() => setActiveTab('students')} />
                    <NavItem icon="bar-chart-3" label="Ä°statistik" active={activeTab === 'statistics'} onClick={() => setActiveTab('statistics')} />
                    <NavItem icon="wallet" label="Muhasebe" active={activeTab === 'accounting'} onClick={() => setActiveTab('accounting')} />
                </div>
            );

            const NavItem = ({ icon, label, active, onClick }) => (
                <button onClick={onClick} className={`flex flex-col md:flex-row items-center gap-3 p-3 rounded-xl transition-all duration-300 ${active ? 'text-blue-400 bg-blue-400/10 shadow-sm' : 'text-slate-500 hover:text-slate-300 hover:bg-slate-800/50'}`}>
                    <i className={`lucide-${icon} w-5 h-5`}></i>
                    <span className="text-[10px] md:text-sm font-bold uppercase tracking-wide">{label}</span>
                </button>
            );

            const CalendarTab = () => {
                const [baseDate, setBaseDate] = useState(new Date().toISOString().split('T')[0]);
                const weekDays = useMemo(() => {
                    const date = new Date(baseDate);
                    const day = date.getDay();
                    const diff = date.getDate() - day + (day === 0 ? -6 : 1);
                    const monday = new Date(date.setDate(diff));
                    return Array.from({length: 7}, (_, i) => {
                        const d = new Date(monday); d.setDate(monday.getDate() + i);
                        return d.toISOString().split('T')[0];
                    });
                }, [baseDate]);
                const [isModalOpen, setIsModalOpen] = useState(false);
                const [editingLesson, setEditingLesson] = useState(null);
                const [activeDayForAdd, setActiveDayForAdd] = useState(null);

                return (
                    <div className="p-4 md:p-6 lg:p-8 pb-24 md:pb-8 flex flex-col h-full overflow-hidden animate-in fade-in">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4 no-print">
                            <div><h1 className="text-2xl md:text-3xl font-black text-white italic tracking-tight">HaftalÄ±k Takvim</h1><p className="text-slate-500 text-sm font-medium uppercase tracking-widest italic">Ders Planlama ve Takip</p></div>
                            <div className="flex flex-wrap items-center gap-3">
                                <div className="flex bg-slate-900 border border-slate-800 rounded-xl p-1 shadow-inner">
                                    <button onClick={() => { const d = new Date(baseDate); d.setDate(d.getDate() - 7); setBaseDate(d.toISOString().split('T')[0]); }} className="p-2 hover:bg-slate-800 rounded-lg text-slate-400 transition"><i className="lucide-chevron-left w-5 h-5"></i></button>
                                    <input type="date" className="bg-transparent px-2 text-sm font-bold text-white outline-none cursor-pointer" value={baseDate} onChange={(e) => setBaseDate(e.target.value)} />
                                    <button onClick={() => { const d = new Date(baseDate); d.setDate(d.getDate() + 7); setBaseDate(d.toISOString().split('T')[0]); }} className="p-2 hover:bg-slate-800 rounded-lg text-slate-400 transition"><i className="lucide-chevron-right w-5 h-5"></i></button>
                                </div>
                                <button onClick={() => exportPDF('calendar-render', 'landscape', 'Haftalik_Program.pdf')} className="bg-slate-800 hover:bg-slate-700 text-white px-4 py-2.5 rounded-xl font-bold text-xs flex items-center gap-2 border border-slate-700 uppercase italic tracking-tighter"><i className="lucide-printer w-4 h-4 text-blue-400"></i> RAPOR AL</button>
                            </div>
                        </div>
                        <div className="flex-1 overflow-x-auto custom-scrollbar pb-2">
                            <div id="calendar-render" className="calendar-grid h-full min-h-[600px]">
                                {weekDays.map((day) => {
                                    const dayLessons = lessons.filter(l => l.date === day).sort((a,b) => (a.time || '').localeCompare(b.time || ''));
                                    const dateObj = new Date(day);
                                    const isToday = day === new Date().toISOString().split('T')[0];
                                    return (
                                        <div key={day} className={`flex flex-col h-full rounded-2xl border transition-colors ${isToday ? 'bg-blue-600/[0.03] border-blue-500/30 ring-1' : 'bg-slate-900/40 border-slate-800/60'}`}>
                                            <div className={`p-4 text-center border-b border-slate-800/50 ${isToday ? 'bg-blue-600/5' : ''}`}>
                                                <div className={`text-[10px] uppercase font-black tracking-widest ${isToday ? 'text-blue-400' : 'text-slate-500'}`}>{dateObj.toLocaleDateString('tr-TR', { weekday: 'long' })}</div>
                                                <div className={`text-xl font-black mt-0.5 ${isToday ? 'text-blue-500' : 'text-slate-200'}`}>{dateObj.getDate()}</div>
                                            </div>
                                            <div className="flex-1 p-2 space-y-2 overflow-y-auto custom-scrollbar">
                                                {dayLessons.map(lesson => {
                                                    const student = students.find(s => s.id === lesson.studentId);
                                                    return (
                                                        <div key={lesson.id} onClick={() => { setEditingLesson(lesson); setIsModalOpen(true); }} className={`p-3 rounded-xl cursor-pointer transition-all hover:translate-y-[-2px] hover:shadow-lg border border-transparent hover:border-white/10 ${lesson.attendance === 'geldi' ? 'lesson-attended' : lesson.attendance === 'gelmedi' ? 'lesson-absent' : 'lesson-pending'}`}>
                                                            <div className="flex justify-between items-start mb-1"><span className="text-[10px] font-black text-blue-400 bg-blue-400/10 px-1.5 py-0.5 rounded leading-none italic">{lesson.time}</span><span className="text-xs">{lesson.emotion}</span></div>
                                                            <div className="text-xs font-black text-slate-100 truncate mb-0.5">{student?.name || 'Belirsiz'}</div>
                                                            <div className="text-[9px] text-slate-500 font-bold uppercase truncate">{Array.isArray(lesson.branches) ? lesson.branches.join(', ') : lesson.branch}</div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                            <div className="p-2 no-print">
                                                <button onClick={() => { setActiveDayForAdd(day); setEditingLesson(null); setIsModalOpen(true); }} className="w-full py-2.5 rounded-xl bg-slate-800/40 hover:bg-slate-700/60 text-slate-400 hover:text-white transition-all flex items-center justify-center gap-2 text-[10px] font-black border border-dashed border-slate-700 italic tracking-tighter uppercase"><i className="lucide-plus w-3 h-3 text-blue-500"></i> Ders Ekle</button>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                        {isModalOpen && (
                            <LessonModal 
                                lesson={editingLesson} students={students} initialDate={activeDayForAdd} onClose={() => setIsModalOpen(false)} 
                                onSave={(data) => {
                                    const newLessons = editingLesson ? lessons.map(l => l.id === editingLesson.id ? {...l, ...data} : l) : [...lessons, { ...data, id: Date.now().toString() }];
                                    handleUpdate('lessons', newLessons);
                                    setIsModalOpen(false);
                                }}
                                onDelete={(id) => { handleUpdate('lessons', lessons.filter(l => l.id !== id)); setIsModalOpen(false); }}
                            />
                        )}
                    </div>
                );
            };

            const LessonModal = ({ lesson, students, initialDate, onClose, onSave, onDelete }) => {
                const [form, setForm] = useState(lesson ? {
                    ...lesson,
                    branches: Array.isArray(lesson.branches) ? lesson.branches : (lesson.branch ? [lesson.branch] : []),
                    media: lesson.media || [],
                    tests: lesson.tests || []
                } : {
                    studentId: '', date: initialDate, time: '09:00', branches: [],
                    notes: '', reminders: '', tests: [], readingData: { wpm: '', comp: '' },
                    emotion: EMOTIONS_MAP[2].icon, attendance: 'bekliyor', media: []
                });
                const currentStudent = students.find(s => s.id === form.studentId);
                const toggleBranch = (b) => setForm(prev => ({ ...prev, branches: prev.branches.includes(b) ? prev.branches.filter(i => i !== b) : [...prev.branches, b] }));
                const handleFileUpload = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (ev) => setForm(prev => ({ ...prev, media: [...prev.media, { id: Date.now(), type: file.type.startsWith('video') ? 'video' : 'image', data: ev.target.result }] }));
                        reader.readAsDataURL(file);
                    }
                };

                return (
                    <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-950/90 backdrop-blur-sm overflow-y-auto">
                        <div id="lesson-detail-a4" className="bg-slate-900 w-full max-w-4xl rounded-3xl p-6 md:p-8 border border-slate-800 shadow-2xl my-4">
                            <div className="flex justify-between items-center mb-6 no-print">
                                <h2 className="text-xl font-black text-white italic">{lesson ? 'Ders DetayÄ±' : 'Yeni Ders KaydÄ±'}</h2>
                                <div className="flex gap-2">
                                    <button onClick={() => exportPDF('lesson-detail-a4', 'portrait', `${currentStudent?.name || 'Ders'}_Detayi.pdf`)} className="p-2.5 bg-slate-800 text-slate-400 hover:text-blue-400 rounded-xl transition border border-slate-700 shadow-inner"><i className="lucide-printer w-5 h-5"></i></button>
                                    <button onClick={onClose} className="p-2.5 bg-slate-800 text-slate-400 hover:text-white rounded-xl transition border border-slate-700 shadow-inner"><i className="lucide-x w-5 h-5"></i></button>
                                </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div className="space-y-4">
                                    <div><label className="block text-[10px] font-black text-slate-500 uppercase italic tracking-widest mb-1 ml-1">Ã–ÄŸrenci</label><select className="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl font-bold text-sm outline-none shadow-inner" value={form.studentId} onChange={e => setForm({...form, studentId: e.target.value})}><option value="">SeÃ§in</option>{students.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}</select></div>
                                    <div><label className="block text-[10px] font-black text-slate-500 uppercase italic tracking-widest mb-1 ml-1">BranÅŸlar</label><div className="flex flex-wrap gap-1.5 p-3 bg-slate-800/50 rounded-2xl border border-slate-800 shadow-inner">{BRANCHES.map(b => (<button key={b} onClick={() => toggleBranch(b)} className={`px-2.5 py-1.5 rounded-lg text-[10px] font-black transition ${form.branches.includes(b) ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-800 text-slate-500 hover:bg-slate-700'}`}>{b.toUpperCase()}</button>))}</div></div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <input type="time" className="bg-slate-800 border border-slate-700 p-3 rounded-xl font-bold text-sm outline-none shadow-inner" value={form.time} onChange={e => setForm({...form, time: e.target.value})} />
                                        <input type="date" className="bg-slate-800 border border-slate-700 p-3 rounded-xl font-bold text-sm outline-none shadow-inner" value={form.date} onChange={e => setForm({...form, date: e.target.value})} />
                                    </div>
                                    <textarea placeholder="Ders NotlarÄ±..." className="w-full bg-slate-800 border border-slate-700 p-4 rounded-xl h-24 text-xs font-medium focus:ring-1 focus:ring-blue-500 outline-none transition shadow-inner" value={form.notes} onChange={e => setForm({...form, notes: e.target.value})}></textarea>
                                    <div className="no-print"><label className="block text-[10px] font-black text-slate-500 uppercase italic tracking-widest mb-1 ml-1 italic tracking-tighter">Medya Ekle</label><label className="flex flex-col items-center justify-center w-full h-16 border-2 border-slate-700 border-dashed rounded-xl cursor-pointer bg-slate-800/50 hover:bg-slate-800 transition shadow-inner"><i className="lucide-upload-cloud w-4 h-4 text-slate-500"></i><input type="file" className="hidden" accept="image/*,video/*" onChange={handleFileUpload} /></label></div>
                                </div>
                                <div className="space-y-4">
                                    <div className="bg-slate-950/50 p-5 rounded-2xl border border-slate-800 shadow-inner">
                                        <div className="flex justify-between items-center mb-4"><h4 className="text-[10px] uppercase font-black text-blue-500 tracking-widest italic tracking-tighter">Test PerformansÄ±</h4><button onClick={() => setForm(p => ({...p, tests: [...p.tests, {id: Date.now(), q:'', t:'', f:'', b:'', branch:''}]}))} className="text-[9px] font-black bg-blue-600/20 text-blue-400 px-2 py-1 rounded-lg uppercase italic tracking-tighter">Ekle</button></div>
                                        <div className="space-y-4 max-h-[200px] overflow-y-auto custom-scrollbar pr-2">
                                            {form.tests.map((test) => (
                                                <div key={test.id} className="p-3 bg-slate-800/40 rounded-xl border border-slate-700 relative group">
                                                    <select className="w-full bg-slate-900 border border-slate-700 p-2 rounded-lg font-bold text-[10px] mb-2 outline-none shadow-inner" value={test.branch} onChange={e => setForm(p => ({...p, tests: p.tests.map(t => t.id === test.id ? {...t, branch: e.target.value} : t)}))}><option value="">BranÅŸ SeÃ§in</option>{form.branches.map(b => <option key={b} value={b}>{b}</option>)}</select>
                                                    <div className="grid grid-cols-4 gap-2 text-center text-[10px] font-black">
                                                        <input type="number" placeholder="S" className="bg-slate-900 border border-slate-700 p-1 rounded outline-none" value={test.q} onChange={e => setForm(p => ({...p, tests: p.tests.map(t => t.id === test.id ? {...t, q: e.target.value} : t)}))} />
                                                        <input type="number" placeholder="D" className="bg-slate-900 border border-slate-700 p-1 rounded outline-none text-green-400" value={test.t} onChange={e => setForm(p => ({...p, tests: p.tests.map(t => t.id === test.id ? {...t, t: e.target.value} : t)}))} />
                                                        <input type="number" placeholder="Y" className="bg-slate-900 border border-slate-700 p-1 rounded outline-none text-red-400" value={test.f} onChange={e => setForm(p => ({...p, tests: p.tests.map(t => t.id === test.id ? {...t, f: e.target.value} : t)}))} />
                                                        <input type="number" placeholder="B" className="bg-slate-900 border border-slate-700 p-1 rounded outline-none text-slate-400" value={test.b} onChange={e => setForm(p => ({...p, tests: p.tests.map(t => t.id === test.id ? {...t, b: e.target.value} : t)}))} />
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="bg-slate-950/50 p-5 rounded-2xl border border-slate-800 shadow-inner">
                                        <h4 className="text-[10px] uppercase font-black text-green-500 mb-4 tracking-widest text-center italic tracking-tighter">Okuma HÄ±zÄ±</h4>
                                        <div className="grid grid-cols-2 gap-3">
                                            <input type="number" placeholder="Kelime/Dak" className="bg-slate-800 p-2.5 rounded-xl text-center font-black text-sm outline-none shadow-inner" value={form.readingData.wpm} onChange={e => setForm({...form, readingData: {...form.readingData, wpm: e.target.value}})} />
                                            <input type="number" placeholder="Anlama %" className="bg-slate-800 p-2.5 rounded-xl text-center font-black text-sm outline-none shadow-inner" value={form.readingData.comp} onChange={e => setForm({...form, readingData: {...form.readingData, comp: e.target.value}})} />
                                        </div>
                                    </div>
                                    <textarea placeholder="Ã–devler..." className="w-full bg-slate-800 border border-yellow-500/20 p-4 rounded-xl h-20 text-xs italic text-yellow-500/80 outline-none shadow-inner" value={form.reminders} onChange={e => setForm({...form, reminders: e.target.value})}></textarea>
                                </div>
                            </div>
                            <div className="mt-8 pt-6 border-t border-slate-800 flex flex-wrap items-center justify-between gap-4">
                                <div className="flex gap-2">{EMOTIONS_MAP.map(item => (<button key={item.label} onClick={() => setForm({...form, emotion: item.icon})} className={`flex flex-col items-center min-w-[65px] p-2 rounded-xl border transition-all ${form.emotion === item.icon ? 'bg-blue-600 border-blue-400 scale-105 shadow-lg shadow-blue-500/30' : 'bg-slate-800 border-slate-700 opacity-40 shadow-sm'}`}><span className="text-xl">{item.icon}</span><span className="text-[8px] font-black uppercase mt-1 italic tracking-tighter">{item.label}</span></button>))}</div>
                                <div className="flex gap-3">
                                    <div className="flex bg-slate-950/40 p-1 rounded-xl border border-slate-800 shadow-inner"><button onClick={() => setForm({...form, attendance: 'geldi'})} className={`px-5 py-2 rounded-lg text-[10px] font-black transition ${form.attendance === 'geldi' ? 'bg-green-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-800'}`}>GELDÄ°</button><button onClick={() => setForm({...form, attendance: 'gelmedi'})} className={`px-4 py-2 rounded-lg text-[10px] font-black transition ${form.attendance === 'gelmedi' ? 'bg-red-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-800'}`}>GELMEDÄ°</button></div>
                                    <button onClick={() => {
                                        // Birim fiyatÄ± sadece yeni derslerde ayarla, dÃ¼zenleme yapÄ±lÄ±yorsa eski fiyatÄ± koru
                                        const priceToSave = lesson ? (lesson.priceAtTime || currentStudent?.unitPrice || 0) : (currentStudent?.unitPrice || 0);
                                        onSave({...form, priceAtTime: priceToSave});
                                    }} className="px-12 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-black text-xs shadow-xl active:scale-95 transition uppercase italic">KAYDET</button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const StudentsTab = () => {
                const [q, setQ] = useState("");
                const [isModalOpen, setIsModalOpen] = useState(false);
                const [editingStudent, setEditingStudent] = useState(null);
                const filtered = useMemo(() => students.filter(s => (s.name || '').toLowerCase().includes(q.toLowerCase())), [students, q]);

                return (
                    <div className="p-4 md:p-8 pb-24 h-full overflow-y-auto custom-scrollbar animate-in slide-in-from-right duration-500">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
                            <div><h1 className="text-3xl font-black text-white italic tracking-tighter">Ã–ÄŸrenci YÃ¶netimi</h1><p className="text-slate-500 font-medium uppercase tracking-widest text-[10px] italic">KayÄ±t Listesi</p></div>
                            <div className="flex gap-3 w-full md:w-auto">
                                <div className="relative flex-1 md:w-72"><i className="lucide-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 w-4 h-4"></i><input type="text" placeholder="HÄ±zlÄ± ara..." className="w-full bg-slate-900 border border-slate-800 p-3.5 pl-12 rounded-2xl text-sm font-medium focus:border-blue-500 outline-none transition shadow-inner" value={q} onChange={(e) => setQ(e.target.value)} /></div>
                                <button onClick={() => { setEditingStudent(null); setIsModalOpen(true); }} className="bg-blue-600 hover:bg-blue-500 px-6 py-3.5 rounded-2xl flex items-center gap-2 font-black text-xs transition text-white uppercase tracking-wider shadow-lg shadow-blue-600/20 italic"><i className="lucide-user-plus w-4 h-4"></i> Ã–ÄžRENCÄ° EKLE</button>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            {filtered.map(student => (
                                <div key={student.id} className="glass-card p-6 rounded-[2rem] hover:border-blue-500/40 transition group flex flex-col shadow-sm">
                                    <div className="flex items-center gap-4 mb-5">
                                        <div className="w-16 h-16 bg-slate-800 rounded-2xl flex items-center justify-center text-2xl font-black text-blue-500 overflow-hidden shadow-lg border border-slate-700">
                                            {student.photo ? <img src={student.photo} className="w-full h-full object-cover" /> : (student.name || '?')[0]}
                                        </div>
                                        <div><h3 className="text-lg font-black text-white leading-tight mb-1 italic tracking-tighter">{student.name}</h3><span className="text-[9px] font-black bg-blue-600/20 text-blue-400 px-2 py-0.5 rounded uppercase">{student.grade}. SINIF</span></div>
                                    </div>
                                    <div className="bg-slate-950/40 p-3 rounded-xl mb-6 flex-1 border border-white/5 shadow-inner"><div className="flex justify-between text-[10px] mb-1.5"><span className="text-slate-500 font-bold uppercase tracking-widest">Birim Ãœcret</span><span className="text-white font-black italic tracking-tighter">{student.unitPrice} â‚º</span></div><p className="text-[10px] text-slate-400 italic line-clamp-2 leading-relaxed">{student.notes || 'Not kaydÄ± bulunmuyor.'}</p></div>
                                    <div className="flex gap-2">
                                        <button onClick={() => {setEditingStudent(student); setIsModalOpen(true);}} className="flex-1 py-2.5 bg-slate-800 hover:bg-slate-700 rounded-xl text-[10px] font-black uppercase tracking-widest transition border border-slate-700 shadow-inner italic">DÃœZENLE</button>
                                        <button onClick={() => exportStudentProfile(student)} className="flex-1 py-2.5 bg-blue-600/10 text-blue-400 hover:bg-blue-600 hover:text-white rounded-xl text-[10px] font-black uppercase tracking-widest transition flex items-center justify-center gap-2 border border-blue-500/20 shadow-inner italic"><i className="lucide-file-text w-3 h-3"></i> PROFÄ°L</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                        {isModalOpen && (
                            <StudentModal 
                                student={editingStudent} onClose={() => setIsModalOpen(false)} 
                                onSave={(data) => {
                                    if(editingStudent) {
                                        if (editingStudent.unitPrice !== data.unitPrice) { 
                                            const nl = [...priceLogs, { id: Date.now(), studentId: editingStudent.id, oldPrice: editingStudent.unitPrice, newPrice: data.unitPrice, date: new Date().toLocaleString() }];
                                            handleUpdate('priceLogs', nl);
                                        }
                                        handleUpdate('students', students.map(s => s.id === editingStudent.id ? {...s, ...data, updatedAt: new Date().toLocaleString()} : s));
                                    } else { handleUpdate('students', [...students, { ...data, id: Date.now().toString(), updatedAt: new Date().toLocaleString() }]); }
                                    setIsModalOpen(false);
                                }}
                                onDelete={(id) => { handleUpdate('students', students.filter(s => s.id !== id)); setIsModalOpen(false); }}
                                logs={editingStudent ? priceLogs.filter(p => p.studentId === editingStudent.id) : []}
                            />
                        )}
                    </div>
                );
            };

            const StatisticsTab = () => {
                const [statSubTab, setStatSubTab] = useState('summary');
                const [selectedStudentId, setSelectedStudentId] = useState("");
                const [searchStudent, setSearchStudent] = useState("");
                const pieRef = useRef(null);
                const barRef = useRef(null);

                const filteredStudents = useMemo(() => students.filter(s => (s.name || '').toLowerCase().includes(searchStudent.toLowerCase())), [students, searchStudent]);
                const currentStudent = students.find(s => s.id === selectedStudentId);
                const studentLessons = lessons.filter(l => l.studentId === selectedStudentId);
                const allTests = useMemo(() => studentLessons.flatMap(l => (l.tests || []).map(t => ({ ...t, date: l.date }))), [studentLessons]);

                useEffect(() => {
                    if (selectedStudentId) {
                        if (statSubTab === 'summary' && pieRef.current) {
                            const ctx = pieRef.current.getContext('2d');
                            let inst = Chart.getChart(pieRef.current);
                            if (inst) inst.destroy();
                            const counts = EMOTIONS_MAP.map(e => studentLessons.filter(l => l.emotion === e.icon).length);
                            new Chart(ctx, {
                                type: 'doughnut',
                                data: { labels: EMOTIONS_MAP.map(e => e.label), datasets: [{ data: counts, backgroundColor: EMOTIONS_MAP.map(e => e.color), borderWidth: 0, hoverOffset: 15 }] },
                                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#94a3b8', font: { weight: 'bold', size: 10 } } } } }
                            });
                        }
                        if (statSubTab === 'reading' && barRef.current) {
                            const ctx = barRef.current.getContext('2d');
                            let inst = Chart.getChart(barRef.current);
                            if (inst) inst.destroy();
                            const valid = studentLessons.filter(l => l.readingData?.wpm);
                            new Chart(ctx, {
                                type: 'line',
                                data: { labels: valid.map(l => l.date), datasets: [{ label: 'Kelim/Dak', data: valid.map(l => parseFloat(l.readingData.wpm)), borderColor: '#10b981', tension: 0.4 }, { label: 'Anlama %', data: valid.map(l => parseFloat(l.readingData.comp)), borderColor: '#3b82f6', tension: 0.4 }] },
                                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } } } }
                            });
                        }
                        // Testler ve Genel Ortalama grafikleri
                        if (statSubTab === 'test') {
                            const avgCtx = document.getElementById('general-avg-chart')?.getContext('2d');
                            if (avgCtx) {
                                let avgInst = Chart.getChart('general-avg-chart');
                                if (avgInst) avgInst.destroy();
                                const validTests = allTests.filter(t => t.q && t.q !== '');
                                new Chart(avgCtx, {
                                    type: 'line',
                                    data: { labels: validTests.map(t => t.date), datasets: [{ label: 'BaÅŸarÄ± (%)', data: validTests.map(t => (parseFloat(t.t) / parseFloat(t.q)) * 100), borderColor: '#f8fafc', fill: true, backgroundColor: 'rgba(255,255,255,0.05)', tension: 0.4 }] },
                                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { max: 100, beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } } } }
                                });
                            }
                            BRANCHES.forEach(branch => {
                                const branchCtx = document.getElementById(`chart-${branch}`)?.getContext('2d');
                                if (branchCtx) {
                                    let bInst = Chart.getChart(`chart-${branch}`);
                                    if (bInst) bInst.destroy();
                                    const bTests = allTests.filter(t => t.branch === branch && t.q && t.q !== '');
                                    if (bTests.length > 0) {
                                        new Chart(branchCtx, {
                                            type: 'line',
                                            data: { labels: bTests.map(t => t.date), datasets: [{ label: `${branch} (%)`, data: bTests.map(t => (parseFloat(t.t) / parseFloat(t.q)) * 100), borderColor: '#3b82f6', tension: 0.4 }] },
                                            options: { responsive: true, maintainAspectRatio: false, scales: { y: { max: 100, beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } } } }
                                        });
                                    }
                                }
                            });
                        }
                    }
                }, [statSubTab, selectedStudentId, studentLessons, allTests]);

                return (
                    <div className="flex h-full overflow-hidden no-print animate-in fade-in duration-500">
                        <div className="w-64 border-r border-slate-800 flex flex-col bg-slate-900/50">
                            <div className="p-4 border-b border-slate-800"><h3 className="text-[10px] font-black uppercase text-slate-500 italic mb-3 tracking-widest italic tracking-tighter">Ã–ÄŸrenci Listesi</h3><input type="text" placeholder="Filtrele..." className="w-full bg-slate-950 border border-slate-800 p-2 rounded-lg text-xs outline-none focus:border-blue-500 shadow-inner" value={searchStudent} onChange={e => setSearchStudent(e.target.value)} /></div>
                            <div className="flex-1 overflow-y-auto custom-scrollbar p-2 space-y-1">{filteredStudents.map(s => (<button key={s.id} onClick={() => setSelectedStudentId(s.id)} className={`w-full flex items-center gap-3 p-3 rounded-xl transition ${selectedStudentId === s.id ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-800 text-slate-400'}`}><div className={`w-7 h-7 rounded-lg bg-slate-700 flex items-center justify-center text-[11px] font-black ${selectedStudentId === s.id ? 'bg-white/20' : ''}`}>{(s.name || '?')[0]}</div><span className="text-xs font-bold truncate italic tracking-tighter">{s.name}</span></button>))}</div>
                        </div>
                        <div className="flex-1 overflow-y-auto custom-scrollbar p-4 md:p-8">
                            {!selectedStudentId ? (<div className="h-full flex flex-col items-center justify-center opacity-20 italic font-black text-2xl tracking-tighter">Ä°STATÄ°STÄ°K Ä°Ã‡Ä°N Ã–ÄžRENCÄ° SEÃ‡Ä°N</div>) : (
                                <div className="space-y-8 animate-in fade-in duration-700" id="stat-render">
                                    <div className="flex flex-col md:flex-row justify-between gap-4">
                                        <div className="flex items-center gap-5"><div className="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center font-black text-2xl italic tracking-tighter text-white shadow-xl italic">{(currentStudent?.name || '?')[0]}</div><div><h2 className="text-2xl font-black italic tracking-tighter">{currentStudent?.name}</h2><p className="text-[10px] font-black uppercase tracking-[0.2em] text-slate-500 italic">GeliÅŸim Raporu</p></div></div>
                                        <div className="flex gap-2 bg-slate-900/50 p-1.5 rounded-2xl border border-slate-800 shadow-inner">
                                            {['summary', 'test', 'reading'].map(t => (<button key={t} onClick={() => setStatSubTab(t)} className={`px-5 py-2 rounded-xl text-[10px] font-black uppercase transition ${statSubTab === t ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-500'}`}>{t === 'summary' ? 'Ã–ZET' : t === 'test' ? 'TESTLER' : 'OKUMA'}</button>))}
                                            <button onClick={() => exportPDF('stat-render', 'portrait', 'Gelisim_Raporu.pdf')} className="px-3 bg-slate-800 text-blue-400 border border-slate-700 rounded-xl"><i className="lucide-download w-4 h-4"></i></button>
                                        </div>
                                    </div>
                                    {statSubTab === 'summary' && (<div className="grid grid-cols-1 lg:grid-cols-2 gap-6"><div className="glass-card p-8 rounded-[2rem] min-h-[350px]"><canvas ref={pieRef}></canvas></div><div className="glass-card p-8 rounded-[2rem]"><span className="text-4xl font-black text-blue-500 tabular-nums italic tracking-tighter">{studentLessons.filter(l => l.attendance === 'geldi').length}</span><p className="text-[10px] font-bold text-slate-500 mt-2 uppercase tracking-widest italic tracking-tighter">Toplam KatÄ±lÄ±m</p></div></div>)}
                                    {statSubTab === 'test' && (
                                        <div className="space-y-8">
                                            <div className="glass-card p-8 rounded-[2rem] h-[350px] shadow-xl"><h4 className="text-[10px] font-black text-slate-400 mb-6 uppercase italic tracking-widest text-center">Genel BaÅŸarÄ± OrtalamasÄ± (%)</h4><div className="h-[250px]"><canvas id="general-avg-chart"></canvas></div></div>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                {BRANCHES.map(b => allTests.some(t => t.branch === b && t.q) && (
                                                    <div key={b} className="glass-card p-6 rounded-[2rem] h-[280px] shadow-lg"><h5 className="text-[9px] font-black text-slate-500 mb-4 uppercase tracking-widest">{b} Analizi</h5><div className="h-[180px]"><canvas id={`chart-${b}`}></canvas></div></div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    {statSubTab === 'reading' && (<div className="glass-card p-10 rounded-[2.5rem] h-[450px] shadow-2xl border border-white/5"><canvas ref={barRef}></canvas></div>)}
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const AccountingTab = () => {
                const [q, setQ] = useState("");
                const [payModal, setPayModal] = useState(null);
                const [history, setHistory] = useState(null);
                const summary = useMemo(() => students.map(s => {
                    const lList = lessons.filter(l => l.studentId === s.id && l.attendance === 'geldi');
                    const tList = transactions.filter(t => t.studentId === s.id);
                    const debt = lList.reduce((acc, curr) => acc + (curr.priceAtTime || s.unitPrice || 0), 0);
                    const paid = tList.filter(t => t.type === 'payment').reduce((acc, curr) => acc + (parseFloat(curr.amount) || 0), 0);
                    const expenses = tList.filter(t => t.type === 'expense').reduce((acc, curr) => acc + (parseFloat(curr.amount) || 0), 0);
                    return { id: s.id, name: s.name, count: lList.length, debt, paid, expenses, balance: (debt + expenses) - paid };
                }).filter(s => (s.name || '').toLowerCase().includes(q.toLowerCase())), [students, lessons, transactions, q]);

                const totals = summary.reduce((acc, curr) => ({ count: acc.count + curr.count, debt: acc.debt + curr.debt, paid: acc.paid + curr.paid, expenses: acc.expenses + curr.expenses, balance: acc.balance + curr.balance }), {count:0, debt:0, paid:0, expenses:0, balance:0});

                return (
                    <div className="p-4 md:p-8 pb-24 h-full overflow-y-auto custom-scrollbar animate-in fade-in duration-500">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4"><h1 className="text-3xl font-black text-white italic tracking-tighter">Finansal YÃ¶netim</h1><button onClick={() => exportPDF('acc-table', 'portrait', 'Muhasebe_Raporu.pdf')} className="bg-slate-800 hover:bg-slate-700 text-white px-6 py-3.5 rounded-2xl font-black text-xs transition border border-slate-700 shadow-md flex items-center gap-2 uppercase tracking-tighter italic"><i className="lucide-file-text w-4 h-4 text-blue-500"></i> TABLOYU AKTAR</button></div>
                        <div className="mb-6 relative w-full md:w-72 shadow-inner"><i className="lucide-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 w-4 h-4"></i><input type="text" placeholder="HÄ±zlÄ± filtrele..." className="w-full bg-slate-900 border border-slate-800 p-3.5 pl-12 rounded-2xl text-sm font-medium focus:outline-none focus:border-blue-500 transition shadow-inner italic tracking-tighter" value={q} onChange={e => setQ(e.target.value)} /></div>
                        <div className="glass-card rounded-[2.5rem] overflow-hidden shadow-2xl border border-white/5 shadow-inner" id="acc-table">
                            <div className="overflow-x-auto"><table className="w-full text-left border-collapse min-w-[900px]">
                                <thead><tr className="bg-slate-900/80 text-[10px] uppercase font-black text-slate-500 tracking-[0.2em] border-b border-slate-800 italic"><th className="p-6">Ã–ÄŸrenci AdÄ±</th><th className="p-6 text-center">Ders</th><th className="p-6">Tahakkuk</th><th className="p-6 text-red-500">Gider (+)</th><th className="p-6 text-green-500">Tahsilat (-)</th><th className="p-6 text-blue-500">Bakiye</th><th className="p-6 text-right no-print">Ä°ÅŸlemler</th></tr></thead>
                                <tbody className="divide-y divide-slate-800/50">
                                    {summary.map(row => (
                                        <tr key={row.id} className="hover:bg-blue-600/[0.02] transition-all group">
                                            <td className="p-6 font-black text-slate-200 italic tracking-tighter">{row.name}</td>
                                            <td className="p-6 text-center font-mono text-slate-500 text-xs shadow-inner italic tracking-tighter">{row.count}</td>
                                            <td className="p-6 font-bold font-mono text-xs tabular-nums tracking-tighter italic tracking-tighter">{row.debt.toLocaleString()} â‚º</td>
                                            <td className="p-6 font-bold font-mono text-xs text-red-500 tabular-nums tracking-tighter italic tracking-tighter">+{row.expenses.toLocaleString()} â‚º</td>
                                            <td className="p-6 font-bold font-mono text-xs text-green-500 tabular-nums tracking-tighter italic tracking-tighter">-{row.paid.toLocaleString()} â‚º</td>
                                            <td className={`p-6 font-black font-mono text-sm tabular-nums tracking-tight italic tracking-tighter ${row.balance > 0 ? 'text-red-500' : 'text-green-500'}`}>{row.balance.toLocaleString()} â‚º</td>
                                            <td className="p-6 text-right no-print"><div className="flex justify-end gap-2.5 opacity-40 group-hover:opacity-100 transition-opacity"><button onClick={() => setPayModal({studentId: row.id, type: 'payment'})} className="p-2.5 bg-green-500/10 text-green-500 rounded-xl transition border border-green-500/10 hover:bg-green-600 hover:text-white shadow-sm"><i className="lucide-plus-circle w-5 h-5"></i></button><button onClick={() => setPayModal({studentId: row.id, type: 'expense'})} className="p-2.5 bg-red-500/10 text-red-500 rounded-xl transition border border-red-500/10 hover:bg-red-600 hover:text-white shadow-sm"><i className="lucide-minus-circle w-5 h-5"></i></button><button onClick={() => setHistory(row.id)} className="p-2.5 bg-slate-800 text-slate-400 rounded-xl transition border border-slate-700 shadow-sm"><i className="lucide-history w-5 h-5"></i></button></div></td>
                                        </tr>
                                    ))}
                                </tbody>
                                <tfoot className="bg-slate-900 font-black border-t-2 border-slate-800 text-slate-300 italic tracking-tighter uppercase italic text-[10px]"><tr><td className="p-6">TOPLAM</td><td className="p-6 text-center font-mono">{totals.count}</td><td className="p-6 font-mono text-xs italic tracking-tighter">{totals.debt.toLocaleString()} â‚º</td><td className="p-6 font-mono text-xs italic tracking-tighter text-red-500">+{totals.expenses.toLocaleString()} â‚º</td><td className="p-6 font-mono text-xs italic tracking-tighter text-green-500">-{totals.paid.toLocaleString()} â‚º</td><td className="p-6 font-mono italic tracking-tighter">{totals.balance.toLocaleString()} â‚º</td><td className="p-6 no-print"></td></tr></tfoot>
                            </table></div>
                        </div>
                        {payModal && (<TransactionModal type={payModal.type} student={students.find(s => s.id === payModal.studentId)} onClose={() => setPayModal(null)} onSave={(d) => { handleUpdate('transactions', [...transactions, { ...d, id: Date.now().toString(), studentId: payModal.studentId, timestamp: new Date().toLocaleString() }]); setPayModal(null); }} />)}
                        {history && (
                            <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-950/90 backdrop-blur-md">
                                <div className="bg-slate-900 w-full max-w-2xl rounded-3xl p-8 border border-slate-800 shadow-2xl flex flex-col max-h-[80vh]">
                                    <div className="flex justify-between items-center mb-6"><div><h2 className="text-xl font-black italic tracking-tighter">{students.find(s => s.id === history)?.name}</h2><p className="text-[10px] uppercase font-bold text-slate-500 italic tracking-tighter">Ä°ÅŸlem GeÃ§miÅŸi</p></div><button onClick={() => setHistory(null)} className="p-2 hover:bg-slate-800 rounded-xl transition"><i className="lucide-x w-5 h-5"></i></button></div>
                                    <div className="flex-1 overflow-y-auto custom-scrollbar space-y-3">
                                        {transactions.filter(t => t.studentId === history).slice().reverse().map(t => (
                                            <div key={t.id} className={`p-4 rounded-2xl border flex justify-between items-center ${t.type === 'payment' ? 'bg-green-600/5 border-green-500/20' : 'bg-red-600/5 border-red-500/20'}`}>
                                                <div><p className="font-bold text-sm italic tracking-tighter">{t.description || 'AÃ§Ä±klama yok'}</p><p className="text-[10px] text-slate-500 font-bold uppercase italic tracking-tighter">{t.timestamp}</p></div>
                                                <div className={`font-black italic tracking-tighter ${t.type === 'payment' ? 'text-green-500' : 'text-red-500'}`}>{t.type === 'payment' ? '-' : '+'}{t.amount.toLocaleString()} â‚º</div>
                                                <button onClick={() => handleUpdate('transactions', transactions.filter(tr => tr.id !== t.id))} className="text-slate-700 hover:text-red-500 transition ml-4"><i className="lucide-trash-2 w-4 h-4"></i></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const TransactionModal = ({ type, student, onClose, onSave }) => {
                const [form, setForm] = useState({ amount: '', description: '' });
                return (
                    <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-950/90 backdrop-blur-sm shadow-2xl">
                        <div className="bg-slate-900 w-full max-w-sm rounded-3xl p-8 shadow-2xl border border-slate-800 animate-in zoom-in-95 duration-200">
                            <h2 className={`text-xl font-black mb-6 uppercase tracking-tight italic ${type === 'payment' ? 'text-green-400' : 'text-red-400'}`}>{type === 'payment' ? 'TAHSÄ°LAT' : 'GÄ°DER'}</h2>
                            <div className="space-y-5">
                                <div className="p-4 bg-slate-950/40 rounded-2xl border border-slate-800 italic tracking-tighter"><p className="text-[10px] font-black text-slate-600 uppercase mb-1">Cari</p><p className="font-black text-slate-200 italic tracking-tighter">{student?.name}</p></div>
                                <input type="number" placeholder="Tutar â‚º" className="w-full bg-slate-800 p-4 rounded-2xl font-black text-lg outline-none italic tracking-tighter shadow-inner" value={form.amount} onChange={e => setForm({...form, amount: e.target.value})} />
                                <input type="text" placeholder="AÃ§Ä±klama" className="w-full bg-slate-800 p-4 rounded-2xl font-medium text-sm outline-none italic tracking-tighter shadow-inner" value={form.description} onChange={e => setForm({...form, description: e.target.value})} />
                                <div className="flex gap-3"><button onClick={onClose} className="flex-1 py-4 bg-slate-800 text-slate-400 rounded-2xl font-black uppercase tracking-widest text-[10px] shadow-sm italic">Ä°PTAL</button><button onClick={() => onSave({...form, amount: parseFloat(form.amount) || 0, type})} className={`flex-1 py-4 rounded-2xl font-black text-[10px] text-white uppercase transition shadow-lg italic tracking-tighter ${type === 'payment' ? 'bg-green-600 shadow-green-600/20' : 'bg-red-600 shadow-red-600/20'}`}>KAYDET</button></div>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="flex flex-col md:flex-row h-screen bg-[#020617] overflow-hidden italic tracking-tighter">
                    <Sidebar />
                    <main className="flex-1 overflow-hidden">
                        <div className="h-full flex flex-col italic tracking-tighter">
                            {activeTab === 'calendar' && <CalendarTab />}
                            {activeTab === 'students' && <StudentsTab />}
                            {activeTab === 'statistics' && <StatisticsTab />}
                            {activeTab === 'accounting' && <AccountingTab />}
                        </div>
                    </main>
                    {loading && (
                        <div className="fixed inset-0 bg-slate-950/80 backdrop-blur-sm flex flex-col items-center justify-center z-[200]"><div className="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mb-4 shadow-[0_0_25px_rgba(37,99,235,0.4)]"></div><p className="font-black text-blue-500 animate-pulse uppercase tracking-widest text-[10px] italic tracking-widest uppercase">EÅŸitleme SaÄŸlanÄ±yor...</p></div>
                    )}
                </div>
            );
        };

        function exportStudentProfile(student) { 
            const d = document.createElement('div'); d.className = 'p-10 text-slate-900 bg-white';
            d.innerHTML = `<h1 style="font-size: 32px; font-weight: 900;">${student.name}</h1><p>${student.grade}. SÄ±nÄ±f</p><p>Ãœcret: ${student.unitPrice} â‚º</p>`;
            html2pdf().set({ margin: 10, filename: `${student.name}_CV.pdf`, jsPDF: { format: 'a4' } }).from(d).save();
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
